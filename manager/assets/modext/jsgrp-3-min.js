MODx.window.DuplicateResource=function(config){config=config||{},this.ident=config.ident||"dupres"+Ext.id(),Ext.applyIf(config,{title:_("duplication_options"),id:this.ident,width:500}),MODx.window.DuplicateResource.superclass.constructor.call(this,config)},Ext.extend(MODx.window.DuplicateResource,MODx.Window,{_loadForm:function(){if(this.checkIfLoaded(this.config.record))return this.fp.getForm().baseParams={action:"resource/updateduplicate",prefixDuplicate:!0,id:this.config.resource},!1;var items=[];items.push({xtype:"textfield",id:"modx-"+this.ident+"-name",fieldLabel:_("resource_name_new"),name:"name",anchor:"100%",value:""}),this.config.hasChildren&&items.push({xtype:"xcheckbox",boxLabel:_("duplicate_children"),hideLabel:!0,name:"duplicate_children",id:"modx-"+this.ident+"-duplicate-children",checked:!0,listeners:{check:{fn:function(cb,checked){checked?this.fp.getForm().findField("modx-"+this.ident+"-name").disable():this.fp.getForm().findField("modx-"+this.ident+"-name").enable()},scope:this}}});var pov=MODx.config.default_duplicate_publish_option||"preserve";items.push({xtype:"fieldset",title:_("publishing_options"),items:[{xtype:"radiogroup",columns:1,value:pov,items:[{boxLabel:_("po_make_all_unpub"),name:"published_mode",inputValue:"unpublish"},{boxLabel:_("po_make_all_pub"),name:"published_mode",inputValue:"publish"},{boxLabel:_("po_preserve"),name:"published_mode",inputValue:"preserve"}]}]}),this.fp=this.createForm({url:this.config.url||MODx.config.connector_url,baseParams:this.config.baseParams||{action:"resource/duplicate",id:this.config.resource,prefixDuplicate:!0},labelWidth:125,defaultType:"textfield",autoHeight:!0,items:items}),this.renderForm()}}),Ext.reg("modx-window-resource-duplicate",MODx.window.DuplicateResource),MODx.window.CreateCategory=function(config){config=config||{},this.ident=config.ident||"ccat"+Ext.id(),Ext.applyIf(config,{title:_("new_category"),id:this.ident,height:150,width:350,url:MODx.config.connector_url,action:"element/category/create",fields:[{fieldLabel:_("name"),name:"category",id:"modx-"+this.ident+"-category",xtype:"textfield",anchor:"100%"},{fieldLabel:_("parent"),name:"parent",hiddenName:"parent",id:"modx-"+this.ident+"-parent",xtype:"modx-combo-category",anchor:"100%"}]}),MODx.window.CreateCategory.superclass.constructor.call(this,config)},Ext.extend(MODx.window.CreateCategory,MODx.Window),Ext.reg("modx-window-category-create",MODx.window.CreateCategory),MODx.window.CreateNamespace=function(config){config=config||{};config.record;this.ident=config.ident||"cns"+Ext.id(),Ext.applyIf(config,{title:_("namespace_create"),id:this.ident,width:600,url:MODx.config.connector_url,action:"workspace/namespace/create",fields:[{xtype:"textfield",fieldLabel:_("name"),description:MODx.expandHelp?"":_("namespace_name_desc"),name:"name",id:"modx-"+this.ident+"-name",anchor:"100%",maxLength:100},{xtype:MODx.expandHelp?"label":"hidden",forId:"modx-"+this.ident+"-name",html:_("namespace_name_desc"),cls:"desc-under"},{xtype:"textfield",fieldLabel:_("namespace_path"),description:MODx.expandHelp?"":_("namespace_path_desc"),name:"path",id:"modx-"+this.ident+"-path",anchor:"100%"},{xtype:MODx.expandHelp?"label":"hidden",forId:"modx-"+this.ident+"-path",html:_("namespace_path_desc"),cls:"desc-under"},{xtype:"textfield",fieldLabel:_("namespace_assets_path"),description:MODx.expandHelp?"":_("namespace_assets_path_desc"),name:"assets_path",id:"modx-"+this.ident+"-assets-path",anchor:"100%"},{xtype:MODx.expandHelp?"label":"hidden",forId:"modx-"+this.ident+"-assets-path",html:_("namespace_assets_path_desc"),cls:"desc-under"}]}),MODx.window.CreateNamespace.superclass.constructor.call(this,config)},Ext.extend(MODx.window.CreateNamespace,MODx.Window),Ext.reg("modx-window-namespace-create",MODx.window.CreateNamespace),MODx.window.QuickCreateChunk=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_create_chunk"),width:600,autoHeight:!0,layout:"anchor",url:MODx.config.connector_url,action:"element/chunk/create",fields:[{xtype:"hidden",name:"id"},{xtype:"textfield",name:"name",fieldLabel:_("name"),anchor:"100%"},{xtype:"modx-combo-category",name:"category",fieldLabel:_("category"),anchor:"100%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),anchor:"100%"},{xtype:"textarea",name:"snippet",fieldLabel:_("code"),anchor:"100%",grow:!0,growMax:216},{xtype:"xcheckbox",name:"clearCache",hideLabel:!0,boxLabel:_("clear_cache_on_save"),description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreateChunk.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreateChunk,MODx.Window),Ext.reg("modx-window-quick-create-chunk",MODx.window.QuickCreateChunk),MODx.window.QuickUpdateChunk=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_update_chunk"),action:"element/chunk/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),scope:this,handler:this.submit}]}),MODx.window.QuickUpdateChunk.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdateChunk,MODx.window.QuickCreateChunk),Ext.reg("modx-window-quick-update-chunk",MODx.window.QuickUpdateChunk),MODx.window.QuickCreateTemplate=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_create_template"),width:600,autoHeight:!0,layout:"anchor",url:MODx.config.connector_url,action:"element/template/create",fields:[{xtype:"hidden",name:"id"},{xtype:"textfield",name:"templatename",fieldLabel:_("name"),anchor:"100%"},{xtype:"modx-combo-category",name:"category",fieldLabel:_("category"),anchor:"100%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),anchor:"100%"},{xtype:"textarea",name:"content",fieldLabel:_("code"),anchor:"100%",grow:!0,growMax:216},{xtype:"xcheckbox",name:"clearCache",hideLabel:!0,boxLabel:_("clear_cache_on_save"),description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreateTemplate.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreateTemplate,MODx.Window),Ext.reg("modx-window-quick-create-template",MODx.window.QuickCreateTemplate),MODx.window.QuickUpdateTemplate=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_update_template"),action:"element/template/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),scope:this,handler:this.submit}]}),MODx.window.QuickUpdateTemplate.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdateTemplate,MODx.window.QuickCreateTemplate),Ext.reg("modx-window-quick-update-template",MODx.window.QuickUpdateTemplate),MODx.window.QuickCreateSnippet=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_create_snippet"),width:600,autoHeight:!0,layout:"anchor",url:MODx.config.connector_url,action:"element/snippet/create",fields:[{xtype:"hidden",name:"id"},{xtype:"textfield",name:"name",fieldLabel:_("name"),anchor:"100%"},{xtype:"modx-combo-category",name:"category",fieldLabel:_("category"),anchor:"100%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),anchor:"100%"},{xtype:"textarea",name:"snippet",fieldLabel:_("code"),anchor:"100%",grow:!0,growMax:216},{xtype:"xcheckbox",name:"clearCache",hideLabel:!0,boxLabel:_("clear_cache_on_save"),description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreateSnippet.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreateSnippet,MODx.Window),Ext.reg("modx-window-quick-create-snippet",MODx.window.QuickCreateSnippet),MODx.window.QuickUpdateSnippet=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_update_snippet"),action:"element/snippet/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),scope:this,handler:this.submit}]}),MODx.window.QuickUpdateSnippet.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdateSnippet,MODx.window.QuickCreateSnippet),Ext.reg("modx-window-quick-update-snippet",MODx.window.QuickUpdateSnippet),MODx.window.QuickCreatePlugin=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_create_plugin"),width:600,autoHeight:!0,layout:"anchor",url:MODx.config.connector_url,action:"element/plugin/create",fields:[{xtype:"hidden",name:"id"},{xtype:"textfield",name:"name",fieldLabel:_("name"),anchor:"100%"},{xtype:"modx-combo-category",name:"category",fieldLabel:_("category"),anchor:"100%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),anchor:"100%",rows:2},{xtype:"textarea",name:"plugincode",fieldLabel:_("code"),anchor:"100%",grow:!0,growMax:216},{xtype:"xcheckbox",name:"disabled",boxLabel:_("disabled"),hideLabel:!0,inputValue:1,checked:!1},{xtype:"xcheckbox",name:"clearCache",boxLabel:_("clear_cache_on_save"),hideLabel:!0,description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreatePlugin.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreatePlugin,MODx.Window),Ext.reg("modx-window-quick-create-plugin",MODx.window.QuickCreatePlugin),MODx.window.QuickUpdatePlugin=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_update_plugin"),action:"element/plugin/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),scope:this,handler:this.submit}]}),MODx.window.QuickUpdatePlugin.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdatePlugin,MODx.window.QuickCreatePlugin),Ext.reg("modx-window-quick-update-plugin",MODx.window.QuickUpdatePlugin),MODx.window.QuickCreateTV=function(config){config=config||{},this.ident=config.ident||"qtv"+Ext.id(),Ext.applyIf(config,{title:_("quick_create_tv"),width:700,url:MODx.config.connector_url,action:"element/tv/create",fields:[{xtype:"hidden",name:"id"},{layout:"column",border:!1,items:[{columnWidth:.6,layout:"form",items:[{xtype:"textfield",name:"name",fieldLabel:_("name"),anchor:"100%"},{xtype:"textfield",name:"caption",id:"modx-"+this.ident+"-caption",fieldLabel:_("caption"),anchor:"100%"},{xtype:"label",forId:"modx-"+this.ident+"-caption",html:_("caption_desc"),cls:"desc-under"},{xtype:"modx-combo-category",name:"category",fieldLabel:_("category"),anchor:"100%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),anchor:"100%"}]},{columnWidth:.4,border:!1,layout:"form",items:[{xtype:"modx-combo-tv-input-type",fieldLabel:_("tv_type"),name:"type",anchor:"100%"},{xtype:"textfield",fieldLabel:_("tv_elements"),name:"els",id:"modx-"+this.ident+"-elements",anchor:"100%"},{xtype:"label",forId:"modx-"+this.ident+"-elements",html:_("tv_elements_desc"),cls:"desc-under"},{xtype:"textarea",fieldLabel:_("tv_default"),name:"default_text",id:"modx-"+this.ident+"-default-text",anchor:"100%",grow:!0,growMax:Ext.getBody().getViewSize().height<=768?300:380},{xtype:"label",forId:"modx-"+this.ident+"-default-text",html:_("tv_default_desc"),cls:"desc-under"}]}]},{xtype:"xcheckbox",name:"clearCache",hideLabel:!0,boxLabel:_("clear_cache_on_save"),description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreateTV.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreateTV,MODx.Window),Ext.reg("modx-window-quick-create-tv",MODx.window.QuickCreateTV),MODx.window.QuickUpdateTV=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_update_tv"),action:"element/tv/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),scope:this,handler:this.submit}]}),MODx.window.QuickUpdateTV.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdateTV,MODx.window.QuickCreateTV),Ext.reg("modx-window-quick-update-tv",MODx.window.QuickUpdateTV),MODx.window.DuplicateContext=function(config){config=config||{},this.ident=config.ident||"dupctx"+Ext.id(),Ext.Ajax.timeout=0,Ext.applyIf(config,{title:_("context_duplicate"),id:this.ident,url:MODx.config.connector_url,action:"context/duplicate",width:400,fields:[{xtype:"statictextfield",id:"modx-"+this.ident+"-key",fieldLabel:_("old_key"),name:"key",anchor:"100%",submitValue:!0},{xtype:"textfield",id:"modx-"+this.ident+"-newkey",fieldLabel:_("new_key"),name:"newkey",anchor:"100%",value:""},{xtype:"checkbox",id:"modx-"+this.ident+"-preservealias",fieldLabel:_("preserve_alias"),name:"preserve_alias",anchor:"100%",checked:!0},{xtype:"checkbox",id:"modx-"+this.ident+"-preservemenuindex",fieldLabel:_("preserve_menuindex"),name:"preserve_menuindex",anchor:"100%",checked:!0}]}),MODx.window.DuplicateContext.superclass.constructor.call(this,config)},Ext.extend(MODx.window.DuplicateContext,MODx.Window),Ext.reg("modx-window-context-duplicate",MODx.window.DuplicateContext),MODx.window.Login=function(config){config=config||{},this.ident=config.ident||"dupctx"+Ext.id(),Ext.Ajax.timeout=0,Ext.applyIf(config,{title:_("login"),id:this.ident,url:MODx.config.connector_url,action:"security/login",width:400,fields:[{html:"<p>"+_("session_logging_out")+"</p>",bodyCssClass:"panel-desc"},{xtype:"textfield",id:"modx-"+this.ident+"-username",fieldLabel:_("username"),name:"username",anchor:"100%"},{xtype:"textfield",inputType:"password",id:"modx-"+this.ident+"-password",fieldLabel:_("password"),name:"password",anchor:"100%"},{xtype:"hidden",name:"rememberme",value:1}],buttons:[{text:_("logout"),scope:this,handler:function(){location.href="?logout=1"}},{text:_("login"),scope:this,handler:this.submit}]}),MODx.window.Login.superclass.constructor.call(this,config),this.on("success",this.onLogin,this)},Ext.extend(MODx.window.Login,MODx.Window,{onLogin:function(o){var r=o.a.result;r.object&&r.object.token&&(Ext.Ajax.defaultHeaders={modAuth:r.object.token},Ext.Ajax.extraParams={HTTP_MODAUTH:r.object.token},MODx.siteId=r.object.token,MODx.msg.status({message:_("session_extended")}))}}),Ext.reg("modx-window-login",MODx.window.Login),MODx.tree.AsyncTreeNode=function(config){config=config||{},config.id=config.id||Ext.id(),Ext.applyIf(config,{}),MODx.tree.AsyncTreeNode.superclass.constructor.call(this,config)},Ext.extend(MODx.tree.AsyncTreeNode,Ext.tree.AsyncTreeNode,{}),Ext.reg("modx-tree-asynctreenode",MODx.tree.AsyncTreeNode),MODx.tree.Resource=function(config){config=config||{},Ext.applyIf(config,{url:MODx.config.connector_url,action:"resource/getNodes",title:"",rootVisible:!1,expandFirst:!0,enableDD:"0"!=MODx.config.enable_dragdrop?!0:!1,ddGroup:"modx-treedrop-dd",remoteToolbar:!0,remoteToolbarAction:"resource/gettoolbar",sortAction:"resource/sort",sortBy:this.getDefaultSortBy(config),tbarCfg:{id:config.id?config.id+"-tbar":"modx-tree-resource-tbar"},baseParams:{sortBy:this.getDefaultSortBy(config),currentResource:MODx.request.id||0,currentAction:MODx.request.a||0}}),MODx.tree.Resource.superclass.constructor.call(this,config),this.on("render",function(){var el=Ext.get("modx-resource-tree");el.createChild({tag:"div",id:"modx-resource-tree_tb"}),el.createChild({tag:"div",id:"modx-resource-tree_filter"})},this),this.addEvents("loadCreateMenus"),this.on("afterSort",this._handleAfterDrop,this)},Ext.extend(MODx.tree.Resource,MODx.tree.Tree,{forms:{},windows:{},stores:{},_initExpand:function(){var treeState=Ext.state.Manager.get(this.treestate_id);if((Ext.isString(treeState)||Ext.isEmpty(treeState))&&this.root){this.root&&this.root.expand();var wn=this.getNodeById("web_0");wn&&this.config.expandFirst&&(wn.select(),wn.expand())}else for(var i=0;i<treeState.length;i++)this.expandPath(treeState[i])},_showContextMenu:function(n,e){if(this.cm.activeNode=n,this.cm.removeAll(),n.attributes.menu&&n.attributes.menu.items)this.addContextMenuItem(n.attributes.menu.items);else{var m=[];switch(n.attributes.type){case"modResource":case"modDocument":m=this._getModResourceMenu(n);break;case"modContext":m=this._getModContextMenu(n)}this.addContextMenuItem(m)}this.cm.showAt(e.xy),e.stopEvent()},duplicateResource:function(item,e){var node=this.cm.activeNode,id=node.id.split("_");id=id[1];var r={resource:id,is_folder:node.getUI().hasClass("folder")},w=MODx.load({xtype:"modx-window-resource-duplicate",resource:id,hasChildren:node.attributes.hasChildren,listeners:{success:{fn:function(){this.refreshNode(node.id)},scope:this}}});w.config.hasChildren=node.attributes.hasChildren,w.setValues(r),w.show(e.target)},duplicateContext:function(itm,e){var node=this.cm.activeNode,key=node.attributes.pk,r={key:key,newkey:""},w=MODx.load({xtype:"modx-window-context-duplicate",record:r,listeners:{success:{fn:function(){this.refresh()},scope:this}}});w.show(e.target)},removeContext:function(){var node=this.cm.activeNode,key=node.attributes.pk;MODx.msg.confirm({title:_("context_remove"),text:_("context_remove_confirm"),url:MODx.config.connector_url,params:{action:"context/remove",key:key},listeners:{success:{fn:function(){this.refresh()},scope:this}}})},preview:function(){window.open(this.cm.activeNode.attributes.preview_url)},deleteDocument:function(){var node=this.cm.activeNode,id=node.id.split("_");id=id[1],MODx.msg.confirm({title:_("resource_delete"),text:_("resource_delete_confirm"),url:MODx.config.connector_url,params:{action:"resource/delete",id:id},listeners:{success:{fn:function(data){var trashButton=this.getTopToolbar().findById("emptifier");trashButton&&(0==data.object.deletedCount?trashButton.disable():trashButton.enable(),trashButton.setTooltip(_("empty_recycle_bin")+" ("+data.object.deletedCount+")"));var n=this.cm.activeNode,ui=n.getUI();ui.addClass("deleted"),n.cascade(function(nd){nd.getUI().addClass("deleted")},this),Ext.get(ui.getEl()).frame()},scope:this}}})},undeleteDocument:function(){var node=this.cm.activeNode,id=node.id.split("_");id=id[1],MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"resource/undelete",id:id},listeners:{success:{fn:function(data){var trashButton=this.getTopToolbar().findById("emptifier");trashButton&&(0==data.object.deletedCount?trashButton.disable():trashButton.enable(),trashButton.setTooltip(_("empty_recycle_bin")+" ("+data.object.deletedCount+")"));var n=this.cm.activeNode,ui=n.getUI();ui.removeClass("deleted"),n.cascade(function(nd){nd.getUI().removeClass("deleted")},this),Ext.get(ui.getEl()).frame()},scope:this}}})},publishDocument:function(){var node=this.cm.activeNode,id=node.id.split("_");id=id[1],MODx.msg.confirm({title:_("resource_publish"),text:_("resource_publish_confirm"),url:MODx.config.connector_url,params:{action:"resource/publish",id:id},listeners:{success:{fn:function(){var ui=this.cm.activeNode.getUI();ui.removeClass("unpublished"),Ext.get(ui.getEl()).frame()},scope:this}}})},unpublishDocument:function(){var node=this.cm.activeNode,id=node.id.split("_");id=id[1],MODx.msg.confirm({title:_("resource_unpublish"),text:_("resource_unpublish_confirm"),url:MODx.config.connector_url,params:{action:"resource/unpublish",id:id},listeners:{success:{fn:function(){var ui=this.cm.activeNode.getUI();ui.addClass("unpublished"),Ext.get(ui.getEl()).frame()},scope:this}}})},emptyRecycleBin:function(){MODx.msg.confirm({title:_("empty_recycle_bin"),text:_("empty_recycle_bin_confirm"),url:MODx.config.connector_url,params:{action:"resource/emptyRecycleBin"},listeners:{success:{fn:function(){Ext.select("div.deleted",this.getRootNode()).remove(),MODx.msg.status({title:_("success"),message:_("empty_recycle_bin_emptied")})},scope:this}}})},getDefaultSortBy:function(config){var v="menuindex";if(Ext.isEmpty(config)||Ext.isEmpty(config.sortBy)){var d=Ext.state.Manager.get(this.treestate_id+"-sort-default");d!=MODx.config.tree_default_sort?(v=MODx.config.tree_default_sort,Ext.state.Manager.set(this.treestate_id+"-sort-default",v),Ext.state.Manager.set(this.treestate_id+"-sort",v)):v=Ext.state.Manager.get(this.treestate_id+"-sort")||MODx.config.tree_default_sort}else v=config.sortBy;return v},filterSort:function(itm){this.getLoader().baseParams={action:this.config.action,sortBy:itm.sortBy,sortDir:itm.sortDir,node:this.cm.activeNode.ide},this.refreshActiveNode()},hideFilter:function(){this.filterBar.destroy(),this._filterVisible=!1},_handleAfterDrop:function(o){var targetNode=o.event.target,dropNode=o.event.dropNode;if("append"==o.event.point&&targetNode){var ui=targetNode.getUI();ui.addClass("haschildren"),ui.removeClass("icon-resource")}if(MODx.request.a==MODx.action["resource/update"]&&dropNode.attributes.pk==MODx.request.id){var parentFieldCmb=Ext.getCmp("modx-resource-parent"),parentFieldHidden=Ext.getCmp("modx-resource-parent-hidden");parentFieldCmb&&parentFieldHidden&&(parentFieldHidden.setValue(dropNode.parentNode.attributes.pk),parentFieldCmb.setValue(dropNode.parentNode.attributes.text.replace(/(<([^>]+)>)/gi,"")))}},_handleDrop:function(e){var dropNode=e.dropNode,targetParent=e.target;if(null!==targetParent.findChild("id",dropNode.attributes.id))return!1;if("modContext"==dropNode.attributes.type&&(targetParent.getDepth()>1||targetParent.attributes.id==targetParent.attributes.pk+"_0"&&"append"==e.point))return!1;if("modContext"!==dropNode.attributes.type&&targetParent.getDepth()<=1&&"append"!==e.point)return!1;if(void 0==MODx.config.resource_classes_drop[targetParent.attributes.classKey]){if(targetParent.attributes.hide_children_in_tree)return!1}else if(0==MODx.config.resource_classes_drop[targetParent.attributes.classKey])return!1;return"root"!=dropNode.attributes.text&&""!==dropNode.attributes.text&&"root"!=targetParent.attributes.text&&""!==targetParent.attributes.text},getContextSettingForNode:function(node,ctx,setting,dv){var val=dv||null;if("modContext"!=node.attributes.type){var t=node.getOwnerTree(),rn=t.getRootNode(),cn=rn.findChild("ctx",ctx,!1);cn&&(val=cn.attributes.settings[setting])}else val=node.attributes.settings[setting];return val},quickCreate:function(itm,e,cls,ctx,p){cls=cls||"modDocument";var r={class_key:cls,context_key:ctx||"web",parent:p||0,template:parseInt(this.getContextSettingForNode(this.cm.activeNode,ctx,"default_template",MODx.config.default_template)),richtext:parseInt(this.getContextSettingForNode(this.cm.activeNode,ctx,"richtext_default",MODx.config.richtext_default)),hidemenu:parseInt(this.getContextSettingForNode(this.cm.activeNode,ctx,"hidemenu_default",MODx.config.hidemenu_default)),searchable:parseInt(this.getContextSettingForNode(this.cm.activeNode,ctx,"search_default",MODx.config.search_default)),cacheable:parseInt(this.getContextSettingForNode(this.cm.activeNode,ctx,"cache_default",MODx.config.cache_default)),published:parseInt(this.getContextSettingForNode(this.cm.activeNode,ctx,"publish_default",MODx.config.publish_default)),content_type:parseInt(this.getContextSettingForNode(this.cm.activeNode,ctx,"default_content_type",MODx.config.default_content_type))};if("modContext"!=this.cm.activeNode.attributes.type){var t=this.cm.activeNode.getOwnerTree(),rn=t.getRootNode(),cn=rn.findChild("ctx",ctx,!1);cn&&(r.template=cn.attributes.settings.default_template)}else r.template=this.cm.activeNode.attributes.settings.default_template;var w=MODx.load({xtype:"modx-window-quick-create-modResource",record:r,listeners:{success:{fn:function(){var node=this.getNodeById(this.cm.activeNode.id);if(node){var n=node.parentNode?node.parentNode:node;this.getLoader().load(n,function(){n.expand()},this)}},scope:this},hide:{fn:function(){this.destroy()}},show:{fn:function(){this.center()}}}});w.setValues(r),w.show(e.target,function(){Ext.isSafari?w.setPosition(null,30):w.center()},this)},quickUpdate:function(itm,e,cls){MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"resource/get",id:this.cm.activeNode.attributes.pk},listeners:{success:{fn:function(r){var pr=r.object;pr.class_key=cls;var w=MODx.load({xtype:"modx-window-quick-update-modResource",record:pr,listeners:{success:{fn:function(){this.refreshNode(this.cm.activeNode.id)},scope:this},hide:{fn:function(){this.destroy()}}}});w.setValues(r.object),w.show(e.target,function(){Ext.isSafari?w.setPosition(null,30):w.center()},this)},scope:this}}})},_getModContextMenu:function(n){var a=n.attributes,ui=n.getUI(),m=[];return m.push({text:"<b>"+a.text+"</b>",handler:function(){return!1},header:!0}),m.push("-"),ui.hasClass("pedit")&&m.push({text:_("edit_context"),handler:function(){var at=this.cm.activeNode.attributes;this.loadAction("a=context/update&key="+at.pk)}}),m.push({text:_("context_refresh"),handler:function(){this.refreshNode(this.cm.activeNode.id,!0)}}),ui.hasClass("pnewdoc")&&(m.push("-"),this._getCreateMenus(m,"0",ui)),ui.hasClass("pnew")&&m.push({text:_("context_duplicate"),handler:this.duplicateContext}),ui.hasClass("pdelete")&&(m.push("-"),m.push({text:_("context_remove"),handler:this.removeContext})),ui.hasClass("x-tree-node-leaf")||(m.push("-"),m.push(this._getSortMenu())),m},overviewResource:function(){this.loadAction("a=resource/data")},quickUpdateResource:function(itm,e){Ext.getCmp("modx-resource-tree").quickUpdate(itm,e,itm.classKey)},editResource:function(){this.loadAction("a=resource/update")},_getModResourceMenu:function(n){var a=n.attributes,ui=n.getUI(),m=[];return m.push({text:"<b>"+a.text+"</b>",handler:function(){return!1},header:!0}),m.push("-"),ui.hasClass("pview")&&m.push({text:_("resource_overview"),handler:this.overviewResource}),ui.hasClass("pedit")&&m.push({text:_("resource_edit"),handler:this.editResource}),ui.hasClass("pqupdate")&&m.push({text:_("quick_update_resource"),classKey:a.classKey,handler:this.quickUpdateResource}),ui.hasClass("pduplicate")&&m.push({text:_("resource_duplicate"),handler:this.duplicateResource}),m.push({text:_("resource_refresh"),handler:this.refreshResource,scope:this}),ui.hasClass("pnew")&&(m.push("-"),this._getCreateMenus(m,null,ui)),ui.hasClass("psave")&&(m.push("-"),ui.hasClass("ppublish")&&ui.hasClass("unpublished")?m.push({text:_("resource_publish"),handler:this.publishDocument}):ui.hasClass("punpublish")&&m.push({text:_("resource_unpublish"),handler:this.unpublishDocument}),ui.hasClass("pundelete")&&ui.hasClass("deleted")?m.push({text:_("resource_undelete"),handler:this.undeleteDocument}):ui.hasClass("pdelete")&&!ui.hasClass("deleted")&&m.push({text:_("resource_delete"),handler:this.deleteDocument})),ui.hasClass("x-tree-node-leaf")||(m.push("-"),m.push(this._getSortMenu())),ui.hasClass("pview")&&""!=a.preview_url&&(m.push("-"),m.push({text:_("resource_view"),handler:this.preview})),m},refreshResource:function(){this.refreshNode(this.cm.activeNode.id)},createResourceHere:function(itm){var at=this.cm.activeNode.attributes,p=itm.usePk?itm.usePk:at.pk;Ext.getCmp("modx-resource-tree").loadAction("a=resource/create&class_key="+itm.classKey+"&parent="+p+(at.ctx?"&context_key="+at.ctx:""))},createResource:function(itm,e){var at=this.cm.activeNode.attributes,p=itm.usePk?itm.usePk:at.pk;Ext.getCmp("modx-resource-tree").quickCreate(itm,e,itm.classKey,at.ctx,p)},_getCreateMenus:function(m,pk,ui){var types=MODx.config.resource_classes,o=this.fireEvent("loadCreateMenus",types);Ext.isObject(o)&&Ext.apply(types,o);var coreTypes=["modDocument","modWebLink","modSymLink","modStaticResource"],ct=[],qct=[];for(var k in types)(-1==coreTypes.indexOf(k)||ui.hasClass("pnew_"+k))&&(ct.push({text:types[k].text_create_here,classKey:k,usePk:pk?pk:!1,handler:this.createResourceHere,scope:this}),ui&&ui.hasClass("pqcreate")&&qct.push({text:types[k].text_create,classKey:k,handler:this.createResource,scope:this}));return m.push({text:_("create"),handler:function(){return!1},menu:{items:ct}}),ui&&ui.hasClass("pqcreate")&&m.push({text:_("quick_create"),handler:function(){return!1},menu:{items:qct}}),m},_getSortMenu:function(){return[{text:_("sort_by"),handler:function(){return!1},menu:{items:[{text:_("tree_order"),sortBy:"menuindex",sortDir:"ASC",handler:this.filterSort,scope:this},{text:_("recently_updated"),sortBy:"editedon",sortDir:"ASC",handler:this.filterSort,scope:this},{text:_("newest"),sortBy:"createdon",sortDir:"DESC",handler:this.filterSort,scope:this},{text:_("oldest"),sortBy:"createdon",sortDir:"ASC",handler:this.filterSort,scope:this},{text:_("publish_date"),sortBy:"pub_date",sortDir:"ASC",handler:this.filterSort,scope:this},{text:_("unpublish_date"),sortBy:"unpub_date",sortDir:"ASC",handler:this.filterSort,scope:this},{text:_("publishedon"),sortBy:"publishedon",sortDir:"ASC",handler:this.filterSort,scope:this},{text:_("title"),sortBy:"pagetitle",sortDir:"ASC",handler:this.filterSort,scope:this},{text:_("alias"),sortBy:"alias",sortDir:"ASC",handler:this.filterSort,scope:this}]}}]},handleCreateClick:function(node){this.cm.activeNode=node;var itm={usePk:"0",classKey:"modDocument"};this.createResourceHere(itm)}}),Ext.reg("modx-tree-resource",MODx.tree.Resource),MODx.window.QuickCreateResource=function(config){config=config||{},this.ident=config.ident||"qcr"+Ext.id(),Ext.applyIf(config,{title:_("quick_create_resource"),id:this.ident,width:700,height:-1==["modSymLink","modWebLink","modStaticResource"].indexOf(config.record.class_key)?640:498,autoHeight:!1,layout:"anchor",url:MODx.config.connector_url,action:"resource/create",shadow:!1,fields:[{xtype:"modx-tabs",bodyStyle:{background:"transparent"},border:!0,deferredRender:!1,autoHeight:!1,autoScroll:!1,anchor:"100% 100%",items:[{title:_("resource"),layout:"form",cls:"modx-panel",bodyStyle:{background:"transparent",padding:"10px"},autoHeight:!1,anchor:"100% 100%",labelWidth:100,items:[{xtype:"hidden",name:"id"},{layout:"column",border:!1,items:[{columnWidth:.6,border:!1,layout:"form",items:[{xtype:"textfield",name:"pagetitle",id:"modx-"+this.ident+"-pagetitle",fieldLabel:_("pagetitle"),anchor:"100%"},{xtype:"textfield",name:"longtitle",id:"modx-"+this.ident+"-longtitle",fieldLabel:_("long_title"),anchor:"100%"},{xtype:"textarea",name:"description",id:"modx-"+this.ident+"-description",fieldLabel:_("description"),anchor:"100%",grow:!1,height:50},{xtype:"textarea",name:"introtext",id:"modx-"+this.ident+"-introtext",fieldLabel:_("introtext"),anchor:"100%",height:50}]},{columnWidth:.4,border:!1,layout:"form",items:[{xtype:"modx-combo-template",name:"template",id:"modx-"+this.ident+"-template",fieldLabel:_("template"),editable:!1,anchor:"100%",baseParams:{action:"element/template/getList",combo:"1",limit:0},value:MODx.config.default_template},{xtype:"textfield",name:"alias",id:"modx-"+this.ident+"-alias",fieldLabel:_("alias"),anchor:"100%"},{xtype:"textfield",name:"menutitle",id:"modx-"+this.ident+"-menutitle",fieldLabel:_("resource_menutitle"),anchor:"100%"},{xtype:"xcheckbox",boxLabel:_("resource_hide_from_menus"),description:_("resource_hide_from_menus_help"),name:"hidemenu",id:"modx-"+this.ident+"-hidemenu",inputValue:1,checked:"1"==MODx.config.hidemenu_default?1:0},{xtype:"xcheckbox",name:"published",id:"modx-"+this.ident+"-published",boxLabel:_("resource_published"),description:_("resource_published_help"),inputValue:1,checked:"1"==MODx.config.publish_default?1:0}]}]},MODx.getQRContentField(this.ident,config.record.class_key)]},{id:"modx-"+this.ident+"-settings",title:_("settings"),layout:"form",cls:"modx-panel",autoHeight:!0,forceLayout:!0,labelWidth:100,defaults:{autoHeight:!0,border:!1},style:"background: transparent;",bodyStyle:{background:"transparent",padding:"10px"},items:MODx.getQRSettings(this.ident,config.record)}]}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreateResource.superclass.constructor.call(this,config)
},Ext.extend(MODx.window.QuickCreateResource,MODx.Window),Ext.reg("modx-window-quick-create-modResource",MODx.window.QuickCreateResource),MODx.window.QuickUpdateResource=function(config){config=config||{},this.ident=config.ident||"qur"+Ext.id(),Ext.applyIf(config,{title:_("quick_update_resource"),id:this.ident,action:"resource/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),scope:this,handler:this.submit}]}),MODx.window.QuickUpdateResource.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdateResource,MODx.window.QuickCreateResource),Ext.reg("modx-window-quick-update-modResource",MODx.window.QuickUpdateResource),MODx.getQRContentField=function(id,cls){id=id||"qur",cls=cls||"modDocument";var o=(Ext.getBody().getViewSize(),{});switch(cls){case"modSymLink":o={xtype:"textfield",fieldLabel:_("symlink"),name:"content",id:"modx-"+id+"-content",anchor:"100%",maxLength:255,allowBlank:!1};break;case"modWebLink":o={xtype:"textfield",fieldLabel:_("weblink"),name:"content",id:"modx-"+id+"-content",anchor:"100%",maxLength:255,value:"http://",allowBlank:!1};break;case"modStaticResource":o={xtype:"modx-combo-browser",browserEl:"modx-browser",prependPath:!1,prependUrl:!1,hideFiles:!0,fieldLabel:_("static_resource"),name:"content",id:"modx-"+id+"-content",anchor:"100%",maxLength:255,value:"",listeners:{select:{fn:function(data){"/"==data.url.substring(0,1)&&Ext.getCmp("modx-"+id+"-content").setValue(data.url.substring(1))},scope:this}}};break;case"modResource":case"modDocument":default:o={xtype:"textarea",name:"content",id:"modx-"+id+"-content",hideLabel:!0,labelSeparator:"",anchor:"100% -274"}}return o},MODx.getQRSettings=function(id,va){return id=id||"qur",[{layout:"column",border:!1,anchor:"100%",defaults:{labelSeparator:"",labelAlign:"top",border:!1,layout:"form"},items:[{columnWidth:.5,items:[{xtype:"hidden",name:"parent",id:"modx-"+id+"-parent",value:va.parent},{xtype:"hidden",name:"context_key",id:"modx-"+id+"-context_key",value:va.context_key},{xtype:"hidden",name:"class_key",id:"modx-"+id+"-class_key",value:va.class_key},{xtype:"hidden",name:"publishedon",id:"modx-"+id+"-publishedon",value:va.publishedon},{xtype:"modx-combo-content-type",fieldLabel:_("resource_content_type"),name:"content_type",hiddenName:"content_type",id:"modx-"+id+"-type",anchor:"100%",value:void 0!=va.content_type?va.content_type:MODx.config.default_content_type||1},{xtype:"modx-combo-content-disposition",fieldLabel:_("resource_contentdispo"),name:"content_dispo",hiddenName:"content_dispo",id:"modx-"+id+"-dispo",anchor:"100%",value:void 0!=va.content_dispo?va.content_dispo:0},{xtype:"modx-combo-class-derivatives",fieldLabel:_("class_key"),description:"<b>[[*class_key]]</b><br />",name:"class_key",hiddenName:"class_key",id:"modx-"+id+"-class-key",anchor:"100%",value:void 0!=va.class_key?va.class_key:"modDocument"}]},{columnWidth:.5,items:[{xtype:"xcheckbox",boxLabel:_("resource_folder"),description:_("resource_folder_help"),name:"isfolder",id:"modx-"+id+"-isfolder",inputValue:1,checked:void 0!=va.isfolder?va.isfolder:!1},{xtype:"xcheckbox",boxLabel:_("resource_richtext"),description:_("resource_richtext_help"),name:"richtext",id:"modx-"+id+"-richtext",inputValue:1,checked:void 0!==va.richtext?va.richtext?1:0:"1"==MODx.config.richtext_default?1:0},{xtype:"xcheckbox",boxLabel:_("resource_searchable"),description:_("resource_searchable_help"),name:"searchable",id:"modx-"+id+"-searchable",inputValue:1,checked:void 0!=va.searchable?va.searchable:"1"==MODx.config.search_default?1:0,listeners:{check:{fn:MODx.handleQUCB}}},{xtype:"xcheckbox",boxLabel:_("resource_cacheable"),description:_("resource_cacheable_help"),name:"cacheable",id:"modx-"+id+"-cacheable",inputValue:1,checked:void 0!=va.cacheable?va.cacheable:"1"==MODx.config.cache_default?1:0},{xtype:"xcheckbox",name:"clearCache",id:"modx-"+id+"-clearcache",boxLabel:_("clear_cache_on_save"),description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}]}]}]},MODx.handleQUCB=function(cb){var h=Ext.getCmp(cb.id+"-hd");cb.checked&&h?(cb.setValue(1),h.setValue(1)):h&&(cb.setValue(0),h.setValue(0))},Ext.override(Ext.tree.AsyncTreeNode,{listeners:{click:{fn:function(){return console.log("Clicked me!",arguments),!1},scope:this}}}),MODx.tree.Element=function(config){config=config||{},Ext.applyIf(config,{rootVisible:!1,enableDD:Ext.isEmpty(MODx.config.enable_dragdrop)?!1:!0,ddGroup:"modx-treedrop-elements-dd",title:"",url:MODx.config.connector_url,action:"element/getnodes",sortAction:"element/sort",useDefaultToolbar:!1,baseParams:{currentElement:MODx.request.id||0,currentAction:MODx.request.a||0},tbar:[{cls:"tree-new-template",tooltip:{text:_("new")+" "+_("template")},handler:function(){this.redirect("?a=element/template/create")},scope:this,hidden:MODx.perm.new_template?!1:!0},{cls:"tree-new-tv",tooltip:{text:_("new")+" "+_("tv")},handler:function(){this.redirect("?a=element/tv/create")},scope:this,hidden:MODx.perm.new_tv?!1:!0},{cls:"tree-new-chunk",tooltip:{text:_("new")+" "+_("chunk")},handler:function(){this.redirect("?a=element/chunk/create")},scope:this,hidden:MODx.perm.new_chunk?!1:!0},{cls:"tree-new-snippet",tooltip:{text:_("new")+" "+_("snippet")},handler:function(){this.redirect("?a=element/snippet/create")},scope:this,hidden:MODx.perm.new_snippet?!1:!0},{cls:"tree-new-plugin",tooltip:{text:_("new")+" "+_("plugin")},handler:function(){this.redirect("?a=element/plugin/create")},scope:this,hidden:MODx.perm.new_plugin?!1:!0},{cls:"tree-new-category",tooltip:{text:_("new_category")},handler:function(){this.createCategory(null,{target:this.getEl()})},scope:this,hidden:MODx.perm.new_category?!1:!0}]}),MODx.tree.Element.superclass.constructor.call(this,config),this.on("afterSort",this.afterSort)},Ext.extend(MODx.tree.Element,MODx.tree.Tree,{forms:{},windows:{},stores:{},createCategory:function(n,e){var r={};this.cm.activeNode&&this.cm.activeNode.attributes.data&&(r.parent=this.cm.activeNode.attributes.data.id);var w=MODx.load({xtype:"modx-window-category-create",record:r,listeners:{success:{fn:function(){var node=this.cm.activeNode?this.cm.activeNode.id:"n_category";this.refreshNode(node,!0)},scope:this},hide:{fn:function(){this.destroy()}}}});w.show(e.target)},renameCategory:function(itm,e){var r=this.cm.activeNode.attributes.data,w=MODx.load({xtype:"modx-window-category-rename",record:r,listeners:{success:{fn:function(r){var c=r.a.result.object,n=this.cm.activeNode;n.setText(c.category+" ("+c.id+")"),Ext.get(n.getUI().getEl()).frame(),n.attributes.data.id=c.id,n.attributes.data.category=c.category},scope:this},hide:{fn:function(){this.destroy()}}}});w.show(e.target)},removeCategory:function(){var id=this.cm.activeNode.attributes.data.id;MODx.msg.confirm({title:_("warning"),text:_("category_confirm_delete"),url:MODx.config.connector_url,params:{action:"element/category/remove",id:id},listeners:{success:{fn:function(){this.cm.activeNode.remove()},scope:this}}})},duplicateElement:function(itm,e,id,type){var r={id:id,type:type,name:_("duplicate_of",{name:this.cm.activeNode.attributes.name})},w=MODx.load({xtype:"modx-window-element-duplicate",record:r,listeners:{success:{fn:function(){this.refreshNode(this.cm.activeNode.id)},scope:this},hide:{fn:function(){this.destroy()}}}});w.show(e.target)},removeElement:function(){var id=this.cm.activeNode.id.substr(2),oar=id.split("_");MODx.msg.confirm({title:_("warning"),text:_("remove_this_confirm",{type:oar[0],name:this.cm.activeNode.attributes.name}),url:MODx.config.connector_url,params:{action:"element/"+oar[0]+"/remove",id:oar[2]},listeners:{success:{fn:function(){this.cm.activeNode.remove(),MODx.request.a=="element/"+oar[0]+"/update"&&MODx.request.id==oar[2]&&MODx.loadPage("welcome")},scope:this}}})},activatePlugin:function(){var id=this.cm.activeNode.id.substr(2),oar=id.split("_");MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"element/plugin/activate",id:oar[2]},listeners:{success:{fn:function(){this.refreshParentNode()},scope:this}}})},deactivatePlugin:function(){var id=this.cm.activeNode.id.substr(2),oar=id.split("_");MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"element/plugin/deactivate",id:oar[2]},listeners:{success:{fn:function(){this.refreshParentNode()},scope:this}}})},quickCreate:function(itm,e,type){var r={category:this.cm.activeNode.attributes.pk||""},w=MODx.load({xtype:"modx-window-quick-create-"+type,record:r,listeners:{success:{fn:function(){this.refreshNode(this.cm.activeNode.id,!0)},scope:this},hide:{fn:function(){this.destroy()}}}});w.setValues(r),w.show(e.target)},quickUpdate:function(itm,e,type){MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"element/"+type+"/get",id:this.cm.activeNode.attributes.pk},listeners:{success:{fn:function(r){var w=MODx.load({xtype:"modx-window-quick-update-"+type,record:r.object,listeners:{success:{fn:function(){this.refreshNode(this.cm.activeNode.id)},scope:this},hide:{fn:function(){this.destroy()}}}});w.setValues(r.object),w.show(e.target)},scope:this}}})},_createElement:function(){var id=this.cm.activeNode.id.substr(2),oar=id.split("_"),type="type"==oar[0]?oar[1]:oar[0],cat_id="type"==oar[0]?0:"category"==oar[1]?oar[2]:oar[3],a="element/"+type+"/create";return this.redirect("?a="+a+"&category="+cat_id),this.cm.hide(),!1},afterSort:function(o){var tn=o.event.target.attributes;if("category"==tn.type){var dn=o.event.dropNode.attributes;"n_category"!=tn.id&&"category"==dn.type?o.event.target.expand():(this.refreshNode(o.event.target.attributes.id,!0),this.refreshNode("n_type_"+o.event.dropNode.attributes.type,!0))}},_handleDrop:function(e){var target=e.target;return"above"==e.point||"below"==e.point?!1:"modCategory"!=target.attributes.classKey&&"root"!=target.attributes.classKey?!1:this.isCorrectType(e.dropNode,target)?"category"==target.attributes.type&&"append"==e.point?!0:target.getDepth()>0:!1},isCorrectType:function(dropNode,targetNode){var r=!1;return targetNode.attributes.type==dropNode.attributes.type&&(targetNode.parentNode&&("folder"==dropNode.attributes.cls&&"folder"==targetNode.attributes.cls&&dropNode.parentNode.id==targetNode.parentNode.id||"file"==targetNode.attributes.cls)||(r=!0)),r},_showContextMenu:function(n,e){if(this.cm.activeNode=n,this.cm.removeAll(),n.attributes.menu&&n.attributes.menu.items)this.addContextMenuItem(n.attributes.menu.items),this.cm.show(n.getUI().getEl(),"t?");else{var m=[];switch(n.attributes.classKey){case"root":m=this._getRootMenu(n);break;case"modCategory":m=this._getCategoryMenu(n);break;default:m=this._getElementMenu(n)}this.addContextMenuItem(m),this.cm.showAt(e.xy)}e.stopEvent()},_getQuickCreateMenu:function(n,m){for(var t,ui=n.getUI(),mn=[],types=["template","tv","chunk","snippet","plugin"],i=0;i<types.length;i++)t=types[i],ui.hasClass("pnew_"+t)&&mn.push({text:_(t),scope:this,type:t,handler:function(itm,e){this.quickCreate(itm,e,itm.type)}});return m.push({text:_("quick_create"),handler:function(){return!1},menu:{items:mn}}),m},_getElementMenu:function(n){var a=n.attributes,ui=n.getUI(),m=[];return m.push({text:"<b>"+a.text+"</b>",handler:function(){return!1},header:!0}),m.push("-"),ui.hasClass("pedit")&&(m.push({text:_("edit_"+a.type),type:a.type,pk:a.pk,handler:function(itm){MODx.loadPage("element/"+itm.type+"/update","id="+itm.pk)}}),m.push({text:_("quick_update_"+a.type),type:a.type,handler:function(itm,e){this.quickUpdate(itm,e,itm.type)}}),"modPlugin"==a.classKey&&m.push(a.active?{text:_("plugin_deactivate"),type:a.type,handler:this.deactivatePlugin}:{text:_("plugin_activate"),type:a.type,handler:this.activatePlugin})),ui.hasClass("pnew")&&m.push({text:_("duplicate_"+a.type),pk:a.pk,type:a.type,handler:function(itm,e){this.duplicateElement(itm,e,itm.pk,itm.type)}}),ui.hasClass("pdelete")&&m.push({text:_("remove_"+a.type),handler:this.removeElement}),m.push("-"),ui.hasClass("pnew")&&m.push({text:_("add_to_category_"+a.type),handler:this._createElement}),ui.hasClass("pnewcat")&&m.push({text:_("new_category"),handler:this.createCategory}),m},_getCategoryMenu:function(n){var a=n.attributes,ui=n.getUI(),m=[];return m.push({text:"<b>"+a.text+"</b>",handler:function(){return!1},header:!0}),m.push("-"),ui.hasClass("pnewcat")&&m.push({text:_("category_create"),handler:this.createCategory}),ui.hasClass("peditcat")&&m.push({text:_("category_rename"),handler:this.renameCategory}),m.length>2&&m.push("-"),a.elementType&&m.push({text:_("add_to_category_"+a.type),handler:this._createElement}),this._getQuickCreateMenu(n,m),ui.hasClass("pdelcat")&&(m.push("-"),m.push({text:_("category_remove"),handler:this.removeCategory})),m},_getRootMenu:function(n){var a=n.attributes,ui=n.getUI(),m=[];return ui.hasClass("pnew")&&(m.push({text:_("new_"+a.type),handler:this._createElement}),m.push({text:_("quick_create_"+a.type),type:a.type,handler:function(itm,e){this.quickCreate(itm,e,itm.type)}})),ui.hasClass("pnewcat")&&(ui.hasClass("pnew")&&m.push("-"),m.push({text:_("new_category"),handler:this.createCategory})),m},handleCreateClick:function(node){this.cm.activeNode=node;var type=this.cm.activeNode.id.substr(2).split("_");"category"!=type[0]?this._createElement(null,null,null):this.createCategory(null,{target:this})}}),Ext.reg("modx-tree-element",MODx.tree.Element),MODx.window.DuplicateElement=function(config){config=config||{},this.ident=config.ident||"dupeel-"+Ext.id();var flds=[{xtype:"hidden",name:"id",id:"modx-"+this.ident+"-id"},{xtype:"textfield",fieldLabel:_("element_name_new"),name:"template"==config.record.type?"templatename":"name",id:"modx-"+this.ident+"-name",anchor:"90%"}];"tv"==config.record.type&&flds.push({xtype:"xcheckbox",fieldLabel:_("element_duplicate_values"),labelSeparator:"",name:"duplicateValues",id:"modx-"+this.ident+"-duplicate-values",anchor:"95%",inputValue:1,checked:!1}),Ext.applyIf(config,{title:_("element_duplicate"),url:MODx.config.connector_url,action:"element/"+config.record.type+"/duplicate",fields:flds,labelWidth:150}),MODx.window.DuplicateElement.superclass.constructor.call(this,config)},Ext.extend(MODx.window.DuplicateElement,MODx.Window),Ext.reg("modx-window-element-duplicate",MODx.window.DuplicateElement),MODx.window.RenameCategory=function(config){config=config||{},this.ident=config.ident||"rencat-"+Ext.id(),Ext.applyIf(config,{title:_("category_rename"),height:150,width:350,url:MODx.config.connector_url,action:"element/category/update",fields:[{xtype:"hidden",name:"id",id:"modx-"+this.ident+"-id",value:config.record.id},{xtype:"textfield",fieldLabel:_("name"),name:"category",id:"modx-"+this.ident+"-category",width:150,value:config.record.category,anchor:"90%"}]}),MODx.window.RenameCategory.superclass.constructor.call(this,config)},Ext.extend(MODx.window.RenameCategory,MODx.Window),Ext.reg("modx-window-category-rename",MODx.window.RenameCategory),MODx.tree.Directory=function(config){config=config||{},config.id=config.id||Ext.id(),Ext.applyIf(config,{rootVisible:!0,rootName:"Filesystem",rootId:"/",title:_("files"),ddAppendOnly:!1,enableDrag:!0,enableDrop:!0,ddGroup:"modx-treedrop-sources-dd",url:MODx.config.connector_url,hideSourceCombo:!1,baseParams:{hideFiles:config.hideFiles||!1,wctx:MODx.ctx||"web",currentAction:MODx.request.a||0,currentFile:MODx.request.file||"",source:config.source||0},action:"browser/directory/getList",primaryKey:"dir",useDefaultToolbar:!0,autoExpandRoot:!1,tbar:[{icon:MODx.config.manager_url+"templates/default/images/restyle/icons/folder.png",cls:"x-btn-icon",tooltip:{text:_("file_folder_create")},handler:this.createDirectory,scope:this,hidden:MODx.perm.directory_create?!1:!0},{icon:MODx.config.manager_url+"templates/default/images/restyle/icons/page_white.png",cls:"x-btn-icon",tooltip:{text:_("file_create")},handler:this.createFile,scope:this,hidden:MODx.perm.file_create?!1:!0},{icon:MODx.config.manager_url+"templates/default/images/restyle/icons/file_upload.png",cls:"x-btn-icon",tooltip:{text:_("upload_files")},handler:this.uploadFiles,scope:this,hidden:MODx.perm.file_upload?!1:!0},"->",{icon:MODx.config.manager_url+"templates/default/images/restyle/icons/file_manager.png",cls:"x-btn-icon",tooltip:{text:_("modx_browser")},handler:this.loadFileManager,scope:this,hidden:MODx.perm.file_manager&&!MODx.browserOpen?!1:!0}],tbarCfg:{id:config.id+"-tbar"}}),MODx.tree.Directory.superclass.constructor.call(this,config),this.addEvents({beforeUpload:!0,afterUpload:!0,fileBrowserSelect:!0,changeSource:!0}),this.on("click",function(n){n.select(),this.cm.activeNode=n},this),this.on("render",function(){var el=Ext.get(this.config.id);el.createChild({tag:"div",id:this.config.id+"_tb"}),el.createChild({tag:"div",id:this.config.id+"_filter"}),this.addSourceToolbar()},this),this.on("show",function(){if(!this.config.hideSourceCombo)try{this.sourceCombo.show()}catch(e){}},this),this._init(),this.on("afterrender",this.showRefresh,this)},Ext.extend(MODx.tree.Directory,MODx.tree.Tree,{windows:{},showRefresh:function(){var node=this.getRootNode(),inlineButtonsLang=this.getInlineButtonsLang(node),elId=node.ui.elNode.id+"_tools",el=document.createElement("div");el.id=elId,el.className="modx-tree-node-tool-ct",node.ui.elNode.appendChild(el),MODx.load({xtype:"modx-button",text:"",scope:this,tooltip:new Ext.ToolTip({title:inlineButtonsLang.refresh,target:this}),node:node,handler:function(btn,evt){evt.stopPropagation(evt),node.reload()},iconCls:"icon-refresh",renderTo:elId,listeners:{mouseover:function(button,e){button.tooltip.onTargetOver(e)},mouseout:function(button,e){button.tooltip.onTargetOut(e)}}})},addSourceToolbar:function(){if(this.sourceCombo=new MODx.combo.MediaSource({value:this.config.source||MODx.config.default_media_source,listeners:{select:{fn:this.changeSource,scope:this}}}),this.searchBar=new Ext.Toolbar({renderTo:this.tbar,id:this.config.id+"-sourcebar",items:[this.sourceCombo]}),this.on("resize",function(){this.sourceCombo.setWidth(this.getWidth()-12)},this),this.config.hideSourceCombo)try{this.sourceCombo.hide()}catch(e){}},changeSource:function(sel){var s=sel.getValue(),rn=this.getRootNode();rn&&rn.setText(sel.getRawValue()),this.config.baseParams.source=s,this.fireEvent("changeSource",s),this.refresh()},_init:function(){var treeState=Ext.state.Manager.get(this.treestate_id),rootPath=this.root.getPath("text");rootPath!==treeState&&this.root.expand()},_initExpand:function(){var treeState=Ext.state.Manager.get(this.treestate_id);Ext.isEmpty(this.config.openTo)?this.expandPath(treeState,"text"):this.selectPath("/"+_("files")+"/"+this.config.openTo,"text")},_saveState:function(n){n.expanded||n.isRoot||(n=n.parentNode);var p=n.getPath("text");Ext.state.Manager.set(this.treestate_id,p)},_handleDrag:function(dropEvent){var from=dropEvent.dropNode.attributes.id,to=dropEvent.target.attributes.id;MODx.Ajax.request({url:this.config.url,params:{source:this.config.baseParams.source,from:from,to:to,action:this.config.sortAction||"browser/directory/sort",point:dropEvent.point},listeners:{success:{fn:function(r){var el=dropEvent.dropNode.getUI().getTextEl();el&&Ext.get(el).frame(),this.fireEvent("afterSort",{event:dropEvent,result:r})},scope:this},failure:{fn:function(r){return MODx.form.Handler.errorJSON(r),this.refresh(),!1},scope:this}}})},getPath:function(node){var path,p,a;if(node!==this.root){for(p=node.parentNode,a=[node.text];p&&p!==this.root;)a.unshift(p.text),p=p.parentNode;a.unshift(this.root.attributes.path||""),path=a.join(this.pathSeparator)}else path=node.attributes.path||"";return path=path.replace(/^[\/\.]*/,""),path+"/"},editFile:function(){MODx.loadPage("system/file/edit","file="+this.cm.activeNode.attributes.id+"&source="+this.config.source)},quickUpdateFile:function(itm,e){var node=this.cm.activeNode;MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"browser/file/get",file:node.attributes.id,wctx:MODx.ctx||"",source:this.getSource()},listeners:{success:{fn:function(response){var r={file:node.attributes.id,name:node.text,path:node.attributes.pathRelative,source:this.getSource(),content:response.object.content},w=MODx.load({xtype:"modx-window-file-quick-update",record:r,listeners:{hide:{fn:function(){this.destroy()}}}});w.show(e.target)},scope:this}}})},createFile:function(){var active=this.cm.activeNode,dir=active&&active.attributes&&(active.isRoot||"dir"==active.attributes.type)?active.attributes.id:"";MODx.loadPage("system/file/create","directory="+dir+"&source="+this.getSource())},quickCreateFile:function(itm,e){var node=this.cm.activeNode,r={directory:node.attributes.id,source:this.getSource()},w=MODx.load({xtype:"modx-window-file-quick-create",record:r,listeners:{success:{fn:this.refreshActiveNode,scope:this},hide:{fn:function(){this.destroy()}}}});w.show(e.target)},browser:null,loadFileManager:function(){var refresh=!1;null===this.browser?this.browser=MODx.load({xtype:"modx-browser",hideFiles:!0,rootVisible:!1,wctx:MODx.ctx,source:this.config.baseParams.source,listeners:{select:{fn:function(data){this.fireEvent("fileBrowserSelect",data)},scope:this}}}):refresh=!0,this.browser&&(this.browser.setSource(this.config.baseParams.source),refresh&&this.browser.win.tree.refresh(),this.browser.show())},renameNode:function(field,nv,ov){MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"browser/file/rename",new_name:nv,old_name:ov,file:this.treeEditor.editNode.id,wctx:MODx.ctx||"",source:this.getSource()},listeners:{success:{fn:this.refreshActiveNode,scope:this}}})},renameDirectory:function(item,e){var node=this.cm.activeNode,r={old_name:node.text,name:node.text,path:node.attributes.pathRelative,source:this.getSource()},w=MODx.load({xtype:"modx-window-directory-rename",record:r,listeners:{success:{fn:this.refreshParentNode,scope:this},hide:{fn:function(){this.destroy()}}}});w.show(e.target)},renameFile:function(item,e){var node=this.cm.activeNode,r={old_name:node.text,name:node.text,path:node.attributes.pathRelative,source:this.getSource()},w=MODx.load({xtype:"modx-window-file-rename",record:r,listeners:{success:{fn:this.refreshParentNode,scope:this},hide:{fn:function(){this.destroy()}}}});w.show(e.target)},createDirectory:function(item,e){var node=this.cm&&this.cm.activeNode?this.cm.activeNode:!1,r={parent:node&&"dir"==node.attributes.type?node.attributes.pathRelative:"/",source:this.getSource()},w=MODx.load({xtype:"modx-window-directory-create",record:r,listeners:{success:{fn:this.refreshActiveNode,scope:this},hide:{fn:function(){this.destroy()}}}});w.show(e?e.target:Ext.getBody())},chmodDirectory:function(item,e){var node=this.cm.activeNode,r={dir:node.attributes.path,mode:node.attributes.perms,source:this.getSource()},w=MODx.load({xtype:"modx-window-directory-chmod",record:r,listeners:{success:{fn:this.refreshActiveNode,scope:this},hide:{fn:function(){this.destroy()}}}});w.show(e.target)},removeDirectory:function(){var node=this.cm.activeNode;MODx.msg.confirm({text:_("file_folder_remove_confirm"),url:MODx.config.connector_url,params:{action:"browser/directory/remove",dir:node.attributes.path,wctx:MODx.ctx||"",source:this.getSource()},listeners:{success:{fn:this._afterRemove,scope:this}}})},removeFile:function(){var node=this.cm.activeNode;MODx.msg.confirm({text:_("file_confirm_remove"),url:MODx.config.connector_url,params:{action:"browser/file/remove",file:node.attributes.id,wctx:MODx.ctx||"",source:this.getSource()},listeners:{success:{fn:this._afterRemove,scope:this}}})},_afterRemove:function(){this.refreshParentNode(),this.cm.activeNode=null},downloadFile:function(){var node=this.cm.activeNode;MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"browser/file/download",file:node.attributes.id,wctx:MODx.ctx||"",source:this.getSource()},listeners:{success:{fn:function(r){Ext.isEmpty(r.object.url)||(location.href=MODx.config.connector_url+"?action=browser/file/download&download=1&file="+node.attributes.id+"&HTTP_MODAUTH="+MODx.siteId+"&source="+this.getSource()+"&wctx="+MODx.ctx)},scope:this}}})},getSource:function(){return this.config.baseParams.source},uploadFiles:function(btn){this.uploader||(this.uploader=new MODx.util.MultiUploadDialog.Dialog({url:MODx.config.connector_url,base_params:{action:"browser/file/upload",wctx:MODx.ctx||"",source:this.getSource()},cls:"ext-ux-uploaddialog-dialog modx-upload-window"}),this.uploader.on("show",this.beforeUpload,this),this.uploader.on("uploadsuccess",this.uploadSuccess,this),this.uploader.on("uploaderror",this.uploadError,this),this.uploader.on("uploadfailed",this.uploadFailed,this)),this.uploader.base_params.source=this.getSource(),this.uploader.show(btn)},uploadError:function(){},uploadFailed:function(){},uploadSuccess:function(){if(this.cm.activeNode){var node=this.cm.activeNode;if(node.isLeaf){var pn=node.isLeaf()?node.parentNode:node;pn?pn.reload():this.refreshActiveNode(),this.fireEvent("afterUpload",node)}else this.refreshActiveNode()}else this.refresh(),this.fireEvent("afterUpload")},beforeUpload:function(){var path=this.config.rootId||"/";this.cm.activeNode&&(path=this.getPath(this.cm.activeNode),this.cm.activeNode.isLeaf()&&(path=this.getPath(this.cm.activeNode.parentNode))),this.uploader.setBaseParams({action:"browser/file/upload",path:path,wctx:MODx.ctx||"",source:this.getSource()}),this.fireEvent("beforeUpload",this.cm.activeNode)}}),Ext.reg("modx-tree-directory",MODx.tree.Directory),MODx.window.CreateDirectory=function(config){config=config||{},Ext.applyIf(config,{width:430,height:200,title:_("file_folder_create"),url:MODx.config.connector_url,action:"browser/directory/create",fields:[{xtype:"hidden",name:"wctx",value:MODx.ctx||""},{xtype:"hidden",name:"source"},{fieldLabel:_("name"),name:"name",xtype:"textfield",anchor:"100%",allowBlank:!1},{fieldLabel:_("file_folder_parent"),name:"parent",xtype:"textfield",anchor:"100%"}]}),MODx.window.CreateDirectory.superclass.constructor.call(this,config)},Ext.extend(MODx.window.CreateDirectory,MODx.Window),Ext.reg("modx-window-directory-create",MODx.window.CreateDirectory),MODx.window.ChmodDirectory=function(config){config=config||{},Ext.applyIf(config,{title:_("file_folder_chmod"),width:430,height:200,url:MODx.config.connector_url,action:"browser/directory/chmod",fields:[{xtype:"hidden",name:"wctx",value:MODx.ctx||""},{xtype:"hidden",name:"source"},{name:"dir",fieldLabel:_("name"),xtype:"statictextfield",anchor:"100%",submitValue:!0},{fieldLabel:_("mode"),name:"mode",xtype:"textfield",anchor:"100%",allowBlank:!1}]}),MODx.window.ChmodDirectory.superclass.constructor.call(this,config)},Ext.extend(MODx.window.ChmodDirectory,MODx.Window),Ext.reg("modx-window-directory-chmod",MODx.window.ChmodDirectory),MODx.window.RenameDirectory=function(config){config=config||{},Ext.applyIf(config,{title:_("rename"),width:430,height:200,url:MODx.config.connector_url,action:"browser/directory/rename",fields:[{xtype:"hidden",name:"wctx",value:MODx.ctx||""},{xtype:"hidden",name:"source"},{fieldLabel:_("path"),name:"path",xtype:"statictextfield",submitValue:!0,anchor:"100%"},{fieldLabel:_("old_name"),name:"old_name",xtype:"statictextfield",anchor:"100%"},{fieldLabel:_("new_name"),name:"name",xtype:"textfield",anchor:"100%",allowBlank:!1}]}),MODx.window.RenameDirectory.superclass.constructor.call(this,config)},Ext.extend(MODx.window.RenameDirectory,MODx.Window),Ext.reg("modx-window-directory-rename",MODx.window.RenameDirectory),MODx.window.RenameFile=function(config){config=config||{},Ext.applyIf(config,{title:_("rename"),width:430,height:200,url:MODx.config.connector_url,action:"browser/file/rename",fields:[{xtype:"hidden",name:"wctx",value:MODx.ctx||""},{xtype:"hidden",name:"source"},{fieldLabel:_("path"),name:"path",xtype:"statictextfield",submitValue:!0,anchor:"100%"},{fieldLabel:_("old_name"),name:"old_name",xtype:"statictextfield",anchor:"100%"},{fieldLabel:_("new_name"),name:"name",xtype:"textfield",anchor:"100%",allowBlank:!1},{name:"dir",xtype:"hidden"}]}),MODx.window.RenameFile.superclass.constructor.call(this,config)},Ext.extend(MODx.window.RenameFile,MODx.Window),Ext.reg("modx-window-file-rename",MODx.window.RenameFile),MODx.window.QuickUpdateFile=function(config){config=config||{},Ext.applyIf(config,{title:_("file_quick_update"),width:600,height:640,autoHeight:!1,layout:"anchor",url:MODx.config.connector_url,action:"browser/file/update",fields:[{xtype:"hidden",name:"wctx",value:MODx.ctx||""},{xtype:"hidden",name:"source"},{xtype:"hidden",name:"file"},{fieldLabel:_("name"),name:"name",xtype:"statictextfield",anchor:"100%"},{fieldLabel:_("path"),name:"path",xtype:"statictextfield",anchor:"100%"},{fieldLabel:_("content"),xtype:"textarea",name:"content",anchor:"100% -118"}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}],buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),scope:this,handler:this.submit}]}),MODx.window.QuickUpdateFile.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdateFile,MODx.Window),Ext.reg("modx-window-file-quick-update",MODx.window.QuickUpdateFile),MODx.window.QuickCreateFile=function(config){config=config||{},Ext.applyIf(config,{title:_("file_quick_create"),width:600,height:640,autoHeight:!1,layout:"anchor",url:MODx.config.connector_url,action:"browser/file/create",fields:[{xtype:"hidden",name:"wctx",value:MODx.ctx||""},{xtype:"hidden",name:"source"},{fieldLabel:_("directory"),name:"directory",submitValue:!0,xtype:"statictextfield",anchor:"100%"},{fieldLabel:_("name"),name:"name",xtype:"textfield",anchor:"100%",allowBlank:!1},{fieldLabel:_("content"),xtype:"textarea",name:"content",anchor:"100% -120"}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}],buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:this.submit}]}),MODx.window.QuickCreateFile.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreateFile,MODx.Window),Ext.reg("modx-window-file-quick-create",MODx.window.QuickCreateFile),MODx.panel.FileTree=function(config){config=config||{},Ext.applyIf(config,{_treePrefix:"source-tree-",id:"modx-leftbar-filetree",autoHeight:!0,defaults:{autoHeight:!0,border:!1}}),MODx.panel.FileTree.superclass.constructor.call(this,config),this.on("render",this.getSourceList,this)},Ext.extend(MODx.panel.FileTree,Ext.Container,{getSourceList:function(){MODx.Ajax.request({url:MODx.config.connectors_url,params:{action:"source/getList"},listeners:{success:{fn:function(data){this.onSourceListReceived(data.results)},scope:this},failure:{fn:function(data){return data.total>0&&void 0!=data.results&&this.onSourceListReceived(data.results),!1},scope:this}}})},onSourceListReceived:function(sources){for(var k=0;k<sources.length;k++){var source=sources[k],exists=this.getComponent(this._treePrefix+source.id);if(!exists)var tree=this.loadTree(source);this.add(tree),tree=exists=void 0}this.doLayout()},loadTree:function(source){return MODx.load({xtype:"modx-tree-directory",itemId:this._treePrefix+source.id,stateId:this._treePrefix+source.id,id:this._treePrefix+source.id,rootName:source.name,hideSourceCombo:!0,source:source.id,tbar:!1,tbarCfg:{hidden:!0}})}}),Ext.reg("modx-panel-filetree",MODx.panel.FileTree),MODx.DataView=function(config){config=config||{},this._loadStore(config),Ext.applyIf(config.listeners||{},{loadexception:{fn:this.onLoadException,scope:this},beforeselect:{fn:function(view){return view.store.getRange().length>0}},contextmenu:{fn:this._showContextMenu,scope:this}}),Ext.applyIf(config,{store:this.store,singleSelect:!0,overClass:"x-view-over",itemSelector:"div.modx-pb-thumb-wrap",emptyText:'<div style="padding:10px;">'+_("file_err_filter")+"</div>",closeAction:"hide"}),MODx.DataView.superclass.constructor.call(this,config),this.config=config,this.cm=new Ext.menu.Menu},Ext.extend(MODx.DataView,Ext.DataView,{lookup:{},onLoadException:function(){this.getEl().update('<div style="padding:10px;">'+_("data_err_load")+"</div>")
},_addContextMenuItem:function(items){for(var a=items,l=a.length,i=0;l>i;i+=1){var options=a[i];if("-"!==options){var h=Ext.emptyFn;h=options.handler?eval(options.handler):function(itm){var o=itm.options,id=this.cm.activeNode.id.split("_");id=id[1];var w=Ext.get("modx_content");if(o.confirm)Ext.Msg.confirm("",o.confirm,function(e){if("yes"===e){var a=Ext.urlEncode(o.params||{action:o.action}),s="?id="+id+"&"+a;null===w?location.href=s:w.dom.src=s}},this);else{var a=Ext.urlEncode(o.params),s="?id="+id+"&"+a;null===w?location.href=s:w.dom.src=s}},this.cm.add({id:options.id,text:options.text,scope:this,options:options,handler:h})}else this.cm.add("-")}},_loadStore:function(config){this.store=new Ext.data.JsonStore({url:config.url,baseParams:config.baseParams||{action:"browser/directory/getList",wctx:config.wctx||MODx.ctx,dir:config.openTo||"",source:config.source||0},root:config.root||"results",fields:config.fields,totalProperty:"total",listeners:{load:{fn:function(){this.select(0)},scope:this,single:!0}}}),this.store.load()},_showContextMenu:function(v,i,n,e){e.preventDefault();var data=this.lookup[n.id],m=this.cm;m.removeAll(),data.menu&&(this._addContextMenuItem(data.menu),m.show(n,"tl-c?")),m.activeNode=n}}),Ext.reg("modx-dataview",MODx.DataView),Ext.namespace("MODx.browser"),MODx.Browser=function(config){return MODx.browserOpen&&!config.multiple?!1:(config.multiple||(MODx.browserOpen=!0),config=config||{},Ext.applyIf(config,{onSelect:function(){},scope:this,source:config.source||1,cls:"modx-browser",closeAction:"hide"}),MODx.Browser.superclass.constructor.call(this,config),this.config=config,this.win=new MODx.browser.Window(config),void this.win.reset())},Ext.extend(MODx.Browser,Ext.Component,{show:function(el){this.win&&this.win.show(el)},hide:function(){this.win&&this.win.hide()},setSource:function(source){this.config.source=source,this.win.tree.config.baseParams.source=source,this.win.view.config.baseParams.source=source}}),Ext.reg("modx-browser",MODx.Browser),MODx.browser.Window=function(config){config=config||{},this.ident=Ext.id(),this.view=MODx.load({xtype:"modx-browser-view",onSelect:{fn:this.onSelect,scope:this},source:config.source||MODx.config.default_media_source,allowedFileTypes:config.allowedFileTypes||"",wctx:config.wctx||"web",openTo:config.openTo||"",ident:this.ident,id:this.ident+"-view"}),this.tree=MODx.load({xtype:"modx-tree-directory",onUpload:function(){this.view.run()},scope:this,source:config.source||MODx.config.default_media_source,hideFiles:config.hideFiles||!1,openTo:config.openTo||"",ident:this.ident,rootId:config.rootId||"/",rootName:_("files"),rootVisible:void 0==config.rootVisible||!Ext.isEmpty(config.rootId),id:this.ident+"-tree",hideSourceCombo:config.hideSourceCombo||!1,listeners:{afterUpload:{fn:function(){this.view.run()},scope:this},changeSource:{fn:function(s){this.config.source=s,this.view.config.source=s,this.view.baseParams.source=s,this.view.dir="/",this.view.run()},scope:this},nodeclick:{fn:function(n,e){return n.select(),e.preventDefault(),e.stopPropagation(),!1},scope:this},afterrender:{fn:function(tree){tree.root.expand()},scope:this}}}),this.tree.on("click",function(node){this.load(node.id)},this),Ext.applyIf(config,{title:_("modx_browser")+" ("+(MODx.ctx?MODx.ctx:"web")+")",cls:"modx-pb-win",layout:"border",minWidth:500,minHeight:300,width:"90%",height:500,modal:!1,closeAction:"hide",border:!1,items:[{id:this.ident+"-browser-tree",cls:"modx-pb-browser-tree",region:"west",width:250,height:"100%",items:this.tree,autoScroll:!0,split:!0,border:!1},{id:this.ident+"-browser-view",cls:"modx-pb-view-ct",region:"center",autoScroll:!0,border:!1,items:this.view,tbar:this.getToolbar()},{id:this.ident+"-img-detail-panel",cls:"modx-pb-details-ct",region:"east",split:!0,border:!1,width:250}],buttons:[{id:this.ident+"-ok-btn",text:_("ok"),handler:this.onSelect,scope:this},{id:this.ident+"-cancel-btn",text:_("cancel"),handler:this.close,scope:this}],keys:{key:27,handler:this.hide,scope:this}}),MODx.browser.Window.superclass.constructor.call(this,config),this.config=config,this.addEvents({select:!0})},Ext.extend(MODx.browser.Window,Ext.Window,{returnEl:null,filter:function(){var filter=Ext.getCmp(this.ident+"filter");this.view.store.filter("name",filter.getValue(),!0),this.view.select(0)},setReturn:function(el){this.returnEl=el},load:function(dir){dir=dir||(Ext.isEmpty(this.config.openTo)?"":this.config.openTo),this.view.run({dir:dir,source:this.config.source,allowedFileTypes:this.config.allowedFileTypes||"",wctx:this.config.wctx||"web"}),this.sortImages()},sortImages:function(){var v=Ext.getCmp(this.ident+"sortSelect").getValue();this.view.store.sort(v,"name"==v?"asc":"desc"),this.view.select(0)},reset:function(){this.rendered&&(Ext.getCmp(this.ident+"filter").reset(),this.view.getEl().dom.scrollTop=0),this.view.store.clearFilter(),this.view.select(0)},getToolbar:function(){return["-",{text:_("filter")+":",xtype:"label"},"-",{xtype:"textfield",id:this.ident+"filter",selectOnFocus:!0,width:100,listeners:{render:{fn:function(){Ext.getCmp(this.ident+"filter").getEl().on("keyup",function(){this.filter()},this,{buffer:500})},scope:this}}},"-",{text:_("sort_by")+":",xtype:"label"},"-",{id:this.ident+"sortSelect",xtype:"combo",typeAhead:!0,triggerAction:"all",width:100,editable:!1,mode:"local",displayField:"desc",valueField:"name",lazyInit:!1,value:MODx.config.modx_browser_default_sort||"name",store:new Ext.data.SimpleStore({fields:["name","desc"],data:[["name",_("name")],["size",_("file_size")],["lastmod",_("last_modified")]]}),listeners:{select:{fn:this.sortImages,scope:this}}}]},onSelect:function(){var selNode=this.view.getSelectedNodes()[0],callback=this.config.onSelect||this.onSelectHandler,lookup=this.view.lookup,scope=this.config.scope;this.hide(this.config.animEl||null,function(){if(selNode&&callback){var data=lookup[selNode.id];Ext.callback(callback,scope||this,[data]),this.fireEvent("select",data)}},scope)},onSelectHandler:function(data){Ext.get(this.returnEl).dom.value=unescape(data.url)}}),Ext.reg("modx-browser-window",MODx.browser.Window),MODx.browser.View=function(config){config=config||{},this.ident=config.ident+"-view"||"modx-browser-"+Ext.id()+"-view",this._initTemplates(),Ext.applyIf(config,{url:MODx.config.connector_url,id:this.ident,fields:["name","cls","url","relativeUrl","fullRelativeUrl","image","image_width","image_height","thumb","thumb_width","thumb_height","pathname","ext","disabled",{name:"size",type:"float"},{name:"lastmod",type:"date",dateFormat:"timestamp"},"menu"],baseParams:{action:"browser/directory/getfiles",prependPath:config.prependPath||null,prependUrl:config.prependUrl||null,source:config.source||1,allowedFileTypes:config.allowedFileTypes||"",wctx:config.wctx||"web",dir:config.openTo||""},sortInfo:{field:MODx.config.modx_browser_default_sort||"name",direction:"ASC"},tpl:this.templates.thumb,listeners:{selectionchange:{fn:this.showDetails,scope:this,buffer:100},dblclick:config.onSelect||{fn:Ext.emptyFn,scope:this}},prepareData:this.formatData.createDelegate(this)}),MODx.browser.View.superclass.constructor.call(this,config)},Ext.extend(MODx.browser.View,MODx.DataView,{templates:{},removeFile:function(){var node=this.cm.activeNode,d=(this.lookup[node.id],"");"object"!=typeof this.dir&&"undefined"!=typeof this.dir&&(d=this.dir),MODx.msg.confirm({text:_("file_remove_confirm"),url:MODx.config.connector_url,params:{action:"browser/file/remove",file:d+"/"+node.id,source:this.config.source,wctx:this.config.wctx||"web"},listeners:{success:{fn:function(){this.run()},scope:this}}})},run:function(p){p=p||{},p.dir&&(this.dir=p.dir),Ext.applyIf(p,{action:"browser/directory/getFiles",dir:this.dir,source:this.config.source||MODx.config.default_media_source}),this.store.load({params:p,callback:function(){this.refresh()},scope:this})},showDetails:function(){var selNode=this.getSelectedNodes(),detailEl=Ext.getCmp(this.config.ident+"-img-detail-panel").body,okBtn=Ext.getCmp(this.ident+"-ok-btn");if(selNode&&selNode.length>0){selNode=selNode[0],okBtn&&okBtn.enable();var data=this.lookup[selNode.id];detailEl.hide(),this.templates.details.overwrite(detailEl,data),detailEl.slideIn("l",{stopFx:!0,duration:".2"})}else okBtn&&okBtn.disable(),detailEl.update("")},formatData:function(data){var formatSize=function(size){return 1024>size?size+" bytes":Math.round(10*size/1024)/10+" KB"};return data.shortName=Ext.util.Format.ellipsis(data.name,18),data.sizeString=0!=data.size?formatSize(data.size):0,data.dateString=Ext.isEmpty(data.lastmod)?0:new Date(data.lastmod).format("m/d/Y g:i a"),this.lookup[data.name]=data,data},_initTemplates:function(){this.templates.thumb=new Ext.XTemplate('<tpl for=".">','<div class="modx-pb-thumb-wrap" id="{name}" title="{name}">','<div class="modx-pb-thumb"><img src="{thumb}" title="{name}" /></div>',"<span>{shortName}</span></div>","</tpl>"),this.templates.thumb.compile(),this.templates.details=new Ext.XTemplate('<div class="details">','<tpl for=".">','<div class="modx-pb-detail-thumb">','<img src="{thumb}" alt="" onclick="Ext.getCmp(\''+this.ident+"').showFullView('{name}','"+this.ident+"'); return false;\" />","</div>",'<div class="modx-pb-details-info">',"<b>"+_("file_name")+":</b>","<span>{name}</span>",'<tpl if="this.isEmpty(sizeString) == false">',"<b>"+_("file_size")+":</b>","<span>{sizeString}</span>","</tpl>",'<tpl if="this.isEmpty(dateString) == false">',"<b>"+_("last_modified")+":</b>","<span>{dateString}</span></div>","</tpl>","</tpl>","</div>",{isEmpty:function(v){return""==v||null==v||void 0==v||0===v}}),this.templates.details.compile()},showFullView:function(name,ident){var data=this.lookup[name];if(data){this.fvWin||(this.fvWin=new Ext.Window({layout:"fit",width:600,height:450,closeAction:"hide",plain:!0,items:[{id:this.ident+"modx-view-item-full",cls:"modx-pb-fullview",html:""}],buttons:[{text:_("close"),handler:function(){this.fvWin.hide()},scope:this}]})),this.fvWin.show();var w=data.image_width<250?250:data.image_width,h=data.image_height<200?200:data.image_height;this.fvWin.setSize(w,h),this.fvWin.center(),this.fvWin.setTitle(data.name),Ext.get(this.ident+"modx-view-item-full").update('<img src="'+data.image+'" alt="" class="modx-pb-fullview-img" onclick="Ext.getCmp(\''+ident+"').fvWin.hide();\" />")}}}),Ext.reg("modx-browser-view",MODx.browser.View),Ext.apply(Ext,{isFirebug:window.console&&window.console.firebug}),MODx.Layout=function(config){config=config||{},Ext.BLANK_IMAGE_URL=MODx.config.manager_url+"assets/ext3/resources/images/default/s.gif",Ext.Ajax.defaultHeaders={modAuth:config.auth},Ext.Ajax.extraParams={HTTP_MODAUTH:config.auth},MODx.siteId=config.auth,MODx.expandHelp=!Ext.isEmpty(MODx.config.inline_help);var sp=new MODx.HttpProvider;Ext.state.Manager.setProvider(sp),sp.initState(MODx.defaultState),config.showTree=!1,Ext.applyIf(config,{layout:"border",id:"modx-layout",stateSave:!0,items:this.buildLayout(config)}),MODx.Layout.superclass.constructor.call(this,config),this.config=config,this.addEvents({afterLayout:!0,loadKeyMap:!0,loadTabs:!0}),this.loadKeys(),config.showTree||(Ext.getCmp("modx-leftbar-tabs").collapse(!1),Ext.get("modx-leftbar").hide(),Ext.get("modx-leftbar-tabs-xcollapsed").setStyle("display","none")),this.fireEvent("afterLayout")},Ext.extend(MODx.Layout,Ext.Viewport,{buildLayout:function(config){var items=[],north=this.getNorth(config),west=this.getWest(config),center=this.getCenter(config),south=this.getSouth(config),east=this.getEast(config);return north&&Ext.isObject(north)&&items.push(north),west&&Ext.isObject(west)&&items.push(west),center&&Ext.isObject(center)&&items.push(center),south&&Ext.isObject(south)&&items.push(south),east&&Ext.isObject(east)&&items.push(east),items},getNorth:function(){return{xtype:"box",region:"north",applyTo:"modx-header"}},getWest:function(config){var tabs=[];MODx.perm.resource_tree&&(tabs.push({title:_("resources"),xtype:"modx-tree-resource",id:"modx-resource-tree"}),config.showTree=!0),MODx.perm.element_tree&&(tabs.push({title:_("elements"),xtype:"modx-tree-element",id:"modx-tree-element"}),config.showTree=!0),MODx.perm.file_tree&&(tabs.push({title:_("files"),xtype:"modx-panel-filetree",id:"modx-file-tree"}),config.showTree=!0);var activeTab=0;return{region:"west",applyTo:"modx-leftbar",id:"modx-leftbar-tabs",split:!0,width:310,minSize:288,maxSize:800,autoScroll:!0,unstyled:!0,collapseMode:"mini",useSplitTips:!0,monitorResize:!0,layout:"anchor",items:[{xtype:"modx-tabs",plain:!0,defaults:{autoScroll:!0,fitToFrame:!0},id:"modx-leftbar-tabpanel",border:!1,anchor:"100%",activeTab:activeTab,stateful:!0,stateEvents:["tabchange"],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())}},items:tabs}],getState:function(){return{collapsed:this.collapsed,width:this.width}},listeners:{beforestatesave:this.onBeforeSaveState,scope:this}}},getCenter:function(){return{region:"center",applyTo:"modx-content",padding:"0 1px 0 0",bodyStyle:"background-color:transparent;",id:"modx-content",border:!1,autoScroll:!0}},getSouth:function(){},getEast:function(){},getLeftBar:function(){var nav=Ext.getCmp("modx-leftbar-tabpanel");return nav?nav:null},addToLeftBar:function(items){var nav=this.getLeftBar();nav&&items&&(nav.add(items),this.onAfterLeftBarAdded(nav,items))},onAfterLeftBarAdded:function(){},loadKeys:function(){Ext.KeyMap.prototype.stopEvent=!0;var k=new Ext.KeyMap(Ext.get(document));k.addBinding({key:Ext.EventObject.H,ctrl:!0,shift:!0,fn:this.toggleLeftbar,scope:this,stopEvent:!0}),k.addBinding({key:Ext.EventObject.N,ctrl:!0,shift:!0,fn:function(){var t=Ext.getCmp("modx-resource-tree");t&&t.quickCreate(document,{},"modDocument","web",0)},stopEvent:!0}),k.addBinding({key:Ext.EventObject.U,ctrl:!0,shift:!0,alt:!1,fn:MODx.clearCache,scope:this,stopEvent:!0}),this.fireEvent("loadKeyMap",{keymap:k})},refreshTrees:function(){var t;t=Ext.getCmp("modx-resource-tree"),t&&t.rendered&&t.refresh(),t=Ext.getCmp("modx-tree-element"),t&&t.rendered&&t.refresh(),t=Ext.getCmp("modx-file-tree"),t&&t.rendered&&t.items.each(function(tree){tree.refresh()})},leftbarVisible:!0,toggleLeftbar:function(){this.leftbarVisible?this.hideLeftbar(!0):this.showLeftbar(!0),this.leftbarVisible=!this.leftbarVisible},hideLeftbar:function(anim,state){Ext.getCmp("modx-leftbar-tabs").collapse(anim),Ext.isBoolean(state)&&(this.stateSave=state)},showLeftbar:function(anim){Ext.getCmp("modx-leftbar-tabs").expand(anim)},onBeforeSaveState:function(component,state){var collapsed=state.collapsed;if(collapsed&&!this.stateSave)return this.stateSave=!0,!1;if(!collapsed){var wrap=Ext.get("modx-leftbar").down("div");wrap.isVisible()||(wrap.setVisible(!0),Ext.getCmp("modx-leftbar-tabpanel").expand(!0))}}}),MODx.LayoutMgr=function(){var _activeMenu="menu0";return{loadPage:function(action,parameters){var parts=[];action&&parts.push("?"==action.substr(0,1)||"index.php?"==action.substr(0,"index.php?".length)?action:"?a="+action),parameters&&parts.push(parameters);var url=parts.join("&");return MODx.fireEvent("beforeLoadPage",url)&&(location.href=url),!1},changeMenu:function(a,sm){if(sm===_activeMenu)return!1;Ext.get(sm).addClass("active");var om=Ext.get(_activeMenu);return om&&om.removeClass("active"),_activeMenu=sm,!1}}}(),MODx.loadPage=MODx.LayoutMgr.loadPage,MODx.showDashboard=MODx.LayoutMgr.showDashboard,MODx.hideDashboard=MODx.LayoutMgr.hideDashboard,MODx.changeMenu=MODx.LayoutMgr.changeMenu,MODx.Layout.Default=function(config){return config=config||{},Ext.applyIf(config,{}),MODx.Layout.Default.superclass.constructor.call(this,config),this},Ext.extend(MODx.Layout.Default,MODx.Layout),Ext.reg("modx-layout",MODx.Layout.Default);
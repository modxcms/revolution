Ext.namespace("MODx.combo"),Ext.form.ComboBox.prototype.shadow=!1,Ext.override(Ext.form.TriggerField,{onRender:function(ct,position){this.doc=Ext.isIE?Ext.getBody():Ext.getDoc(),Ext.form.TriggerField.superclass.onRender.call(this,ct,position),this.wrap=this.el.wrap({cls:"x-form-field-wrap x-form-field-trigger-wrap"}),this.trigger=this.wrap.createChild(this.triggerConfig||{tag:"div",cls:"x-form-trigger "+(this.triggerClass||"")}),this.initTrigger(),this.width||this.wrap.setWidth(this.el.getWidth()+this.trigger.getWidth()),this.resizeEl=this.positionEl=this.wrap}});var originalComboBoxOnLoad=Ext.form.ComboBox.prototype.onLoad;Ext.override(Ext.form.ComboBox,{loaded:!1,setValue:Ext.form.ComboBox.prototype.setValue.createSequence(function(v){var a=this.store.find(this.valueField,v);if("undefined"!=typeof v&&null!==v&&"remote"==this.mode&&-1==a&&!this.loaded){var p={};p[this.valueField]=v,this.loaded=!0,this.store.load({scope:this,params:p,callback:function(){this.setValue(v),this.collapse()}})}}),onLoad:function(){var ret=originalComboBoxOnLoad.apply(this,arguments),maxwidth=Math.max(this.minListWidth||0,this.wrap.getWidth(!0));return this.list.setWidth(maxwidth),ret}}),MODx.combo.ComboBox=function(config,getStore){return config=config||{},Ext.applyIf(config,{displayField:"name",valueField:"id",triggerAction:"all",fields:["id","name"],baseParams:{action:"getList"},width:150,editable:!1,resizable:!0,typeAhead:!1,forceSelection:!0,minChars:3,cls:"modx-combo",tries:0}),Ext.applyIf(config,{store:new Ext.data.JsonStore({url:config.connector||config.url,root:"results",totalProperty:"total",fields:config.fields,errorReader:MODx.util.JSONReader,baseParams:config.baseParams||{},remoteSort:config.remoteSort||!1,autoDestroy:!0,listeners:{loadexception:{fn:function(o,trans,resp){var status=_("code")+": "+resp.status+" "+resp.statusText+"<br/>";MODx.msg.alert(_("error"),status+resp.responseText)}}}})}),getStore===!0?(config.store.load(),config.store):(MODx.combo.ComboBox.superclass.constructor.call(this,config),this.config=config,this.addEvents({loaded:!0}),this.on("collapse",function(){this.wrap.removeClass("x-trigger-wrap-open")}),this.store.on("load",function(){this.fireEvent("loaded",this),this.loaded=!0},this,{single:!0}),this)},Ext.extend(MODx.combo.ComboBox,Ext.form.ComboBox,{expand:function(){if(!this.isExpanded()&&this.hasFocus){if(this.wrap.addClass("x-trigger-wrap-open"),"remote"==this.mode&&!this.loaded&&this.tries<4)return this.tries+=1,Ext.defer(this.expand,250,this),!1;this.tries=0,(this.title||this.pageSize)&&(this.assetHeight=0,this.title&&(this.assetHeight+=this.header.getHeight()),this.pageSize<this.store.getTotalCount()?this.assetHeight+=this.footer.getHeight():(this.list.setHeight(this.list.getHeight()-this.footer.getHeight()),this.pageTb.hide())),this.bufferSize&&(this.doResize(this.bufferSize),delete this.bufferSize),this.list.alignTo.apply(this.list,[this.el].concat(this.listAlign)),this.list.setZIndex(this.getZIndex()),this.list.show(),Ext.isGecko2&&this.innerList.setOverflow("auto"),this.mon(Ext.getDoc(),{scope:this,mousewheel:this.collapseIf,mousedown:this.collapseIf}),this.fireEvent("expand",this)}}}),Ext.reg("modx-combo",MODx.combo.ComboBox),Ext.util.Format.comboRenderer=function(combo,val){return function(v,md,rec,ri,ci,s){if(!s)return v;if(!combo.findRecord)return v;var record=combo.findRecord(combo.valueField,v);return record?record.get(combo.displayField):val}},MODx.combo.Renderer=function(combo){var loaded=!1;return function(v){var idx,rec;if(!combo.store)return v;loaded||(void 0!==combo.store.proxy&&null!==combo.store.proxy&&combo.store.load(),loaded=!0);var v2=combo.getValue();return idx=combo.store.find(combo.valueField,v2?v2:v),rec=combo.store.getAt(idx),void 0===rec||null===rec?v2?v2:v:rec.get(combo.displayField)}},MODx.combo.Boolean=function(config){config=config||{},Ext.applyIf(config,{store:new Ext.data.SimpleStore({fields:["d","v"],data:[[_("yes"),!0],[_("no"),!1]]}),displayField:"d",valueField:"v",mode:"local",triggerAction:"all",editable:!1,selectOnFocus:!1,preventRender:!0,forceSelection:!0,enableKeyEvents:!0}),MODx.combo.Boolean.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Boolean,MODx.combo.ComboBox),Ext.reg("combo-boolean",MODx.combo.Boolean),Ext.reg("modx-combo-boolean",MODx.combo.Boolean),MODx.util.PasswordField=function(config){config=config||{},delete config.xtype,Ext.applyIf(config,{xtype:"textfield",inputType:"password"}),MODx.util.PasswordField.superclass.constructor.call(this,config)},Ext.extend(MODx.util.PasswordField,Ext.form.TextField),Ext.reg("text-password",MODx.util.PasswordField),Ext.reg("modx-text-password",MODx.util.PasswordField),MODx.combo.User=function(config){config=config||{},Ext.applyIf(config,{name:"user",hiddenName:"user",displayField:"username",valueField:"id",fields:["username","id"],pageSize:20,url:MODx.config.connector_url,baseParams:{action:"security/user/getlist"},typeAhead:!0,editable:!0}),MODx.combo.User.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.User,MODx.combo.ComboBox),Ext.reg("modx-combo-user",MODx.combo.User),MODx.combo.UserGroup=function(config){config=config||{},Ext.applyIf(config,{name:"group",hiddenName:"group",displayField:"name",valueField:"id",fields:["name","id","description"],pageSize:20,url:MODx.config.connector_url,baseParams:{action:"security/group/getlist"},tpl:new Ext.XTemplate('<tpl for="."><div class="x-combo-list-item"><span style="font-weight: bold">{name}</span>',"<br />{description}</div></tpl>")}),MODx.combo.UserGroup.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.UserGroup,MODx.combo.ComboBox),Ext.reg("modx-combo-usergroup",MODx.combo.UserGroup),MODx.combo.UserGroupRole=function(config){config=config||{},Ext.applyIf(config,{name:"role",hiddenName:"role",displayField:"name",valueField:"id",fields:["name","id"],pageSize:20,url:MODx.config.connector_url,baseParams:{action:"security/role/getlist"}}),MODx.combo.UserGroupRole.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.UserGroupRole,MODx.combo.ComboBox),Ext.reg("modx-combo-usergrouprole",MODx.combo.UserGroupRole),MODx.combo.ResourceGroup=function(config){config=config||{},Ext.applyIf(config,{name:"resourcegroup",hiddenName:"resourcegroup",displayField:"name",valueField:"id",fields:["name","id"],pageSize:20,url:MODx.config.connector_url,baseParams:{action:"security/resourcegroup/getlist"}}),MODx.combo.ResourceGroup.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.ResourceGroup,MODx.combo.ComboBox),Ext.reg("modx-combo-resourcegroup",MODx.combo.ResourceGroup),MODx.combo.Context=function(config){config=config||{},Ext.applyIf(config,{name:"context",hiddenName:"context",displayField:"name",valueField:"key",fields:["key","name"],pageSize:20,url:MODx.config.connector_url,baseParams:{action:"context/getlist"}}),MODx.combo.Context.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Context,MODx.combo.ComboBox),Ext.reg("modx-combo-context",MODx.combo.Context),MODx.combo.Policy=function(config){config=config||{},Ext.applyIf(config,{name:"policy",hiddenName:"policy",displayField:"name",valueField:"id",fields:["id","name","permissions"],allowBlank:!1,editable:!1,pageSize:20,url:MODx.config.connector_url,baseParams:{action:"security/access/policy/getlist"}}),MODx.combo.Policy.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Policy,MODx.combo.ComboBox),Ext.reg("modx-combo-policy",MODx.combo.Policy),MODx.combo.Template=function(config){config=config||{},Ext.applyIf(config,{name:"template",hiddenName:"template",displayField:"templatename",valueField:"id",pageSize:20,fields:["id","templatename","description","category_name"],tpl:new Ext.XTemplate('<tpl for="."><div class="x-combo-list-item"><span style="font-weight: bold">{templatename}</span>','<tpl if="category_name"> - <span style="font-style:italic">{category_name}</span></tpl>',"<br />{description}</div></tpl>"),url:MODx.config.connector_url,baseParams:{action:"element/template/getlist"},allowBlank:!0}),MODx.combo.Template.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Template,MODx.combo.ComboBox),Ext.reg("modx-combo-template",MODx.combo.Template),MODx.combo.Category=function(config){config=config||{},Ext.applyIf(config,{name:"category",hiddenName:"category",displayField:"name",valueField:"id",mode:"remote",fields:["id","category","parent","name"],forceSelection:!0,typeAhead:!1,allowBlank:!0,editable:!1,enableKeyEvents:!0,pageSize:20,url:MODx.config.connector_url,baseParams:{action:"element/category/getlist",showNone:!0,limit:0}}),MODx.combo.Category.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Category,MODx.combo.ComboBox,{_onblur:function(t,e){var v=this.getRawValue();this.setRawValue(v),this.setValue(v,!0)}}),Ext.reg("modx-combo-category",MODx.combo.Category),MODx.combo.Language=function(config){config=config||{},Ext.applyIf(config,{name:"language",hiddenName:"language",displayField:"name",valueField:"name",fields:["name"],typeAhead:!0,minChars:1,editable:!0,allowBlank:!0,url:MODx.config.connector_url,baseParams:{action:"system/language/getlist"}}),MODx.combo.Language.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Language,MODx.combo.ComboBox),Ext.reg("modx-combo-language",MODx.combo.Language),MODx.combo.Charset=function(config){config=config||{},Ext.applyIf(config,{name:"charset",hiddenName:"charset",displayField:"text",valueField:"value",fields:["value","text"],forceSelection:!0,typeAhead:!1,editable:!1,allowBlank:!1,url:MODx.config.connector_url,baseParams:{action:"system/charset/getlist"}}),MODx.combo.Charset.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Charset,MODx.combo.ComboBox),Ext.reg("modx-combo-charset",MODx.combo.Charset),MODx.combo.RTE=function(config){config=config||{},Ext.applyIf(config,{name:"rte",hiddenName:"rte",displayField:"value",valueField:"value",fields:["value"],forceSelection:!0,typeAhead:!1,editable:!1,allowBlank:!1,url:MODx.config.connector_url,baseParams:{action:"system/rte/getlist"}}),MODx.combo.RTE.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.RTE,MODx.combo.ComboBox),Ext.reg("modx-combo-rte",MODx.combo.RTE),MODx.combo.Role=function(config){config=config||{},Ext.applyIf(config,{name:"role",hiddenName:"role",forceSelection:!0,typeAhead:!1,editable:!1,allowBlank:!1,pageSize:20,url:MODx.config.connector_url,baseParams:{action:"security/role/getlist",addNone:!0}}),MODx.combo.Role.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Role,MODx.combo.ComboBox),Ext.reg("modx-combo-role",MODx.combo.Role),MODx.combo.ContentType=function(config){config=config||{},Ext.applyIf(config,{name:"content_type",hiddenName:"content_type",forceSelection:!0,typeAhead:!1,editable:!1,allowBlank:!1,pageSize:20,url:MODx.config.connector_url,baseParams:{action:"system/contenttype/getlist"}}),MODx.combo.ContentType.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.ContentType,MODx.combo.ComboBox),Ext.reg("modx-combo-content-type",MODx.combo.ContentType),MODx.combo.ContentDisposition=function(config){config=config||{},Ext.applyIf(config,{store:new Ext.data.SimpleStore({fields:["d","v"],data:[[_("inline"),0],[_("attachment"),1]]}),name:"content_dispo",hiddenName:"content_dispo",displayField:"d",valueField:"v",mode:"local",triggerAction:"all",editable:!1,pageSize:20,selectOnFocus:!1,preventRender:!0}),MODx.combo.ContentDisposition.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.ContentDisposition,MODx.combo.ComboBox),Ext.reg("modx-combo-content-disposition",MODx.combo.ContentDisposition),MODx.combo.ClassMap=function(config){config=config||{},Ext.applyIf(config,{name:"class",hiddenName:"class",url:MODx.config.connector_url,baseParams:{action:"system/classmap/getlist"},displayField:"class",valueField:"class",fields:["class"],editable:!1,pageSize:20}),MODx.combo.ClassMap.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.ClassMap,MODx.combo.ComboBox),Ext.reg("modx-combo-class-map",MODx.combo.ClassMap),MODx.combo.ClassDerivatives=function(config){config=config||{},Ext.applyIf(config,{name:"class",hiddenName:"class",url:MODx.config.connector_url,baseParams:{action:"system/derivatives/getList",skip:"modXMLRPCResource","class":"modResource"},displayField:"name",valueField:"id",fields:["id","name"],forceSelection:!0,typeAhead:!1,editable:!1,allowBlank:!1,pageSize:20}),MODx.combo.ClassDerivatives.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.ClassDerivatives,MODx.combo.ComboBox),Ext.reg("modx-combo-class-derivatives",MODx.combo.ClassDerivatives),MODx.combo.Object=function(config){config=config||{},Ext.applyIf(config,{name:"object",hiddenName:"object",url:MODx.config.connector_url,baseParams:{action:"workspace/builder/getAssocObject",class_key:"modResource"},displayField:"name",valueField:"id",fields:["id","name"],pageSize:10,editable:!1}),MODx.combo.Object.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Object,MODx.combo.ComboBox),Ext.reg("modx-combo-object",MODx.combo.Object),MODx.combo.Namespace=function(config){config=config||{},Ext.applyIf(config,{name:"namespace",hiddenName:"namespace",typeAhead:!0,minChars:1,queryParam:"search",editable:!0,allowBlank:!0,preselectValue:!1,pageSize:20,url:MODx.config.connector_url,baseParams:{action:"workspace/namespace/getlist"},fields:["name"],displayField:"name",valueField:"name"}),MODx.combo.Namespace.superclass.constructor.call(this,config),config.preselectValue!==!1&&(this.store.on("load",this.preselectFirstValue,this,{single:!0}),this.store.load())},Ext.extend(MODx.combo.Namespace,MODx.combo.ComboBox,{preselectFirstValue:function(r){var item;if(""==this.config.preselectValue)item=r.getAt(0);else{var found=r.find("name",this.config.preselectValue);item=-1!=found?r.getAt(found):r.getAt(0)}item&&(this.setValue(item.data.name),this.fireEvent("select",this,item))}}),Ext.reg("modx-combo-namespace",MODx.combo.Namespace),MODx.combo.Browser=function(config){config=config||{},Ext.applyIf(config,{width:400,triggerAction:"all",triggerClass:"x-form-file-trigger",source:config.source||MODx.config.default_media_source}),MODx.combo.Browser.superclass.constructor.call(this,config),this.config=config},Ext.extend(MODx.combo.Browser,Ext.form.TriggerField,{browser:null,onTriggerClick:function(btn){return this.disabled?!1:(this.browser=MODx.load({xtype:"modx-browser",closeAction:"close",id:Ext.id(),multiple:!0,source:this.config.source||MODx.config.default_media_source,hideFiles:this.config.hideFiles||!1,rootVisible:this.config.rootVisible||!1,allowedFileTypes:this.config.allowedFileTypes||"",wctx:this.config.wctx||"web",openTo:this.config.openTo||"",rootId:this.config.rootId||"/",hideSourceCombo:this.config.hideSourceCombo||!1,listeners:{select:{fn:function(data){this.setValue(data.relativeUrl),this.fireEvent("select",data)},scope:this}}}),this.browser.show(btn),!0)},onDestroy:function(){MODx.combo.Browser.superclass.onDestroy.call(this)}}),Ext.reg("modx-combo-browser",MODx.combo.Browser),MODx.combo.Country=function(config){config=config||{},Ext.applyIf(config,{name:"country",hiddenName:"country",url:MODx.config.connector_url,baseParams:{action:"system/country/getlist"},displayField:"country",valueField:"iso",fields:["iso","country","value"],editable:!0,value:0,typeAhead:!0}),MODx.combo.Country.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Country,MODx.combo.ComboBox),Ext.reg("modx-combo-country",MODx.combo.Country),MODx.combo.PropertySet=function(config){config=config||{},Ext.applyIf(config,{name:"propertyset",hiddenName:"propertyset",url:MODx.config.connector_url,baseParams:{action:"element/propertyset/getlist"},displayField:"name",valueField:"id",fields:["id","name"],editable:!1,pageSize:20,width:300}),MODx.combo.PropertySet.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.PropertySet,MODx.combo.ComboBox),Ext.reg("modx-combo-property-set",MODx.combo.PropertySet),MODx.ChangeParentField=function(config){config=config||{},Ext.applyIf(config,{triggerAction:"all",editable:!1,readOnly:!1,formpanel:"modx-panel-resource",parentcmp:"modx-resource-parent-hidden",contextcmp:"modx-resource-context-key",currentid:MODx.request.id}),MODx.ChangeParentField.superclass.constructor.call(this,config),this.config=config,this.on("click",this.onTriggerClick,this),this.addEvents({end:!0}),this.on("end",this.end,this)},Ext.extend(MODx.ChangeParentField,Ext.form.TriggerField,{oldValue:!1,oldDisplayValue:!1,end:function(p){var t=Ext.getCmp("modx-resource-tree");t&&(p.d=p.d||p.v,t.removeListener("click",this.handleChangeParent,this),t.on("click",t._handleClick,t),t.disableHref=!1,MODx.debug("Setting parent to: "+p.v),Ext.getCmp(this.config.parentcmp).setValue(p.v),this.setValue(p.d),this.oldValue=!1,Ext.getCmp(this.config.formpanel).fireEvent("fieldChange"))},onTriggerClick:function(){if(this.disabled)return!1;if(this.oldValue)return this.fireEvent("end",{v:this.oldValue,d:this.oldDisplayValue}),!1;MODx.debug("onTriggerClick");var t=Ext.getCmp("modx-resource-tree");if(!t){MODx.debug("no tree found, trying to activate");var tp=Ext.getCmp("modx-leftbar-tabpanel");return tp?(tp.on("tabchange",function(tbp,tab){"modx-resource-tree-ct"==tab.id&&this.disableTreeClick()},this),tp.activate("modx-resource-tree-ct")):MODx.debug("no tabpanel"),!1}this.disableTreeClick()},disableTreeClick:function(){return MODx.debug("Disabling tree click"),t=Ext.getCmp("modx-resource-tree"),t?(this.oldDisplayValue=this.getValue(),this.oldValue=Ext.getCmp(this.config.parentcmp).getValue(),this.setValue(_("resource_parent_select_node")),t.expand(),t.removeListener("click",t._handleClick),t.on("click",this.handleChangeParent,this),t.disableHref=!0,!0):(MODx.debug("No tree found in disableTreeClick!"),!1)},handleChangeParent:function(node,e){var t=Ext.getCmp("modx-resource-tree");if(!t)return!1;t.disableHref=!0;var id=node.id.split("_");if(id=id[1],id==this.config.currentid)return MODx.msg.alert("",_("resource_err_own_parent")),!1;var ctxf=Ext.getCmp(this.config.contextcmp);if(ctxf){var ctxv=ctxf.getValue();node.attributes&&node.attributes.ctx!=ctxv&&ctxf.setValue(node.attributes.ctx)}return this.fireEvent("end",{v:"modContext"!=node.attributes.type?id:node.attributes.pk,d:Ext.util.Format.stripTags(node.text)}),e.preventDefault(),e.stopEvent(),!0}}),Ext.reg("modx-field-parent-change",MODx.ChangeParentField),MODx.combo.TVWidget=function(config){config=config||{},Ext.applyIf(config,{name:"widget",hiddenName:"widget",displayField:"name",valueField:"value",fields:["value","name"],editable:!1,url:MODx.config.connector_url,baseParams:{action:"element/tv/renders/getOutputs"},value:"default"}),MODx.combo.TVWidget.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.TVWidget,MODx.combo.ComboBox),Ext.reg("modx-combo-tv-widget",MODx.combo.TVWidget),MODx.combo.TVInputType=function(config){config=config||{},Ext.applyIf(config,{name:"type",hiddenName:"type",displayField:"name",valueField:"value",editable:!1,fields:["value","name"],url:MODx.config.connector_url,baseParams:{action:"element/tv/renders/getInputs"},value:"text"}),MODx.combo.TVInputType.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.TVInputType,MODx.combo.ComboBox),Ext.reg("modx-combo-tv-input-type",MODx.combo.TVInputType),MODx.combo.Action=function(config){config=config||{},Ext.applyIf(config,{name:"action",hiddenName:"action",displayField:"controller",valueField:"id",fields:["id","controller","namespace"],pageSize:20,url:MODx.config.connector_url,baseParams:{action:"system/action/getlist"},tpl:new Ext.XTemplate('<tpl for="."><div class="x-combo-list-item"><tpl if="namespace">{namespace} - </tpl>{controller}</div></tpl>')}),MODx.combo.Action.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Action,MODx.combo.ComboBox),Ext.reg("modx-combo-action",MODx.combo.Action),MODx.combo.Dashboard=function(config){config=config||{},Ext.applyIf(config,{name:"dashboard",hiddenName:"dashboard",displayField:"name",valueField:"id",fields:["id","name","description"],pageSize:20,url:MODx.config.connector_url,baseParams:{action:"system/dashboard/getlist"},tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item">','<h4 class="modx-combo-title">{name}</h4>','<p class="modx-combo-desc">{description}</p>',"</div></tpl>")}),MODx.combo.Dashboard.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Dashboard,MODx.combo.ComboBox),Ext.reg("modx-combo-dashboard",MODx.combo.Dashboard),MODx.combo.MediaSource=function(config){config=config||{},Ext.applyIf(config,{name:"source",hiddenName:"source",displayField:"name",valueField:"id",fields:["id","name","description"],pageSize:20,url:MODx.config.connector_url,baseParams:{action:"source/getlist"},tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item">','<h4 class="modx-combo-title">{name}</h4>','<p class="modx-combo-desc">{description}</p>',"</div></tpl>")}),MODx.combo.MediaSource.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.MediaSource,MODx.combo.ComboBox),Ext.reg("modx-combo-source",MODx.combo.MediaSource),MODx.combo.MediaSourceType=function(config){config=config||{},Ext.applyIf(config,{name:"class_key",hiddenName:"class_key",displayField:"name",valueField:"class",fields:["id","class","name","description"],pageSize:20,url:MODx.config.connector_url,baseParams:{action:"source/type/getlist"},tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item">','<h4 class="modx-combo-title">{name}</h4>','<p class="modx-combo-desc">{description}</p>',"</div></tpl>")}),MODx.combo.MediaSourceType.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.MediaSourceType,MODx.combo.ComboBox),Ext.reg("modx-combo-source-type",MODx.combo.MediaSourceType),MODx.combo.Authority=function(config){config=config||{},Ext.applyIf(config,{name:"authority",hiddenName:"authority",forceSelection:!0,typeAhead:!1,editable:!1,allowBlank:!1,pageSize:20,url:MODx.config.connector_url,baseParams:{action:"security/role/getAuthorityList",addNone:!0}}),MODx.combo.Authority.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.Authority,MODx.combo.ComboBox),Ext.reg("modx-combo-authority",MODx.combo.Authority),MODx.combo.ManagerTheme=function(config){config=config||{},Ext.applyIf(config,{name:"theme",hiddenName:"theme",displayField:"theme",valueField:"theme",fields:["theme"],url:MODx.config.connector_url,baseParams:{action:"workspace/theme/getlist"},typeAhead:!1,editable:!1}),MODx.combo.ManagerTheme.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.ManagerTheme,MODx.combo.ComboBox),Ext.reg("modx-combo-manager-theme",MODx.combo.ManagerTheme),MODx.combo.SettingKey=function(config){config=config||{},Ext.applyIf(config,{name:"key",hiddenName:"key",displayField:"key",valueField:"key",fields:["key"],url:MODx.config.connector_url,baseParams:{action:"system/settings/getlist"},typeAhead:!1,triggerAction:"all",editable:!0,forceSelection:!1,queryParam:"key",pageSize:20}),MODx.combo.SettingKey.superclass.constructor.call(this,config)},Ext.extend(MODx.combo.SettingKey,MODx.combo.ComboBox),Ext.reg("modx-combo-setting-key",MODx.combo.SettingKey),Ext.namespace("MODx.grid"),MODx.grid.Grid=function(config){if(config=config||{},this.config=config,this._loadStore(),this._loadColumnModel(),Ext.applyIf(config,{store:this.store,cm:this.cm,sm:new Ext.grid.RowSelectionModel({singleSelect:!0}),paging:config.bbar?!0:!1,loadMask:!0,autoHeight:!0,collapsible:!0,stripeRows:!0,header:!1,cls:"modx-grid",preventRender:!0,preventSaveRefresh:!0,showPerPage:!0,stateful:!1,menuConfig:{defaultAlign:"tl-b?",enableScrolling:!1},viewConfig:{forceFit:!0,enableRowBody:!0,autoFill:!0,showPreview:!0,scrollOffset:0,emptyText:config.emptyText||_("ext_emptymsg")},groupingConfig:{enableGroupingMenu:!0}}),config.paging){var pgItms=config.showPerPage?[_("per_page")+":",{xtype:"textfield",cls:"x-tbar-page-size",value:config.pageSize||parseInt(MODx.config.default_per_page)||20,listeners:{change:{fn:this.onChangePerPage,scope:this},render:{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:this.blur,scope:cmp})},scope:this}}}]:[];if(config.pagingItems)for(var i=0;i<config.pagingItems.length;i++)pgItms.push(config.pagingItems[i]);Ext.applyIf(config,{bbar:new Ext.PagingToolbar({pageSize:config.pageSize||parseInt(MODx.config.default_per_page)||20,store:this.getStore(),displayInfo:!0,items:pgItms})})}if(config.grouping){var groupingConfig={forceFit:!0,scrollOffset:0,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "'+(config.pluralText||_("records"))+'" : "'+(config.singleText||_("record"))+'"]})'};Ext.applyIf(config.groupingConfig,groupingConfig),Ext.applyIf(config,{view:new Ext.grid.GroupingView(config.groupingConfig)})}if(config.tbar)for(var ix=0;ix<config.tbar.length;ix++){var itm=config.tbar[ix];itm.handler&&"object"==typeof itm.handler&&itm.handler.xtype&&(itm.handler=this.loadWindow.createDelegate(this,[itm.handler],!0)),itm.scope||(itm.scope=this)}MODx.grid.Grid.superclass.constructor.call(this,config),this._loadMenu(config),this.addEvents("beforeRemoveRow","afterRemoveRow","afterAutoSave"),this.autosave&&this.on("afterAutoSave",this.onAfterAutoSave,this),config.preventRender||this.render(),this.on("rowcontextmenu",this._showMenu,this),config.autosave&&this.on("afteredit",this.saveRecord,this),config.paging&&config.grouping&&this.getBottomToolbar().bind(this.store),config.paging||config.hasOwnProperty("pageSize")||(config.pageSize=0),this.getStore().load({params:{start:config.pageStart||0,limit:config.hasOwnProperty("pageSize")?config.pageSize:parseInt(MODx.config.default_per_page)||20}}),this.getStore().on("exception",this.onStoreException,this),this.config=config},Ext.extend(MODx.grid.Grid,Ext.grid.EditorGridPanel,{windows:{},onStoreException:function(dp,type,act,opt,resp){var r=Ext.decode(resp.responseText);r.message&&(this.getView().emptyText=r.message,this.getView().refresh(!1))},saveRecord:function(e){e.record.data.menu=null;var p=this.config.saveParams||{};Ext.apply(e.record.data,p);var d=Ext.util.JSON.encode(e.record.data),url=this.config.saveUrl||this.config.url||this.config.connector;MODx.Ajax.request({url:url,params:{action:this.config.save_action||"updateFromGrid",data:d},listeners:{success:{fn:function(r){this.config.save_callback&&Ext.callback(this.config.save_callback,this.config.scope||this,[r]),e.record.commit(),this.config.preventSaveRefresh||this.refresh(),this.fireEvent("afterAutoSave",r)},scope:this},failure:{fn:function(r){e.record.reject(),this.fireEvent("afterAutoSave",r)},scope:this}}})},onAfterAutoSave:function(response){if(!response.success&&""===response.message){var msg="";response.data.length&&Ext.each(response.data,function(data,index,list){msg+=(""!=msg?"<br/>":"")+data.msg},this),Ext.isEmpty(msg)&&(msg=this.autosaveErrorMsg||_("error")),MODx.msg.alert(_("error"),msg)}},onChangePerPage:function(tf,nv){return Ext.isEmpty(nv)?!1:(nv=parseInt(nv),this.getBottomToolbar().pageSize=nv,void this.store.load({params:{start:0,limit:nv}}))},loadWindow:function(btn,e,win,or){var r=this.menu.record;(!this.windows[win.xtype]||win.force)&&(Ext.applyIf(win,{record:win.blankValues?{}:r,grid:this,listeners:{success:{fn:win.success||this.refresh,scope:win.scope||this}}}),or&&Ext.apply(win,or),this.windows[win.xtype]=Ext.ComponentMgr.create(win)),this.windows[win.xtype].setValues&&win.blankValues!==!0&&void 0!=r&&this.windows[win.xtype].setValues(r),this.windows[win.xtype].show(e.target)},confirm:function(type,text){var p={action:type},k=this.config.primaryKey||"id";p[k]=this.menu.record[k],MODx.msg.confirm({title:_(type),text:_(text)||_("confirm_remove"),url:this.config.url,params:p,listeners:{success:{fn:this.refresh,scope:this}}})},remove:function(text,action){if(this.destroying)return MODx.grid.Grid.superclass.remove.apply(this,arguments);var r=this.menu.record;text=text||"confirm_remove";var p=this.config.saveParams||{};Ext.apply(p,{action:action||"remove"});var k=this.config.primaryKey||"id";p[k]=r[k],this.fireEvent("beforeRemoveRow",r)&&MODx.msg.confirm({title:_("warning"),text:_(text,r),url:this.config.url,params:p,listeners:{success:{fn:function(){this.removeActiveRow(r)},scope:this}}})},removeActiveRow:function(r){if(this.fireEvent("afterRemoveRow",r)){var rx=this.getSelectionModel().getSelected();this.getStore().remove(rx)}},_loadMenu:function(){this.menu=new Ext.menu.Menu(this.config.menuConfig)},_showMenu:function(g,ri,e){if(e.stopEvent(),e.preventDefault(),this.menu.record=this.getStore().getAt(ri).data,this.getSelectionModel().isSelected(ri)||this.getSelectionModel().selectRow(ri),this.menu.removeAll(),this.getMenu){var m=this.getMenu(g,ri,e);m&&m.length&&m.length>0&&this.addContextMenuItem(m)}(!m||m.length<=0)&&this.menu.record.menu&&this.addContextMenuItem(this.menu.record.menu),this.menu.items.length>0&&this.menu.showAt(e.xy)},_loadStore:function(){this.config.grouping?this.store=new Ext.data.GroupingStore({url:this.config.url,baseParams:this.config.baseParams||{action:this.config.action||"getList"},reader:new Ext.data.JsonReader({totalProperty:"total",root:"results",fields:this.config.fields}),sortInfo:{field:this.config.sortBy||"id",direction:this.config.sortDir||"ASC"},remoteSort:this.config.remoteSort||!1,groupField:this.config.groupBy||"name",storeId:this.config.storeId||Ext.id(),autoDestroy:!0,listeners:{load:function(){Ext.getCmp("modx-content").doLayout()}}}):this.store=new Ext.data.JsonStore({url:this.config.url,baseParams:this.config.baseParams||{action:this.config.action||"getList"},fields:this.config.fields,root:"results",totalProperty:"total",remoteSort:this.config.remoteSort||!1,storeId:this.config.storeId||Ext.id(),autoDestroy:!0,listeners:{load:function(){Ext.getCmp("modx-content").doLayout()}}})},_loadColumnModel:function(){if(this.config.columns){for(var c=this.config.columns,i=0;i<c.length;i++)if("string"==typeof c[i].editor&&(c[i].editor=eval(c[i].editor)),"string"==typeof c[i].renderer&&(c[i].renderer=eval(c[i].renderer)),"object"==typeof c[i].editor&&c[i].editor.xtype){var r=c[i].editor.renderer;Ext.isEmpty(c[i].editor.id)&&(c[i].editor.id=Ext.id()),c[i].editor=Ext.ComponentMgr.create(c[i].editor),r===!0?(c[i].editor&&c[i].editor.store&&!c[i].editor.store.isLoaded&&"local"!=c[i].editor.config.mode&&(c[i].editor.store.load(),c[i].editor.store.isLoaded=!0),c[i].renderer=Ext.util.Format.comboRenderer(c[i].editor)):"datefield"===c[i].editor.initialConfig.xtype?c[i].renderer=Ext.util.Format.dateRenderer(c[i].editor.initialConfig.format||"Y-m-d"):"boolean"===r?c[i].renderer=this.rendYesNo:"password"===r?c[i].renderer=this.rendPassword:"local"===r&&"string"==typeof c[i].renderer&&(c[i].renderer=eval(c[i].renderer))}this.cm=new Ext.grid.ColumnModel(c)}},addContextMenuItem:function(items){for(var l=items.length,i=0;l>i;i++){var options=items[i];if("-"!=options){var h=Ext.emptyFn;options.handler?(h=eval(options.handler),h&&"object"==typeof h&&h.xtype&&(h=this.loadWindow.createDelegate(this,[h],!0))):h=function(itm){var o=itm.options,id=this.menu.record.id;if(o.confirm)Ext.Msg.confirm("",o.confirm,function(e){if("yes"==e){var act=Ext.urlEncode(o.params||{action:o.action});location.href="?id="+id+"&"+act}},this);else{var act=Ext.urlEncode(o.params||{action:o.action});location.href="?id="+id+"&"+act}},this.menu.add({id:options.id||Ext.id(),text:options.text,scope:options.scope||this,options:options,handler:h})}else this.menu.add("-")}},refresh:function(){this.getStore().reload()},rendPassword:function(v){for(var z="",i=0;i<v.length;i++)z+="*";return z},rendYesNo:function(v,md){switch((1===v||"1"==v)&&(v=!0),(0===v||"0"==v)&&(v=!1),v){case!0:case"true":case 1:return md.css="green",_("yes");case!1:case"false":case"":case 0:return md.css="red",_("no")}},getSelectedAsList:function(){var sels=this.getSelectionModel().getSelections();if(sels.length<=0)return!1;for(var cs="",i=0;i<sels.length;i++)cs+=","+sels[i].data[this.config.primaryKey||"id"];
return","==cs[0]&&(cs=cs.substr(1)),cs},editorYesNo:function(r){return r=r||{},Ext.applyIf(r,{store:new Ext.data.SimpleStore({fields:["d","v"],data:[[_("yes"),!0],[_("no"),!1]]}),displayField:"d",valueField:"v",mode:"local",triggerAction:"all",editable:!1,selectOnFocus:!1}),new Ext.form.ComboBox(r)},encodeModified:function(){for(var p=this.getStore().getModifiedRecords(),rs={},i=0;i<p.length;i++)rs[p[i].data[this.config.primaryKey||"id"]]=p[i].data;return Ext.encode(rs)},encode:function(){for(var p=this.getStore().getRange(),rs={},i=0;i<p.length;i++)rs[p[i].data[this.config.primaryKey||"id"]]=p[i].data;return Ext.encode(rs)},expandAll:function(){return this.exp?(this.exp.expandAll(),this.tools.plus.hide(),this.tools.minus.show(),!0):!1},collapseAll:function(){return this.exp?(this.exp.collapseAll(),this.tools.minus.hide(),this.tools.plus.show(),!0):!1}}),MODx.grid.LocalGrid=function(config){if(config=config||{},config.grouping&&Ext.applyIf(config,{view:new Ext.grid.GroupingView({forceFit:!0,scrollOffset:0,hideGroupedColumn:config.hideGroupedColumn?!0:!1,groupTextTpl:config.groupTextTpl||'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "'+(config.pluralText||_("records"))+'" : "'+(config.singleText||_("record"))+'"]})'})}),config.tbar)for(var i=0;i<config.tbar.length;i++){var itm=config.tbar[i];itm.handler&&"object"==typeof itm.handler&&itm.handler.xtype&&(itm.handler=this.loadWindow.createDelegate(this,[itm.handler],!0)),itm.scope||(itm.scope=this)}Ext.applyIf(config,{title:"",store:this._loadStore(config),sm:new Ext.grid.RowSelectionModel({singleSelect:!1}),loadMask:!0,collapsible:!0,stripeRows:!0,enableColumnMove:!0,header:!1,cls:"modx-grid",viewConfig:{forceFit:!0,enableRowBody:!0,autoFill:!0,showPreview:!0,scrollOffset:0,emptyText:config.emptyText||_("ext_emptymsg")},menuConfig:{defaultAlign:"tl-b?",enableScrolling:!1}}),this.menu=new Ext.menu.Menu(config.menuConfig),this.config=config,this._loadColumnModel(),MODx.grid.LocalGrid.superclass.constructor.call(this,config),this.addEvents({beforeRemoveRow:!0,afterRemoveRow:!0}),this.on("rowcontextmenu",this._showMenu,this)},Ext.extend(MODx.grid.LocalGrid,Ext.grid.EditorGridPanel,{windows:{},_loadStore:function(config){return config.grouping?this.store=new Ext.data.GroupingStore({data:config.data||[],reader:new Ext.data.ArrayReader({},config.fields||[]),sortInfo:config.sortInfo||{field:config.sortBy||"name",direction:config.sortDir||"ASC"},groupField:config.groupBy||"name"}):this.store=new Ext.data.SimpleStore({fields:config.fields,data:config.data||[]}),this.store},loadWindow:function(btn,e,win,or){var r=this.menu.record;this.windows[win.xtype]||(Ext.applyIf(win,{scope:this,success:this.refresh,record:win.blankValues?{}:r}),or&&Ext.apply(win,or),this.windows[win.xtype]=Ext.ComponentMgr.create(win)),this.windows[win.xtype].setValues&&win.blankValues!==!0&&void 0!=r&&this.windows[win.xtype].setValues(r),this.windows[win.xtype].show(e.target)},_loadColumnModel:function(){if(this.config.columns){for(var c=this.config.columns,i=0;i<c.length;i++)if("string"==typeof c[i].editor&&(c[i].editor=eval(c[i].editor)),"string"==typeof c[i].renderer&&(c[i].renderer=eval(c[i].renderer)),"object"==typeof c[i].editor&&c[i].editor.xtype){var r=c[i].editor.renderer;c[i].editor=Ext.ComponentMgr.create(c[i].editor),r===!0?(c[i].editor&&c[i].editor.store&&!c[i].editor.store.isLoaded&&"local"!=c[i].editor.config.mode&&(c[i].editor.store.load(),c[i].editor.store.isLoaded=!0),c[i].renderer=Ext.util.Format.comboRenderer(c[i].editor)):"datefield"===c[i].editor.initialConfig.xtype?c[i].renderer=Ext.util.Format.dateRenderer(c[i].editor.initialConfig.format||"Y-m-d"):"boolean"===r?c[i].renderer=this.rendYesNo:"password"===r?c[i].renderer=this.rendPassword:"local"===r&&"string"==typeof c[i].renderer&&(c[i].renderer=eval(c[i].renderer))}this.cm=new Ext.grid.ColumnModel(c)}},_showMenu:function(g,ri,e){e.stopEvent(),e.preventDefault(),this.menu.recordIndex=ri,this.menu.record=this.getStore().getAt(ri).data,this.getSelectionModel().isSelected(ri)||this.getSelectionModel().selectRow(ri),this.menu.removeAll();var m=this.getMenu(g,ri);m&&(this.addContextMenuItem(m),this.menu.showAt(e.xy))},getMenu:function(){return this.menu.record.menu},addContextMenuItem:function(items){for(var l=items.length,i=0;l>i;i++){var options=items[i];if("-"!=options){var h=Ext.emptyFn;options.handler?(h=eval(options.handler),h&&"object"==typeof h&&h.xtype&&(h=this.loadWindow.createDelegate(this,[h],!0))):h=function(itm){var o=itm.options,id=this.menu.record.id,w=Ext.get("modx_content");if(o.confirm)Ext.Msg.confirm("",o.confirm,function(e){if("yes"==e){var a=Ext.urlEncode(o.params||{action:o.action}),s="?id="+id+"&"+a;null===w?location.href=s:w.dom.src=s}},this);else{var a=Ext.urlEncode(o.params||{action:o.action}),s="?id="+id+"&"+a;null===w?location.href=s:w.dom.src=s}},this.menu.add({id:options.id||Ext.id(),text:options.text,scope:this,options:options,handler:h})}else this.menu.add("-")}},remove:function(config){if(this.destroying)return MODx.grid.LocalGrid.superclass.remove.apply(this,arguments);var r=this.getSelectionModel().getSelected();this.fireEvent("beforeRemoveRow",r)&&Ext.Msg.confirm(config.title||"",config.text||"",function(e){"yes"==e&&(this.getStore().remove(r),this.fireEvent("afterRemoveRow",r))},this)},encode:function(){for(var r,s=this.getStore(),ct=s.getCount(),rs=this.config.encodeByPk?{}:[],j=0;ct>j;j++)r=s.getAt(j).data,r.menu=null,this.config.encodeAssoc?rs[r[this.config.encodeByPk||"id"]]=r:rs.push(r);return Ext.encode(rs)},expandAll:function(){return this.exp?(this.exp.expandAll(),this.tools.plus.hide(),this.tools.minus.show(),!0):!1},collapseAll:function(){return this.exp?(this.exp.collapseAll(),this.tools.minus.hide(),this.tools.plus.show(),!0):!1},rendYesNo:function(d,c){switch(d){case"":return"-";case!1:return c.css="red",_("no");case!0:return c.css="green",_("yes")}},rendPassword:function(v){for(var z="",i=0;i<v.length;i++)z+="*";return z}}),Ext.reg("grid-local",MODx.grid.LocalGrid),Ext.reg("modx-grid-local",MODx.grid.LocalGrid),Ext.ns("Ext.ux.grid"),Ext.ux.grid.RowExpander=Ext.extend(Ext.util.Observable,{expandOnEnter:!0,expandOnDblClick:!0,header:"",width:20,sortable:!1,fixed:!0,hideable:!1,menuDisabled:!0,dataIndex:"",id:"expander",lazyRender:!0,enableCaching:!0,constructor:function(config){Ext.apply(this,config),this.addEvents({beforeexpand:!0,expand:!0,beforecollapse:!0,collapse:!0}),Ext.ux.grid.RowExpander.superclass.constructor.call(this),this.tpl&&("string"==typeof this.tpl&&(this.tpl=new Ext.Template(this.tpl)),this.tpl.compile()),this.state={},this.bodyContent={}},getRowClass:function(record,rowIndex,p,ds){p.cols=p.cols-1;var content=this.bodyContent[record.id];return content||this.lazyRender||(content=this.getBodyContent(record,rowIndex)),content&&(p.body=content),this.state[record.id]?"x-grid3-row-expanded":"x-grid3-row-collapsed"},init:function(grid){this.grid=grid;var view=grid.getView();view.getRowClass=this.getRowClass.createDelegate(this),view.enableRowBody=!0,grid.on("render",this.onRender,this),grid.on("destroy",this.onDestroy,this)},onRender:function(){var grid=this.grid,mainBody=grid.getView().mainBody;mainBody.on("mousedown",this.onMouseDown,this,{delegate:".x-grid3-row-expander"}),this.expandOnEnter&&(this.keyNav=new Ext.KeyNav(this.grid.getGridEl(),{enter:this.onEnter,scope:this})),this.expandOnDblClick&&grid.on("rowdblclick",this.onRowDblClick,this)},onDestroy:function(){this.keyNav&&(this.keyNav.disable(),delete this.keyNav);var mainBody=this.grid.getView().mainBody;mainBody&&mainBody.un("mousedown",this.onMouseDown,this)},onRowDblClick:function(grid,rowIdx,e){this.toggleRow(rowIdx)},onEnter:function(e){for(var g=this.grid,sm=g.getSelectionModel(),sels=sm.getSelections(),i=0,len=sels.length;len>i;i++){var rowIdx=g.getStore().indexOf(sels[i]);this.toggleRow(rowIdx)}},getBodyContent:function(record,index){if(!this.enableCaching)return this.tpl.apply(record.data);var content=this.bodyContent[record.id];return content||(content=this.tpl.apply(record.data),this.bodyContent[record.id]=content),content},onMouseDown:function(e,t){e.stopEvent();var row=e.getTarget(".x-grid3-row");this.toggleRow(row)},renderer:function(v,p,record){return p.cellAttr='rowspan="2"','<div class="x-grid3-row-expander">&#160;</div>'},beforeExpand:function(record,body,rowIndex){return this.fireEvent("beforeexpand",this,record,body,rowIndex)!==!1?(this.tpl&&this.lazyRender&&(body.innerHTML=this.getBodyContent(record,rowIndex)),!0):!1},toggleRow:function(row){"number"==typeof row&&(row=this.grid.view.getRow(row)),this[Ext.fly(row).hasClass("x-grid3-row-collapsed")?"expandRow":"collapseRow"](row)},expandRow:function(row){"number"==typeof row&&(row=this.grid.view.getRow(row));var record=this.grid.store.getAt(row.rowIndex),body=Ext.DomQuery.selectNode("tr:nth(2) div.x-grid3-row-body",row);this.beforeExpand(record,body,row.rowIndex)&&(this.state[record.id]=!0,Ext.fly(row).replaceClass("x-grid3-row-collapsed","x-grid3-row-expanded"),this.fireEvent("expand",this,record,body,row.rowIndex))},collapseRow:function(row){"number"==typeof row&&(row=this.grid.view.getRow(row));var record=this.grid.store.getAt(row.rowIndex),body=Ext.fly(row).child("tr:nth(1) div.x-grid3-row-body",!0);this.fireEvent("beforecollapse",this,record,body,row.rowIndex)!==!1&&(this.state[record.id]=!1,Ext.fly(row).replaceClass("x-grid3-row-expanded","x-grid3-row-collapsed"),this.fireEvent("collapse",this,record,body,row.rowIndex))}}),Ext.preg("rowexpander",Ext.ux.grid.RowExpander),Ext.grid.RowExpander=Ext.ux.grid.RowExpander,Ext.ns("Ext.ux.grid"),Ext.ux.grid.CheckColumn=function(a){Ext.apply(this,a),this.id||(this.id=Ext.id()),this.renderer=this.renderer.createDelegate(this)},Ext.ux.grid.CheckColumn.prototype={init:function(b){this.grid=b,this.grid.on("render",function(){var a=this.grid.getView();a.mainBody.on("mousedown",this.onMouseDown,this)},this),this.grid.on("destroy",this.onDestroy,this)},onMouseDown:function(e,t){if(this.grid.fireEvent("rowclick"),t.className&&-1!=t.className.indexOf("x-grid3-cc-"+this.id)){e.stopEvent();var a=this.grid.getView().findRowIndex(t),b=this.grid.store.getAt(a);b.set(this.dataIndex,!b.data[this.dataIndex]),this.grid.fireEvent("afteredit")}},renderer:function(v,p,a){return p.css+=" x-grid3-check-col-td",'<div class="x-grid3-check-col'+(v?"-on":"")+" x-grid3-cc-"+this.id+'">&#160;</div>'},onDestroy:function(){var mainBody=this.grid.getView().mainBody;mainBody&&mainBody.un("mousedown",this.onMouseDown,this)}},Ext.preg("checkcolumn",Ext.ux.grid.CheckColumn),Ext.grid.CheckColumn=Ext.ux.grid.CheckColumn,Ext.grid.PropertyColumnModel=function(a,b){var g=Ext.grid,f=Ext.form;this.grid=a,g.PropertyColumnModel.superclass.constructor.call(this,[{header:this.nameText,width:50,sortable:!0,dataIndex:"name",id:"name",menuDisabled:!0},{header:this.valueText,width:50,resizable:!1,dataIndex:"value",id:"value",menuDisabled:!0}]),this.store=b;var c=new f.Field({autoCreate:{tag:"select",children:[{tag:"option",value:"true",html:"true"},{tag:"option",value:"false",html:"false"}]},getValue:function(){return"true"==this.el.dom.value}});this.editors={date:new g.GridEditor(new f.DateField({selectOnFocus:!0})),string:new g.GridEditor(new f.TextField({selectOnFocus:!0})),number:new g.GridEditor(new f.NumberField({selectOnFocus:!0,style:"text-align:left;"})),"boolean":new g.GridEditor(c)},this.renderCellDelegate=this.renderCell.createDelegate(this),this.renderPropDelegate=this.renderProp.createDelegate(this)},Ext.extend(Ext.grid.PropertyColumnModel,Ext.grid.ColumnModel,{nameText:"Name",valueText:"Value",dateFormat:"m/j/Y",renderDate:function(a){return a.dateFormat(this.dateFormat)},renderBool:function(a){return a?"true":"false"},isCellEditable:function(a,b){return 1==a},getRenderer:function(a){return 1==a?this.renderCellDelegate:this.renderPropDelegate},renderProp:function(v){return this.getPropertyName(v)},renderCell:function(a){var b=a;return Ext.isDate(a)?b=this.renderDate(a):"boolean"==typeof a&&(b=this.renderBool(a)),Ext.util.Format.htmlEncode(b)},getPropertyName:function(a){var b=this.grid.propertyNames;return b&&b[a]?b[a]:a},getCellEditor:function(a,b){var p=this.store.getProperty(b),n=p.data.name,val=p.data.value;return this.grid.customEditors[n]?this.grid.customEditors[n]:Ext.isDate(val)?this.editors.date:"number"==typeof val?this.editors.number:"boolean"==typeof val?this.editors["boolean"]:this.editors.string},destroy:function(){Ext.grid.PropertyColumnModel.superclass.destroy.call(this);for(var a in this.editors)Ext.destroy(a)}}),MODx.Console=function(config){config=config||{},Ext.Updater.defaults.showLoadIndicator=!1,Ext.applyIf(config,{title:_("console"),modal:Ext.isIE?!1:!0,closeAction:"hide",resizable:!1,collapsible:!1,closable:!0,maximizable:!0,autoScroll:!0,height:400,width:600,refreshRate:2,cls:"modx-window modx-console",items:[{itemId:"header",cls:"modx-console-text",html:_("console_running"),border:!1},{xtype:"panel",itemId:"body",cls:"x-panel-bwrap modx-console-text"}],buttons:[{text:_("console_download_output"),handler:this.download,scope:this},{text:_("ok"),cls:"primary-button",itemId:"okBtn",disabled:!0,scope:this,handler:this.hideConsole}],keys:[{key:Ext.EventObject.S,ctrl:!0,fn:this.download,scope:this},{key:Ext.EventObject.ENTER,fn:this.hideConsole,scope:this}]}),MODx.Console.superclass.constructor.call(this,config),this.config=config,this.addEvents({shutdown:!0,complete:!0}),this.on("show",this.init,this),this.on("hide",function(){if(this.provider&&this.provider.disconnect)try{this.provider.disconnect()}catch(e){}this.fireEvent("shutdown"),this.destroy()}),this.on("complete",this.onComplete,this)},Ext.extend(MODx.Console,Ext.Window,{mgr:null,running:!1,init:function(){Ext.Msg.hide(),this.fbar.setDisabled(!0),this.keyMap.setDisabled(!0),this.getComponent("body").el.dom.innerHTML="",this.provider=new Ext.direct.PollingProvider({type:"polling",url:MODx.config.connector_url,interval:1e3,baseParams:{action:"system/console",register:this.config.register||"",topic:this.config.topic||"",clear:!1,show_filename:this.config.show_filename||0,format:this.config.format||"html_log"}}),Ext.Direct.addProvider(this.provider),Ext.Direct.on("message",this.onMessage,this)},onMessage:function(e,p){var out=this.getComponent("body");out&&(out.el.insertHtml("beforeEnd",e.data),e.data="",out.el.scroll("b",out.el.getHeight(),!0)),e.complete&&this.fireEvent("complete"),delete e},onComplete:function(){if(this.provider&&this.provider.disconnect)try{this.provider.disconnect()}catch(e){}this.fbar.setDisabled(!1),this.keyMap.setDisabled(!1)},download:function(){var c=this.getComponent("body").getEl().dom.innerHTML||"&nbsp;";MODx.Ajax.request({url:MODx.config.connector_url,params:{action:"system/downloadoutput",data:c},listeners:{success:{fn:function(r){location.href=MODx.config.connector_url+"?action=system/downloadOutput&HTTP_MODAUTH="+MODx.siteId+"&download="+r.message},scope:this}}})},setRegister:function(register,topic){this.config.register=register,this.config.topic=topic},hideConsole:function(){this.hide()}}),Ext.reg("modx-console",MODx.Console),Ext.namespace("MODx.portal"),Ext.ux.Portal=Ext.extend(Ext.Panel,{layout:"column",cls:"x-portal",defaultType:"portalcolumn",initComponent:function(){Ext.ux.Portal.superclass.initComponent.call(this),this.addEvents({validatedrop:!0,beforedragover:!0,dragover:!0,beforedrop:!0,drop:!0})},initEvents:function(){Ext.ux.Portal.superclass.initEvents.call(this),this.dd=new Ext.ux.Portal.DropZone(this,this.dropConfig)},beforeDestroy:function(){this.dd&&this.dd.unreg(),Ext.ux.Portal.superclass.beforeDestroy.call(this)}}),Ext.reg("portal",Ext.ux.Portal),Ext.ux.Portal.DropZone=function(a,b){this.portal=a,Ext.dd.ScrollManager.register(a.body),Ext.ux.Portal.DropZone.superclass.constructor.call(this,a.bwrap.dom,b),a.body.ddScrollConfig=this.ddScrollConfig},Ext.extend(Ext.ux.Portal.DropZone,Ext.dd.DropTarget,{ddScrollConfig:{vthresh:50,hthresh:-1,animate:!0,increment:200},createEvent:function(a,e,b,d,c,f){return{portal:this.portal,panel:b.panel,columnIndex:d,column:c,position:f,data:b,source:a,rawEvent:e,status:this.dropAllowed}},notifyOver:function(a,e,b){var d=e.getXY(),portal=this.portal,px=a.proxy;this.grid||(this.grid=this.getGrid());var f=portal.body.dom.clientWidth;this.lastCW?this.lastCW!=f&&(this.lastCW=f,portal.doLayout(),this.grid=this.getGrid()):this.lastCW=f;for(var g=0,xs=this.grid.columnX,cmatch=!1,i=xs.length;i>g;g++)if(d[0]<xs[g].x+xs[g].w){cmatch=!0;break}cmatch||g--;for(var p,match=!1,pos=0,c=portal.items.itemAt(g),items=c.items.items,overSelf=!1,i=items.length;i>pos;pos++){p=items[pos];var h=p.el.getHeight();if(0===h)overSelf=!0;else if(p.el.getY()+h/2>d[1]){match=!0;break}}pos=(match&&p?pos:c.items.getCount())+(overSelf?-1:0);var j=this.createEvent(a,e,b,g,c,pos);return portal.fireEvent("validatedrop",j)!==!1&&portal.fireEvent("beforedragover",j)!==!1?(px.getProxy().setWidth("auto"),p?px.moveProxy(p.el.dom.parentNode,match?p.el.dom:null):px.moveProxy(c.el.dom,null),this.lastPos={c:c,col:g,p:overSelf||match&&p?pos:!1},this.scrollPos=portal.body.getScroll(),portal.fireEvent("dragover",j),j.status):j.status},notifyOut:function(){delete this.grid},notifyDrop:function(a,e,b){if(delete this.grid,this.lastPos){var c=this.lastPos.c,col=this.lastPos.col,pos=this.lastPos.p,f=this.createEvent(a,e,b,col,c,pos!==!1?pos:c.items.getCount());if(this.portal.fireEvent("validatedrop",f)!==!1&&this.portal.fireEvent("beforedrop",f)!==!1){a.proxy.getProxy().remove(),a.panel.el.dom.parentNode.removeChild(a.panel.el.dom),pos!==!1?(c==a.panel.ownerCt&&c.items.items.indexOf(a.panel)<=pos&&pos++,c.insert(pos,a.panel)):c.add(a.panel),c.doLayout(),this.portal.fireEvent("drop",f);var g=this.scrollPos.top;if(g){var d=this.portal.body.dom;setTimeout(function(){d.scrollTop=g},10)}}delete this.lastPos}},getGrid:function(){var a=this.portal.bwrap.getBox();return a.columnX=[],this.portal.items.each(function(c){a.columnX.push({x:c.el.getX(),w:c.el.getWidth()})}),a},unreg:function(){Ext.ux.Portal.DropZone.superclass.unreg.call(this)}}),MODx.portal.Column=Ext.extend(Ext.Container,{layout:"anchor",defaultType:"portlet",cls:"x-portal-column",style:"padding:10px;",columnWidth:1,defaults:{collapsible:!0,autoHeight:!0,titleCollapse:!0,draggable:!0,style:"padding: 5px 0;",bodyStyle:"padding: 15px;"}}),Ext.reg("portalcolumn",MODx.portal.Column),MODx.portal.Portlet=Ext.extend(Ext.Panel,{anchor:Ext.isSafari?"98%":"100%",frame:!0,collapsible:!0,draggable:!0,cls:"x-portlet",stateful:!1,layout:"form"}),Ext.reg("portlet",MODx.portal.Portlet),MODx.window.DuplicateResource=function(config){config=config||{},this.ident=config.ident||"dupres"+Ext.id(),Ext.applyIf(config,{title:_("duplication_options"),id:this.ident}),MODx.window.DuplicateResource.superclass.constructor.call(this,config)},Ext.extend(MODx.window.DuplicateResource,MODx.Window,{_loadForm:function(){if(this.checkIfLoaded(this.config.record))return this.fp.getForm().baseParams={action:"resource/updateduplicate",prefixDuplicate:!0,id:this.config.resource},!1;var items=[];items.push({xtype:"textfield",id:"modx-"+this.ident+"-name",fieldLabel:_("resource_name_new"),name:"name",anchor:"100%",value:""}),this.config.hasChildren&&items.push({xtype:"xcheckbox",boxLabel:_("duplicate_children"),hideLabel:!0,name:"duplicate_children",id:"modx-"+this.ident+"-duplicate-children",checked:!0,listeners:{check:{fn:function(cb,checked){checked?this.fp.getForm().findField("modx-"+this.ident+"-name").disable():this.fp.getForm().findField("modx-"+this.ident+"-name").enable()},scope:this}}});var pov=MODx.config.default_duplicate_publish_option||"preserve";items.push({xtype:"fieldset",title:_("publishing_options"),items:[{xtype:"radiogroup",hideLabel:!0,columns:1,value:pov,items:[{boxLabel:_("po_make_all_unpub"),hideLabel:!0,name:"published_mode",inputValue:"unpublish"},{boxLabel:_("po_make_all_pub"),hideLabel:!0,name:"published_mode",inputValue:"publish"},{boxLabel:_("po_preserve"),hideLabel:!0,name:"published_mode",inputValue:"preserve"}]}]}),this.fp=this.createForm({url:this.config.url||MODx.config.connector_url,baseParams:this.config.baseParams||{action:"resource/duplicate",id:this.config.resource,prefixDuplicate:!0},labelWidth:125,defaultType:"textfield",autoHeight:!0,items:items}),this.renderForm()}}),Ext.reg("modx-window-resource-duplicate",MODx.window.DuplicateResource),MODx.window.DuplicateElement=function(config){config=config||{},this.ident=config.ident||"dupeel-"+Ext.id();var flds=[{xtype:"hidden",name:"id",id:"modx-"+this.ident+"-id"},{xtype:"textfield",fieldLabel:_("element_name_new"),name:"template"==config.record.type?"templatename":"name",id:"modx-"+this.ident+"-name",anchor:"100%"}];"tv"==config.record.type&&flds.push({xtype:"xcheckbox",fieldLabel:_("element_duplicate_values"),labelSeparator:"",name:"duplicateValues",id:"modx-"+this.ident+"-duplicate-values",anchor:"100%",inputValue:1,checked:!1}),Ext.applyIf(config,{title:_("element_duplicate"),url:MODx.config.connector_url,action:"element/"+config.record.type+"/duplicate",fields:flds,labelWidth:150}),MODx.window.DuplicateElement.superclass.constructor.call(this,config)},Ext.extend(MODx.window.DuplicateElement,MODx.Window),Ext.reg("modx-window-element-duplicate",MODx.window.DuplicateElement),MODx.window.CreateCategory=function(config){config=config||{},this.ident=config.ident||"ccat"+Ext.id(),Ext.applyIf(config,{title:_("new_category"),id:this.ident,url:MODx.config.connector_url,action:"element/category/create",fields:[{fieldLabel:_("name"),name:"category",id:"modx-"+this.ident+"-category",xtype:"textfield",anchor:"100%"},{fieldLabel:_("parent"),name:"parent",hiddenName:"parent",id:"modx-"+this.ident+"-parent",xtype:"modx-combo-category",anchor:"100%"},{fieldLabel:_("rank"),name:"rank",id:"modx-"+this.ident+"-rank",xtype:"numberfield",anchor:"100%"}]}),MODx.window.CreateCategory.superclass.constructor.call(this,config)},Ext.extend(MODx.window.CreateCategory,MODx.Window),Ext.reg("modx-window-category-create",MODx.window.CreateCategory),MODx.window.RenameCategory=function(config){config=config||{},this.ident=config.ident||"rencat-"+Ext.id(),Ext.applyIf(config,{title:_("category_rename"),url:MODx.config.connector_url,action:"element/category/update",fields:[{xtype:"hidden",name:"id",id:"modx-"+this.ident+"-id",value:config.record.id},{xtype:"textfield",fieldLabel:_("name"),name:"category",id:"modx-"+this.ident+"-category",width:150,value:config.record.category,anchor:"100%"},{fieldLabel:_("rank"),name:"rank",id:"modx-"+this.ident+"-rank",xtype:"numberfield",anchor:"100%"}]}),MODx.window.RenameCategory.superclass.constructor.call(this,config)},Ext.extend(MODx.window.RenameCategory,MODx.Window),Ext.reg("modx-window-category-rename",MODx.window.RenameCategory),MODx.window.CreateNamespace=function(config){config=config||{};config.record;this.ident=config.ident||"cns"+Ext.id(),Ext.applyIf(config,{title:_("namespace_create"),id:this.ident,width:600,url:MODx.config.connector_url,action:"workspace/namespace/create",fields:[{xtype:"textfield",fieldLabel:_("name"),description:MODx.expandHelp?"":_("namespace_name_desc"),name:"name",id:"modx-"+this.ident+"-name",anchor:"100%",maxLength:100,readOnly:config.isUpdate||!1},{xtype:MODx.expandHelp?"label":"hidden",forId:"modx-"+this.ident+"-name",html:_("namespace_name_desc"),cls:"desc-under"},{xtype:"textfield",fieldLabel:_("namespace_path"),description:MODx.expandHelp?"":_("namespace_path_desc"),name:"path",id:"modx-"+this.ident+"-path",anchor:"100%"},{xtype:MODx.expandHelp?"label":"hidden",forId:"modx-"+this.ident+"-path",html:_("namespace_path_desc"),cls:"desc-under"},{xtype:"textfield",fieldLabel:_("namespace_assets_path"),description:MODx.expandHelp?"":_("namespace_assets_path_desc"),name:"assets_path",id:"modx-"+this.ident+"-assets-path",anchor:"100%"},{xtype:MODx.expandHelp?"label":"hidden",forId:"modx-"+this.ident+"-assets-path",html:_("namespace_assets_path_desc"),cls:"desc-under"}]}),MODx.window.CreateNamespace.superclass.constructor.call(this,config)},Ext.extend(MODx.window.CreateNamespace,MODx.Window),Ext.reg("modx-window-namespace-create",MODx.window.CreateNamespace),MODx.window.UpdateNamespace=function(config){config=config||{},Ext.applyIf(config,{title:_("namespace_update"),action:"workspace/namespace/update",isUpdate:!0}),MODx.window.UpdateNamespace.superclass.constructor.call(this,config)},Ext.extend(MODx.window.UpdateNamespace,MODx.window.CreateNamespace,{}),Ext.reg("modx-window-namespace-update",MODx.window.UpdateNamespace),MODx.window.QuickCreateChunk=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_create_chunk"),width:600,layout:"anchor",url:MODx.config.connector_url,action:"element/chunk/create",fields:[{xtype:"hidden",name:"id"},{xtype:"textfield",name:"name",fieldLabel:_("name"),anchor:"100%"},{xtype:"modx-combo-category",name:"category",fieldLabel:_("category"),anchor:"100%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),anchor:"100%"},{xtype:"textarea",name:"snippet",fieldLabel:_("code"),anchor:"100%",grow:!0,growMax:216},{xtype:"xcheckbox",name:"clearCache",hideLabel:!0,boxLabel:_("clear_cache_on_save"),description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreateChunk.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreateChunk,MODx.Window),Ext.reg("modx-window-quick-create-chunk",MODx.window.QuickCreateChunk),MODx.window.QuickUpdateChunk=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_update_chunk"),action:"element/chunk/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),cls:"primary-button",scope:this,handler:this.submit}]}),MODx.window.QuickUpdateChunk.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdateChunk,MODx.window.QuickCreateChunk),Ext.reg("modx-window-quick-update-chunk",MODx.window.QuickUpdateChunk),MODx.window.QuickCreateTemplate=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_create_template"),width:600,layout:"anchor",url:MODx.config.connector_url,action:"element/template/create",fields:[{xtype:"hidden",name:"id"},{xtype:"textfield",name:"templatename",fieldLabel:_("name"),anchor:"100%"},{xtype:"modx-combo-category",name:"category",fieldLabel:_("category"),anchor:"100%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),anchor:"100%"},{xtype:"textarea",name:"content",fieldLabel:_("code"),anchor:"100%",grow:!0,growMax:216},{xtype:"xcheckbox",name:"clearCache",hideLabel:!0,boxLabel:_("clear_cache_on_save"),description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreateTemplate.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreateTemplate,MODx.Window),Ext.reg("modx-window-quick-create-template",MODx.window.QuickCreateTemplate),MODx.window.QuickUpdateTemplate=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_update_template"),action:"element/template/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),cls:"primary-button",scope:this,handler:this.submit}]}),MODx.window.QuickUpdateTemplate.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdateTemplate,MODx.window.QuickCreateTemplate),Ext.reg("modx-window-quick-update-template",MODx.window.QuickUpdateTemplate),MODx.window.QuickCreateSnippet=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_create_snippet"),width:600,layout:"anchor",url:MODx.config.connector_url,action:"element/snippet/create",fields:[{xtype:"hidden",name:"id"},{xtype:"textfield",name:"name",fieldLabel:_("name"),anchor:"100%"},{xtype:"modx-combo-category",name:"category",fieldLabel:_("category"),anchor:"100%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),anchor:"100%"},{xtype:"textarea",name:"snippet",fieldLabel:_("code"),anchor:"100%",grow:!0,growMax:216},{xtype:"xcheckbox",name:"clearCache",hideLabel:!0,boxLabel:_("clear_cache_on_save"),description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreateSnippet.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreateSnippet,MODx.Window),Ext.reg("modx-window-quick-create-snippet",MODx.window.QuickCreateSnippet),MODx.window.QuickUpdateSnippet=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_update_snippet"),action:"element/snippet/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),cls:"primary-button",scope:this,handler:this.submit}]}),MODx.window.QuickUpdateSnippet.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdateSnippet,MODx.window.QuickCreateSnippet),Ext.reg("modx-window-quick-update-snippet",MODx.window.QuickUpdateSnippet),MODx.window.QuickCreatePlugin=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_create_plugin"),width:600,layout:"anchor",url:MODx.config.connector_url,action:"element/plugin/create",fields:[{xtype:"hidden",name:"id"},{xtype:"textfield",name:"name",fieldLabel:_("name"),anchor:"100%"},{xtype:"modx-combo-category",name:"category",fieldLabel:_("category"),anchor:"100%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),anchor:"100%",rows:2},{xtype:"textarea",name:"plugincode",fieldLabel:_("code"),anchor:"100%",grow:!0,growMax:216},{xtype:"xcheckbox",name:"disabled",boxLabel:_("disabled"),hideLabel:!0,inputValue:1,checked:!1},{xtype:"xcheckbox",name:"clearCache",boxLabel:_("clear_cache_on_save"),hideLabel:!0,description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreatePlugin.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreatePlugin,MODx.Window),Ext.reg("modx-window-quick-create-plugin",MODx.window.QuickCreatePlugin),MODx.window.QuickUpdatePlugin=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_update_plugin"),action:"element/plugin/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),cls:"primary-button",scope:this,handler:this.submit}]}),MODx.window.QuickUpdatePlugin.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdatePlugin,MODx.window.QuickCreatePlugin),Ext.reg("modx-window-quick-update-plugin",MODx.window.QuickUpdatePlugin),MODx.window.QuickCreateTV=function(config){config=config||{},this.ident=config.ident||"qtv"+Ext.id(),Ext.applyIf(config,{title:_("quick_create_tv"),width:700,url:MODx.config.connector_url,action:"element/tv/create",fields:[{xtype:"hidden",name:"id"},{layout:"column",border:!1,items:[{columnWidth:.6,layout:"form",items:[{xtype:"textfield",name:"name",fieldLabel:_("name"),anchor:"100%"},{xtype:"textfield",name:"caption",id:"modx-"+this.ident+"-caption",fieldLabel:_("caption"),anchor:"100%"},{xtype:"label",forId:"modx-"+this.ident+"-caption",html:_("caption_desc"),cls:"desc-under"},{xtype:"modx-combo-category",name:"category",fieldLabel:_("category"),anchor:"100%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),anchor:"100%"}]},{columnWidth:.4,border:!1,layout:"form",items:[{xtype:"modx-combo-tv-input-type",fieldLabel:_("tv_type"),
name:"type",anchor:"100%"},{xtype:"textfield",fieldLabel:_("tv_elements"),name:"els",id:"modx-"+this.ident+"-elements",anchor:"100%"},{xtype:"label",forId:"modx-"+this.ident+"-elements",html:_("tv_elements_desc"),cls:"desc-under"},{xtype:"textarea",fieldLabel:_("tv_default"),name:"default_text",id:"modx-"+this.ident+"-default-text",anchor:"100%",grow:!0,growMax:Ext.getBody().getViewSize().height<=768?300:380},{xtype:"label",forId:"modx-"+this.ident+"-default-text",html:_("tv_default_desc"),cls:"desc-under"}]}]},{xtype:"xcheckbox",name:"clearCache",hideLabel:!0,boxLabel:_("clear_cache_on_save"),description:_("clear_cache_on_save_msg"),inputValue:1,checked:!0}],keys:[{key:Ext.EventObject.ENTER,shift:!0,fn:this.submit,scope:this}]}),MODx.window.QuickCreateTV.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickCreateTV,MODx.Window),Ext.reg("modx-window-quick-create-tv",MODx.window.QuickCreateTV),MODx.window.QuickUpdateTV=function(config){config=config||{},Ext.applyIf(config,{title:_("quick_update_tv"),action:"element/tv/update",buttons:[{text:config.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide()}},{text:config.saveBtnText||_("save"),scope:this,handler:function(){this.submit(!1)}},{text:config.saveBtnText||_("save_and_close"),cls:"primary-button",scope:this,handler:this.submit}]}),MODx.window.QuickUpdateTV.superclass.constructor.call(this,config)},Ext.extend(MODx.window.QuickUpdateTV,MODx.window.QuickCreateTV),Ext.reg("modx-window-quick-update-tv",MODx.window.QuickUpdateTV),MODx.window.DuplicateContext=function(config){config=config||{},this.ident=config.ident||"dupctx"+Ext.id(),Ext.Ajax.timeout=0,Ext.applyIf(config,{title:_("context_duplicate"),id:this.ident,url:MODx.config.connector_url,action:"context/duplicate",fields:[{xtype:"statictextfield",id:"modx-"+this.ident+"-key",fieldLabel:_("old_key"),name:"key",anchor:"100%",submitValue:!0},{xtype:"textfield",id:"modx-"+this.ident+"-newkey",fieldLabel:_("new_key"),name:"newkey",anchor:"100%",value:""},{xtype:"checkbox",id:"modx-"+this.ident+"-preservealias",hideLabel:!0,boxLabel:_("preserve_alias"),name:"preserve_alias",anchor:"100%",checked:!0},{xtype:"checkbox",id:"modx-"+this.ident+"-preservemenuindex",hideLabel:!0,boxLabel:_("preserve_menuindex"),name:"preserve_menuindex",anchor:"100%",checked:!0}]}),MODx.window.DuplicateContext.superclass.constructor.call(this,config)},Ext.extend(MODx.window.DuplicateContext,MODx.Window),Ext.reg("modx-window-context-duplicate",MODx.window.DuplicateContext),MODx.window.Login=function(config){config=config||{},this.ident=config.ident||"dupctx"+Ext.id(),Ext.Ajax.timeout=0,Ext.applyIf(config,{title:_("login"),id:this.ident,url:MODx.config.connectors_url+"security/login.php",fields:[{html:"<p>"+_("session_logging_out")+"</p>",bodyCssClass:"panel-desc"},{xtype:"textfield",id:"modx-"+this.ident+"-username",fieldLabel:_("username"),name:"username",anchor:"100%"},{xtype:"textfield",inputType:"password",id:"modx-"+this.ident+"-password",fieldLabel:_("password"),name:"password",anchor:"100%"},{xtype:"hidden",name:"rememberme",value:1}],buttons:[{text:_("logout"),scope:this,handler:function(){location.href="?logout=1"}},{text:_("login"),cls:"primary-button",scope:this,handler:this.submit}]}),MODx.window.Login.superclass.constructor.call(this,config),this.on("success",this.onLogin,this)},Ext.extend(MODx.window.Login,MODx.Window,{onLogin:function(o){var r=o.a.result;r.object&&r.object.token&&(Ext.Ajax.defaultHeaders={modAuth:r.object.token},Ext.Ajax.extraParams={HTTP_MODAUTH:r.object.token},MODx.siteId=r.object.token,MODx.msg.status({message:_("session_extended")}))}}),Ext.reg("modx-window-login",MODx.window.Login),function(window){"use strict";var CanvasPrototype=window.HTMLCanvasElement&&window.HTMLCanvasElement.prototype,hasBlobConstructor=window.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),hasArrayBufferViewSupport=hasBlobConstructor&&window.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,dataURLtoBlob=(hasBlobConstructor||BlobBuilder)&&window.atob&&window.ArrayBuffer&&window.Uint8Array&&function(dataURI){var byteString,arrayBuffer,intArray,i,mimeString,bb;for(byteString=dataURI.split(",")[0].indexOf("base64")>=0?atob(dataURI.split(",")[1]):decodeURIComponent(dataURI.split(",")[1]),arrayBuffer=new ArrayBuffer(byteString.length),intArray=new Uint8Array(arrayBuffer),i=0;i<byteString.length;i+=1)intArray[i]=byteString.charCodeAt(i);return mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0],hasBlobConstructor?new Blob([hasArrayBufferViewSupport?intArray:arrayBuffer],{type:mimeString}):(bb=new BlobBuilder,bb.append(arrayBuffer),bb.getBlob(mimeString))};window.HTMLCanvasElement&&!CanvasPrototype.toBlob&&(CanvasPrototype.mozGetAsFile?CanvasPrototype.toBlob=function(callback,type,quality){callback(quality&&CanvasPrototype.toDataURL&&dataURLtoBlob?dataURLtoBlob(this.toDataURL(type,quality)):this.mozGetAsFile("blob",type))}:CanvasPrototype.toDataURL&&dataURLtoBlob&&(CanvasPrototype.toBlob=function(callback,type,quality){callback(dataURLtoBlob(this.toDataURL(type,quality)))})),window.dataURLtoBlob=dataURLtoBlob}(window),function(window,undef){"use strict";function _emit(target,fn,name,res,ext){var evt={type:name.type||name,target:target,result:res};_extend(evt,ext),fn(evt)}function _hasSupportReadAs(as){return FileReader&&!!FileReader.prototype["readAs"+as]}function _readAs(file,fn,as,encoding){if(api.isFile(file)&&_hasSupportReadAs(as)){var Reader=new FileReader;_on(Reader,_readerEvents,function _fn(evt){var type=evt.type;"progress"==type?_emit(file,fn,evt,evt.target.result,{loaded:evt.loaded,total:evt.total}):"loadend"==type?(_off(Reader,_readerEvents,_fn),Reader=null):_emit(file,fn,evt,evt.target.result)});try{encoding?Reader["readAs"+as](file,encoding):Reader["readAs"+as](file)}catch(err){_emit(file,fn,"error",undef,{error:err.toString()})}}else _emit(file,fn,"error",undef,{error:"filreader_not_support_"+as})}function _isRegularFile(file,callback){if(!file.type&&file.size%4096===0&&file.size<=102400)if(FileReader)try{var Reader=new FileReader;_one(Reader,_readerEvents,function(evt){var isFile="error"!=evt.type;callback(isFile),isFile&&Reader.abort()}),Reader.readAsDataURL(file)}catch(err){callback(!1)}else callback(null);else callback(!0)}function _getAsEntry(item){var entry;return item.getAsEntry?entry=item.getAsEntry():item.webkitGetAsEntry&&(entry=item.webkitGetAsEntry()),entry}function _readEntryAsFiles(entry,callback){if(entry)if(entry.isFile)entry.file(function(file){file.fullPath=entry.fullPath,callback(!1,[file])},function(err){callback("FileError.code: "+err.code)});else if(entry.isDirectory){var reader=entry.createReader(),result=[];reader.readEntries(function(entries){api.afor(entries,function(next,entry){_readEntryAsFiles(entry,function(err,files){err?api.log(err):result=result.concat(files),next?next():callback(!1,result)})})},function(err){callback("directory_reader: "+err)})}else _readEntryAsFiles(_getAsEntry(entry),callback);else callback("invalid entry")}function _simpleClone(obj){var copy={};return _each(obj,function(val,key){val&&"object"==typeof val&&void 0===val.nodeType&&(val=_extend({},val)),copy[key]=val}),copy}function isInputFile(el){return _rinput.test(el&&el.tagName)}function _getDataTransfer(evt){return(evt.originalEvent||evt||"").dataTransfer||{}}function _isOriginTransform(trans){var key;for(key in trans)if(trans.hasOwnProperty(key)&&!(trans[key]instanceof Object||"overlay"===key||"filter"===key))return!0;return!1}var gid=1,noop=function(){},document=window.document,doctype=document.doctype||{},userAgent=window.navigator.userAgent,apiURL=window.createObjectURL&&window||window.URL&&URL.revokeObjectURL&&URL||window.webkitURL&&webkitURL,Blob=window.Blob,File=window.File,FileReader=window.FileReader,FormData=window.FormData,XMLHttpRequest=window.XMLHttpRequest,jQuery=window.jQuery,html5=!(!(File&&FileReader&&(window.Uint8Array||FormData||XMLHttpRequest.prototype.sendAsBinary))||/safari\//i.test(userAgent)&&!/chrome\//i.test(userAgent)&&/windows/i.test(userAgent)),cors=html5&&"withCredentials"in new XMLHttpRequest,chunked=html5&&!!Blob&&!!(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice),dataURLtoBlob=window.dataURLtoBlob,_rimg=/img/i,_rcanvas=/canvas/i,_rimgcanvas=/img|canvas/i,_rinput=/input/i,_rdata=/^data:[^,]+,/,Math=window.Math,_SIZE_CONST=function(pow){return pow=new window.Number(Math.pow(1024,pow)),pow.from=function(sz){return Math.round(sz*this)},pow},_elEvents={},_infoReader=[],_readerEvents="abort progress error load loadend",_xhrPropsExport="status statusText readyState response responseXML responseText responseBody".split(" "),currentTarget="currentTarget",preventDefault="preventDefault",_isArray=function(ar){return ar&&"length"in ar},_each=function(obj,fn,ctx){if(obj)if(_isArray(obj))for(var i=0,n=obj.length;n>i;i++)i in obj&&fn.call(ctx,obj[i],i,obj);else for(var key in obj)obj.hasOwnProperty(key)&&fn.call(ctx,obj[key],key,obj)},_extend=function(dst){for(var args=arguments,i=1,_ext=function(val,key){dst[key]=val};i<args.length;i++)_each(args[i],_ext);return dst},_on=function(el,type,fn){if(el){var uid=api.uid(el);_elEvents[uid]||(_elEvents[uid]={}),_each(type.split(/\s+/),function(type){jQuery?jQuery.event.add(el,type,fn):(_elEvents[uid][type]||(_elEvents[uid][type]=[]),_elEvents[uid][type].push(fn),el.addEventListener?el.addEventListener(type,fn,!1):el.attachEvent?el.attachEvent("on"+type,fn):el["on"+type]=fn)})}},_off=function(el,type,fn){if(el){var uid=api.uid(el),events=_elEvents[uid]||{};_each(type.split(/\s+/),function(type){if(jQuery)jQuery.event.remove(el,type,fn);else{for(var fns=events[type]||[],i=fns.length;i--;)if(fns[i]===fn){fns.splice(i,1);break}el.removeEventListener?el.removeEventListener(type,fn,!1):el.detachEvent?el.detachEvent("on"+type,fn):el["on"+type]=null}})}},_one=function(el,type,fn){_on(el,type,function _(evt){_off(el,type,_),fn(evt)})},_fixEvent=function(evt){return evt.target||(evt.target=window.event&&window.event.srcElement||document),3===evt.target.nodeType&&(evt.target=evt.target.parentNode),evt},_supportInputAttr=function(attr){var input=document.createElement("input");return input.setAttribute("type","file"),attr in input},api={version:"2.0.3",cors:!1,html5:!0,media:!1,formData:!0,debug:!1,pingUrl:!1,multiFlash:!1,flashAbortTimeout:0,withCredentials:!0,staticPath:"./dist/",flashUrl:0,flashImageUrl:0,postNameConcat:function(name,idx){return name+(null!=idx?"["+idx+"]":"")},ext2mime:{jpg:"image/jpeg",tif:"image/tiff",txt:"text/plain"},accept:{"image/*":"art bm bmp dwg dxf cbr cbz fif fpx gif ico iefs jfif jpe jpeg jpg jps jut mcf nap nif pbm pcx pgm pict pm png pnm qif qtif ras rast rf rp svf tga tif tiff xbm xbm xpm xwd","audio/*":"m4a flac aac rm mpa wav wma ogg mp3 mp2 m3u mod amf dmf dsm far gdm imf it m15 med okt s3m stm sfx ult uni xm sid ac3 dts cue aif aiff wpl ape mac mpc mpp shn wv nsf spc gym adplug adx dsp adp ymf ast afc hps xs","video/*":"m4v 3gp nsv ts ty strm rm rmvb m3u ifo mov qt divx xvid bivx vob nrg img iso pva wmv asf asx ogm m2v avi bin dat dvr-ms mpg mpeg mp4 mkv avc vp3 svq3 nuv viv dv fli flv wpl"},chunkSize:0,chunkUploadRetry:0,chunkNetworkDownRetryTimeout:2e3,KB:_SIZE_CONST(1),MB:_SIZE_CONST(2),GB:_SIZE_CONST(3),TB:_SIZE_CONST(4),expando:"fileapi"+(new Date).getTime(),uid:function(obj){return obj?obj[api.expando]=obj[api.expando]||api.uid():(++gid,api.expando+gid)},log:function(){api.debug&&window.console&&console.log&&(console.log.apply?console.log.apply(console,arguments):console.log([].join.call(arguments," ")))},newImage:function(src,fn){var img=document.createElement("img");return fn&&api.event.one(img,"error load",function(evt){fn("error"==evt.type,img),img=null}),img.src=src,img},getXHR:function(){var xhr;if(XMLHttpRequest)xhr=new XMLHttpRequest;else if(window.ActiveXObject)try{xhr=new ActiveXObject("MSXML2.XMLHttp.3.0")}catch(e){xhr=new ActiveXObject("Microsoft.XMLHTTP")}return xhr},isArray:_isArray,support:{dnd:cors&&"ondrop"in document.createElement("div"),cors:cors,html5:html5,chunked:chunked,dataURI:!0,accept:_supportInputAttr("accept"),multiple:_supportInputAttr("multiple")},event:{on:_on,off:_off,one:_one,fix:_fixEvent},throttle:function(fn,delay){var id,args;return function(){args=arguments,id||(fn.apply(window,args),id=setTimeout(function(){id=0,fn.apply(window,args)},delay))}},F:function(){},parseJSON:function(str){var json;return json=window.JSON&&JSON.parse?JSON.parse(str):new Function("return ("+str.replace(/([\r\n])/g,"\\$1")+");")()},trim:function(str){return str=String(str),str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")},defer:function(){var result,error,list=[],defer={resolve:function(err,res){for(defer.resolve=noop,error=err||!1,result=res;res=list.shift();)res(error,result)},then:function(fn){error!==undef?fn(error,result):list.push(fn)}};return defer},queue:function(fn){var _idx=0,_length=0,_fail=!1,_end=!1,queue={inc:function(){_length++},next:function(){_idx++,setTimeout(queue.check,0)},check:function(){_idx>=_length&&!_fail&&queue.end()},isFail:function(){return _fail},fail:function(){!_fail&&fn(_fail=!0)},end:function(){_end||(_end=!0,fn())}};return queue},each:_each,afor:function(array,callback){var i=0,n=array.length;_isArray(array)&&n--?!function _next(){callback(n!=i&&_next,array[i],i++)}():callback(!1)},extend:_extend,isFile:function(file){return html5&&file&&file instanceof File},isCanvas:function(el){return el&&_rcanvas.test(el.nodeName)},getFilesFilter:function(filter){return filter="string"==typeof filter?filter:filter.getAttribute&&filter.getAttribute("accept")||"",filter?new RegExp("("+filter.replace(/\./g,"\\.").replace(/,/g,"|")+")$","i"):/./},readAsDataURL:function(file,fn){api.isCanvas(file)?_emit(file,fn,"load",api.toDataURL(file)):_readAs(file,fn,"DataURL")},readAsBinaryString:function(file,fn){_hasSupportReadAs("BinaryString")?_readAs(file,fn,"BinaryString"):_readAs(file,function(evt){if("load"==evt.type)try{evt.result=api.toBinaryString(evt.result)}catch(e){evt.type="error",evt.message=e.toString()}fn(evt)},"DataURL")},readAsArrayBuffer:function(file,fn){_readAs(file,fn,"ArrayBuffer")},readAsText:function(file,encoding,fn){fn||(fn=encoding,encoding="utf-8"),_readAs(file,fn,"Text",encoding)},toDataURL:function(el,type){return"string"==typeof el?el:el.toDataURL?el.toDataURL(type||"image/png"):void 0},toBinaryString:function(val){return window.atob(api.toDataURL(val).replace(_rdata,""))},readAsImage:function(file,fn,progress){if(api.isFile(file))if(apiURL){var data=apiURL.createObjectURL(file);data===undef?_emit(file,fn,"error"):api.readAsImage(data,fn,progress)}else api.readAsDataURL(file,function(evt){"load"==evt.type?api.readAsImage(evt.result,fn,progress):(progress||"error"==evt.type)&&_emit(file,fn,evt,null,{loaded:evt.loaded,total:evt.total})});else if(api.isCanvas(file))_emit(file,fn,"load",file);else if(_rimg.test(file.nodeName))if(file.complete)_emit(file,fn,"load",file);else{var events="error abort load";_one(file,events,function _fn(evt){"load"==evt.type&&apiURL&&apiURL.revokeObjectURL(file.src),_off(file,events,_fn),_emit(file,fn,evt,file)})}else if(file.iframe)_emit(file,fn,{type:"error"});else{var img=api.newImage(file.dataURL||file);api.readAsImage(img,fn,progress)}},checkFileObj:function(name){var file={},accept=api.accept;return"object"==typeof name?file=name:file.name=(name+"").split(/\\|\//g).pop(),null==file.type&&(file.type=file.name.split(".").pop()),_each(accept,function(ext,type){ext=new RegExp(ext.replace(/\s/g,"|"),"i"),(ext.test(file.type)||api.ext2mime[file.type])&&(file.type=api.ext2mime[file.type]||type.split("/")[0]+"/"+file.type)}),file},getDropFiles:function(evt,callback){var files=[],dataTransfer=_getDataTransfer(evt),entrySupport=_isArray(dataTransfer.items)&&dataTransfer.items[0]&&_getAsEntry(dataTransfer.items[0]),queue=api.queue(function(){callback(files)});_each((entrySupport?dataTransfer.items:dataTransfer.files)||[],function(item){queue.inc();try{entrySupport?_readEntryAsFiles(item,function(err,entryFiles){err?api.log("[err] getDropFiles:",err):files.push.apply(files,entryFiles),queue.next()}):_isRegularFile(item,function(yes){yes&&files.push(item),queue.next()})}catch(err){queue.next(),api.log("[err] getDropFiles: ",err)}}),queue.check()},getFiles:function(input,filter,callback){var files=[];return callback?(api.filterFiles(api.getFiles(input),filter,callback),null):(input.jquery&&(input.each(function(){files=files.concat(api.getFiles(this))}),input=files,files=[]),"string"==typeof filter&&(filter=api.getFilesFilter(filter)),input.originalEvent?input=_fixEvent(input.originalEvent):input.srcElement&&(input=_fixEvent(input)),input.dataTransfer?input=input.dataTransfer:input.target&&(input=input.target),input.files?(files=input.files,html5||(files[0].blob=input,files[0].iframe=!0)):!html5&&isInputFile(input)?api.trim(input.value)&&(files=[api.checkFileObj(input.value)],files[0].blob=input,files[0].iframe=!0):_isArray(input)&&(files=input),api.filter(files,function(file){return!filter||filter.test(file.name)}))},getTotalSize:function(files){for(var size=0,i=files&&files.length;i--;)size+=files[i].size;return size},getInfo:function(file,fn){var info={},readers=_infoReader.concat();api.isFile(file)?!function _next(){var reader=readers.shift();reader?reader.test(file.type)?reader(file,function(err,res){err?fn(err):(_extend(info,res),_next())}):_next():fn(!1,info)}():fn("not_support_info",info)},addInfoReader:function(mime,fn){fn.test=function(type){return mime.test(type)},_infoReader.push(fn)},filter:function(input,fn){for(var val,result=[],i=0,n=input.length;n>i;i++)i in input&&(val=input[i],fn.call(val,val,i,input)&&result.push(val));return result},filterFiles:function(files,eachFn,resultFn){if(files.length){var file,queue=files.concat(),result=[],deleted=[];!function _next(){queue.length?(file=queue.shift(),api.getInfo(file,function(err,info){(eachFn(file,err?!1:info)?result:deleted).push(file),_next()})):resultFn(result,deleted)}()}else resultFn([],files)},upload:function(options){options=_extend({jsonp:"callback",prepare:api.F,beforeupload:api.F,upload:api.F,fileupload:api.F,fileprogress:api.F,filecomplete:api.F,progress:api.F,complete:api.F,pause:api.F,imageOriginal:!0,chunkSize:api.chunkSize,chunkUpoloadRetry:api.chunkUploadRetry},options),options.imageAutoOrientation&&!options.imageTransform&&(options.imageTransform={rotate:"auto"});var _nextFile,proxyXHR=new api.XHR(options),dataArray=this._getFilesDataArray(options.files),_this=this,_total=0,_loaded=0,_complete=!1;return _each(dataArray,function(data){_total+=data.size}),proxyXHR.files=[],_each(dataArray,function(data){proxyXHR.files.push(data.file)}),proxyXHR.total=_total,proxyXHR.loaded=0,proxyXHR.filesLeft=dataArray.length,options.beforeupload(proxyXHR,options),_nextFile=function(){var data=dataArray.shift(),_file=data&&data.file,_fileLoaded=!1,_fileOptions=_simpleClone(options);proxyXHR.filesLeft=dataArray.length,_file&&_file.name===api.expando&&(_file=null,api.log("[warn] FileAPI.upload()  called without files")),("abort"!=proxyXHR.statusText||proxyXHR.current)&&data?(_complete=!1,proxyXHR.currentFile=_file,_file&&options.prepare(_file,_fileOptions),_this._getFormData(_fileOptions,data,function(form){_loaded||options.upload(proxyXHR,options);var xhr=new api.XHR(_extend({},_fileOptions,{upload:_file?function(){options.fileupload(_file,xhr,_fileOptions)}:noop,progress:_file?function(evt){_fileLoaded||(_fileLoaded=evt.loaded===evt.total,options.fileprogress({type:"progress",total:data.total=evt.total,loaded:data.loaded=evt.loaded},_file,xhr,_fileOptions),options.progress({type:"progress",total:_total,loaded:proxyXHR.loaded=_loaded+data.size*(evt.loaded/evt.total)|0},_file,xhr,_fileOptions))}:noop,complete:function(err){_each(_xhrPropsExport,function(name){proxyXHR[name]=xhr[name]}),_file&&(data.total=data.total||data.size,data.loaded=data.total,this.progress(data),_fileLoaded=!0,_loaded+=data.size,proxyXHR.loaded=_loaded,options.filecomplete(err,xhr,_file,_fileOptions)),_nextFile.call(_this)}}));proxyXHR.abort=function(current){current||(dataArray.length=0),this.current=current,xhr.abort()},xhr.send(form)})):(options.complete(200==proxyXHR.status||201==proxyXHR.status?!1:proxyXHR.statusText||"error",proxyXHR,options),_complete=!0)},setTimeout(_nextFile,0),proxyXHR.append=function(files,first){files=api._getFilesDataArray([].concat(files)),_each(files,function(data){_total+=data.size,proxyXHR.files.push(data.file),first?dataArray.unshift(data):dataArray.push(data)}),proxyXHR.statusText="",_complete&&_nextFile.call(_this)},proxyXHR.remove=function(file){for(var _file,i=dataArray.length;i--;)dataArray[i].file==file&&(_file=dataArray.splice(i,1),_total-=_file.size);return _file},proxyXHR},_getFilesDataArray:function(data){var files=[],oFiles={};if(isInputFile(data)){var tmp=api.getFiles(data);oFiles[data.name||"file"]=null!==data.getAttribute("multiple")?tmp:tmp[0]}else _isArray(data)&&isInputFile(data[0])?_each(data,function(input){oFiles[input.name||"file"]=api.getFiles(input)}):oFiles=data;return _each(oFiles,function add(file,name){_isArray(file)?_each(file,function(file){add(file,name)}):file&&(file.name||file.image)&&files.push({name:name,file:file,size:file.size,total:file.size,loaded:0})}),files.length||files.push({file:{name:api.expando}}),files},_getFormData:function(options,data,fn){var file=data.file,name=data.name,filename=file.name,filetype=file.type,trans=api.support.transform&&options.imageTransform,Form=new api.Form,queue=api.queue(function(){fn(Form)}),isOrignTrans=trans&&_isOriginTransform(trans),postNameConcat=api.postNameConcat;!function _addFile(file){file.image?(queue.inc(),file.toData(function(err,image){filename=filename||(new Date).getTime()+".png",_addFile(image),queue.next()})):api.Image&&trans&&(/^image/.test(file.type)||_rimgcanvas.test(file.nodeName))?(queue.inc(),isOrignTrans&&(trans=[trans]),api.Image.transform(file,trans,options.imageAutoOrientation,function(err,images){if(isOrignTrans&&!err)dataURLtoBlob||api.flashEngine||(Form.multipart=!0),Form.append(name,images[0],filename,trans[0].type||filetype);else{var addOrigin=0;err||_each(images,function(image,idx){dataURLtoBlob||api.flashEngine||(Form.multipart=!0),trans[idx].postName||(addOrigin=1),Form.append(trans[idx].postName||postNameConcat(name,idx),image,filename,trans[idx].type||filetype)}),(err||options.imageOriginal)&&Form.append(postNameConcat(name,addOrigin?"original":null),file,filename,filetype)}queue.next()})):filename!==api.expando&&Form.append(name,file,filename)}(file),_each(options.data,function add(val,name){"object"==typeof val?_each(val,function(v,i){add(v,postNameConcat(name,i))}):Form.append(name,val)}),queue.check()},reset:function(inp,notRemove){var parent,clone;return jQuery?(clone=jQuery(inp).clone(!0).insertBefore(inp).val("")[0],notRemove||jQuery(inp).remove()):(parent=inp.parentNode,clone=parent.insertBefore(inp.cloneNode(!0),inp),clone.value="",notRemove||parent.removeChild(inp),_each(_elEvents[api.uid(inp)],function(fns,type){_each(fns,function(fn){_off(inp,type,fn),_on(clone,type,fn)})})),clone},load:function(url,fn){var xhr=api.getXHR();return xhr?(xhr.open("GET",url,!0),xhr.overrideMimeType&&xhr.overrideMimeType("text/plain; charset=x-user-defined"),_on(xhr,"progress",function(evt){evt.lengthComputable&&fn({type:evt.type,loaded:evt.loaded,total:evt.total},xhr)}),xhr.onreadystatechange=function(){if(4==xhr.readyState)if(xhr.onreadystatechange=null,200==xhr.status){url=url.split("/");var file={name:url[url.length-1],size:xhr.getResponseHeader("Content-Length"),type:xhr.getResponseHeader("Content-Type")};file.dataURL="data:"+file.type+";base64,"+api.encode64(xhr.responseBody||xhr.responseText),fn({type:"load",result:file},xhr)}else fn({type:"error"},xhr)},xhr.send(null)):fn({type:"error"}),xhr},encode64:function(str){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",outStr="",i=0;for("string"!=typeof str&&(str=String(str));i<str.length;){var enc3,enc4,byte1=255&str.charCodeAt(i++),byte2=255&str.charCodeAt(i++),byte3=255&str.charCodeAt(i++),enc1=byte1>>2,enc2=(3&byte1)<<4|byte2>>4;isNaN(byte2)?enc3=enc4=64:(enc3=(15&byte2)<<2|byte3>>6,enc4=isNaN(byte3)?64:63&byte3),outStr+=b64.charAt(enc1)+b64.charAt(enc2)+b64.charAt(enc3)+b64.charAt(enc4)}return outStr}};api.addInfoReader(/^image/,function(file,callback){if(!file.__dimensions){var defer=file.__dimensions=api.defer();api.readAsImage(file,function(evt){var img=evt.target;defer.resolve("load"==evt.type?!1:"error",{width:img.width,height:img.height}),img=null})}file.__dimensions.then(callback)}),api.event.dnd=function(el,onHover,onDrop){var _id,_type;onDrop||(onDrop=onHover,onHover=api.F),FileReader?(_on(el,"dragenter dragleave dragover",function(evt){for(var types=_getDataTransfer(evt).types,i=types&&types.length,debounceTrigger=!1;i--;)if(~types[i].indexOf("File")){evt[preventDefault](),_type!==evt.type&&(_type=evt.type,"dragleave"!=_type&&onHover.call(evt[currentTarget],!0,evt),debounceTrigger=!0);break}debounceTrigger&&(clearTimeout(_id),_id=setTimeout(function(){onHover.call(evt[currentTarget],"dragleave"!=_type,evt)},50))}),_on(el,"drop",function(evt){evt[preventDefault](),_type=0,onHover.call(evt[currentTarget],!1,evt),api.getDropFiles(evt,function(files){onDrop.call(evt[currentTarget],files,evt)})})):api.log("Drag'n'Drop -- not supported")},api.event.dnd.off=function(el,onHover,onDrop){_off(el,"dragenter dragleave dragover",onHover),_off(el,"drop",onDrop)},jQuery&&!jQuery.fn.dnd&&(jQuery.fn.dnd=function(onHover,onDrop){return this.each(function(){api.event.dnd(this,onHover,onDrop)})},jQuery.fn.offdnd=function(onHover,onDrop){return this.each(function(){api.event.dnd.off(this,onHover,onDrop)})}),window.FileAPI=_extend(api,window.FileAPI),api.log("FileAPI: "+api.version),api.log("protocol: "+window.location.protocol),api.log("doctype: ["+doctype.name+"] "+doctype.publicId+" "+doctype.systemId),_each(document.getElementsByTagName("meta"),function(meta){/x-ua-compatible/i.test(meta.getAttribute("http-equiv"))&&api.log("meta.http-equiv: "+meta.getAttribute("content"))}),api.flashUrl||(api.flashUrl=api.staticPath+"FileAPI.flash.swf"),api.flashImageUrl||(api.flashImageUrl=api.staticPath+"FileAPI.flash.image.swf"),api.flashWebcamUrl||(api.flashWebcamUrl=api.staticPath+"FileAPI.flash.camera.swf")}(window,void 0),function(api,document,undef){"use strict";function Image(file){if(file instanceof Image){var img=new Image(file.file);return api.extend(img.matrix,file.matrix),img}return this instanceof Image?(this.file=file,this.size=file.size||100,void(this.matrix={sx:0,sy:0,sw:0,sh:0,dx:0,dy:0,dw:0,dh:0,resize:0,deg:0,quality:1,filter:0})):new Image(file)}var min=Math.min,round=Math.round,getCanvas=function(){return document.createElement("canvas")},support=!1,exifOrientation={8:270,3:180,6:90};try{support=getCanvas().toDataURL("image/png").indexOf("data:image/png")>-1}catch(e){}Image.prototype={image:!0,constructor:Image,set:function(attrs){return api.extend(this.matrix,attrs),this},crop:function(x,y,w,h){return w===undef&&(w=x,h=y,x=y=0),this.set({sx:x,sy:y,sw:w,sh:h||w})},resize:function(w,h,strategy){return/min|max/.test(h)&&(strategy=h,h=w),this.set({dw:w,dh:h||w,resize:strategy})},preview:function(w,h){return this.resize(w,h||w,"preview")},rotate:function(deg){return this.set({deg:deg})},filter:function(filter){return this.set({filter:filter})},overlay:function(images){return this.set({overlay:images})},clone:function(){return new Image(this)},_load:function(image,fn){var self=this;/img|video/i.test(image.nodeName)?fn.call(self,null,image):api.readAsImage(image,function(evt){fn.call(self,"load"!=evt.type,evt.result)})},_apply:function(image,fn){var copy,canvas=getCanvas(),m=this.getMatrix(image),ctx=canvas.getContext("2d"),width=image.videoWidth||image.width,height=image.videoHeight||image.height,deg=m.deg,dw=m.dw,dh=m.dh,w=width,h=height,filter=m.filter,buffer=image,overlay=m.overlay,queue=api.queue(function(){fn(!1,canvas)}),renderImageToCanvas=api.renderImageToCanvas;for(image._type=this.file.type;min(w/dw,h/dh)>2;)w=w/2+.5|0,h=h/2+.5|0,copy=getCanvas(),copy.width=w,copy.height=h,buffer!==image?(renderImageToCanvas(copy,buffer,0,0,buffer.width,buffer.height,0,0,w,h),buffer=copy):(buffer=copy,renderImageToCanvas(buffer,image,m.sx,m.sy,m.sw,m.sh,0,0,w,h),m.sx=m.sy=m.sw=m.sh=0);canvas.width=deg%180?dh:dw,canvas.height=deg%180?dw:dh,canvas.type=m.type,canvas.quality=m.quality,ctx.rotate(deg*Math.PI/180),renderImageToCanvas(canvas,buffer,m.sx,m.sy,m.sw||buffer.width,m.sh||buffer.height,180==deg||270==deg?-dw:0,90==deg||180==deg?-dh:0,dw,dh),dw=canvas.width,dh=canvas.height,overlay&&api.each([].concat(overlay),function(over){queue.inc();var img=new window.Image,fn=function(){var x=0|over.x,y=0|over.y,w=over.w||img.width,h=over.h||img.height,rel=over.rel;x=1==rel||4==rel||7==rel?(dw-w+x)/2:2==rel||5==rel||8==rel?dw-(w+x):x,y=3==rel||4==rel||5==rel?(dh-h+y)/2:rel>=6?dh-(h+y):y,api.event.off(img,"error load abort",fn);try{ctx.globalAlpha=over.opacity||1,ctx.drawImage(img,x,y,w,h)}catch(er){}queue.next()};api.event.on(img,"error load abort",fn),img.src=over.src,img.complete&&fn()}),filter&&(queue.inc(),Image.applyFilter(canvas,filter,queue.next)),queue.check()},getMatrix:function(image){var m=api.extend({},this.matrix),sw=m.sw=m.sw||image.videoWidth||image.naturalWidth||image.width,sh=m.sh=m.sh||image.videoHeight||image.naturalHeight||image.height,dw=m.dw=m.dw||sw,dh=m.dh=m.dh||sh,sf=sw/sh,df=dw/dh,strategy=m.resize;if("preview"==strategy){if(dw!=sw||dh!=sh){var w,h;df>=sf?(w=sw,h=w/df):(h=sh,w=h*df),(w!=sw||h!=sh)&&(m.sx=~~((sw-w)/2),m.sy=~~((sh-h)/2),sw=w,sh=h)}}else strategy&&(sw>dw||sh>dh?"min"==strategy?(dw=round(df>sf?min(sw,dw):dh*sf),dh=round(df>sf?dw/sf:min(sh,dh))):(dw=round(sf>=df?min(sw,dw):dh*sf),dh=round(sf>=df?dw/sf:min(sh,dh))):(dw=sw,dh=sh));return m.sw=sw,m.sh=sh,m.dw=dw,m.dh=dh,m},_trans:function(fn){this._load(this.file,function(err,image){if(err)fn(err);else try{this._apply(image,fn)}catch(err){api.log("[err] FileAPI.Image.fn._apply:",err),fn(err)}})},get:function(fn){if(api.support.transform){var _this=this,matrix=_this.matrix;"auto"==matrix.deg?api.getInfo(_this.file,function(err,info){matrix.deg=exifOrientation[info&&info.exif&&info.exif.Orientation]||0,_this._trans(fn)}):_this._trans(fn)}else fn("not_support_transform");return this},toData:function(fn){return this.get(fn)}},Image.exifOrientation=exifOrientation,Image.transform=function(file,transform,autoOrientation,fn){function _transform(err,img){var images={},queue=api.queue(function(err){fn(err,images)});err?queue.fail():api.each(transform,function(params,name){if(!queue.isFail()){var ImgTrans=new Image(img.nodeType?img:file);if("function"==typeof params?params(img,ImgTrans):params.width?ImgTrans[params.preview?"preview":"resize"](params.width,params.height,params.strategy):params.maxWidth&&(img.width>params.maxWidth||img.height>params.maxHeight)&&ImgTrans.resize(params.maxWidth,params.maxHeight,"max"),params.crop){var crop=params.crop;ImgTrans.crop(0|crop.x,0|crop.y,crop.w||crop.width,crop.h||crop.height)}params.rotate===undef&&autoOrientation&&(params.rotate="auto"),ImgTrans.set({deg:params.rotate,type:params.type||file.type||"image/png",quality:params.quality||1,overlay:params.overlay,filter:params.filter}),queue.inc(),ImgTrans.toData(function(err,image){err?queue.fail():(images[name]=image,queue.next())})}})}file.width?_transform(!1,file):api.getInfo(file,_transform)},api.each(["TOP","CENTER","BOTTOM"],function(x,i){api.each(["LEFT","CENTER","RIGHT"],function(y,j){Image[x+"_"+y]=3*i+j,Image[y+"_"+x]=3*i+j})}),Image.toCanvas=function(el){var canvas=document.createElement("canvas");return canvas.width=el.videoWidth||el.width,canvas.height=el.videoHeight||el.height,canvas.getContext("2d").drawImage(el,0,0),
canvas},Image.fromDataURL=function(dataURL,size,callback){var img=api.newImage(dataURL);api.extend(img,size),callback(img)},Image.applyFilter=function(canvas,filter,doneFn){"function"==typeof filter?filter(canvas,doneFn):window.Caman&&window.Caman("IMG"==canvas.tagName?Image.toCanvas(canvas):canvas,function(){"string"==typeof filter?this[filter]():api.each(filter,function(val,method){this[method](val)},this),this.render(doneFn)})},api.renderImageToCanvas=function(canvas,img,sx,sy,sw,sh,dx,dy,dw,dh){return canvas.getContext("2d").drawImage(img,sx,sy,sw,sh,dx,dy,dw,dh),canvas},api.support.canvas=api.support.transform=support,api.Image=Image}(FileAPI,document),function(factory){"use strict";factory(FileAPI)}(function(loadImage){"use strict";if(window.navigator&&window.navigator.platform&&/iP(hone|od|ad)/.test(window.navigator.platform)){var originalRenderMethod=loadImage.renderImageToCanvas;loadImage.detectSubsampling=function(img){var canvas,context;return img.width*img.height>1048576?(canvas=document.createElement("canvas"),canvas.width=canvas.height=1,context=canvas.getContext("2d"),context.drawImage(img,-img.width+1,0),0===context.getImageData(0,0,1,1).data[3]):!1},loadImage.detectVerticalSquash=function(img,subsampled){var data,sy,ey,py,alpha,naturalHeight=img.naturalHeight||img.height,canvas=document.createElement("canvas"),context=canvas.getContext("2d");for(subsampled&&(naturalHeight/=2),canvas.width=1,canvas.height=naturalHeight,context.drawImage(img,0,0),data=context.getImageData(0,0,1,naturalHeight).data,sy=0,ey=naturalHeight,py=naturalHeight;py>sy;)alpha=data[4*(py-1)+3],0===alpha?ey=py:sy=py,py=ey+sy>>1;return py/naturalHeight||1},loadImage.renderImageToCanvas=function(canvas,img,sourceX,sourceY,sourceWidth,sourceHeight,destX,destY,destWidth,destHeight){if("image/jpeg"===img._type){var subsampled,vertSquashRatio,tileX,tileY,context=canvas.getContext("2d"),tmpCanvas=document.createElement("canvas"),tileSize=1024,tmpContext=tmpCanvas.getContext("2d");if(tmpCanvas.width=tileSize,tmpCanvas.height=tileSize,context.save(),subsampled=loadImage.detectSubsampling(img),subsampled&&(sourceX/=2,sourceY/=2,sourceWidth/=2,sourceHeight/=2),vertSquashRatio=loadImage.detectVerticalSquash(img,subsampled),subsampled||1!==vertSquashRatio){for(sourceY*=vertSquashRatio,destWidth=Math.ceil(tileSize*destWidth/sourceWidth),destHeight=Math.ceil(tileSize*destHeight/sourceHeight/vertSquashRatio),destY=0,tileY=0;sourceHeight>tileY;){for(destX=0,tileX=0;sourceWidth>tileX;)tmpContext.clearRect(0,0,tileSize,tileSize),tmpContext.drawImage(img,sourceX,sourceY,sourceWidth,sourceHeight,-tileX,-tileY,sourceWidth,sourceHeight),context.drawImage(tmpCanvas,0,0,tileSize,tileSize,destX,destY,destWidth,destHeight),tileX+=tileSize,destX+=destWidth;tileY+=tileSize,destY+=destHeight}return context.restore(),canvas}}return originalRenderMethod(canvas,img,sourceX,sourceY,sourceWidth,sourceHeight,destX,destY,destWidth,destHeight)}}}),function(api,window){"use strict";function _convertFile(file,fn,useBinaryString){var blob=file.blob,filename=file.file;if(filename){if(!blob.toDataURL)return void api.readAsBinaryString(blob,function(evt){"load"==evt.type&&fn(file,evt.result)});var mime={"image/jpeg":".jpe?g","image/png":".png"},type=mime[file.type]?file.type:"image/png",ext=mime[type]||".png",quality=blob.quality||1;filename.match(new RegExp(ext+"$","i"))||(filename+=ext.replace("?","")),file.file=filename,file.type=type,!useBinaryString&&blob.toBlob?blob.toBlob(function(blob){fn(file,blob)},type,quality):fn(file,api.toBinaryString(blob.toDataURL(type,quality)))}else fn(file,blob)}var document=window.document,FormData=window.FormData,Form=function(){this.items=[]},encodeURIComponent=window.encodeURIComponent;Form.prototype={append:function(name,blob,file,type){this.items.push({name:name,blob:blob&&blob.blob||(void 0==blob?"":blob),file:blob&&(file||blob.name),type:blob&&(type||blob.type)})},each:function(fn){for(var i=0,n=this.items.length;n>i;i++)fn.call(this,this.items[i])},toData:function(fn,options){options._chunked=api.support.chunked&&options.chunkSize>0&&1==api.filter(this.items,function(item){return item.file}).length,api.support.html5?api.formData&&!this.multipart&&FormData?options._chunked?(api.log("FileAPI.Form.toPlainData"),this.toPlainData(fn)):(api.log("FileAPI.Form.toFormData"),this.toFormData(fn)):(api.log("FileAPI.Form.toMultipartData"),this.toMultipartData(fn)):(api.log("FileAPI.Form.toHtmlData"),this.toHtmlData(fn))},_to:function(data,complete,next,arg){var queue=api.queue(function(){complete(data)});this.each(function(file){next(file,data,queue,arg)}),queue.check()},toHtmlData:function(fn){this._to(document.createDocumentFragment(),fn,function(file,data){var hidden,blob=file.blob;file.file?(api.reset(blob,!0),blob.name=file.name,data.appendChild(blob)):(hidden=document.createElement("input"),hidden.name=file.name,hidden.type="hidden",hidden.value=blob,data.appendChild(hidden))})},toPlainData:function(fn){this._to({},fn,function(file,data,queue){file.file&&(data.type=file.file),file.blob.toBlob?(queue.inc(),_convertFile(file,function(file,blob){data.name=file.name,data.file=blob,data.size=blob.length,data.type=file.type,queue.next()})):file.file?(data.name=file.blob.name,data.file=file.blob,data.size=file.blob.size,data.type=file.type):(data.params||(data.params=[]),data.params.push(encodeURIComponent(file.name)+"="+encodeURIComponent(file.blob))),data.start=-1,data.end=data.file&&data.file.FileAPIReadPosition||-1,data.retry=0})},toFormData:function(fn){this._to(new FormData,fn,function(file,data,queue){file.blob&&file.blob.toBlob?(queue.inc(),_convertFile(file,function(file,blob){data.append(file.name,blob,file.file),queue.next()})):file.file?data.append(file.name,file.blob,file.file):data.append(file.name,file.blob),file.file&&data.append("_"+file.name,file.file)})},toMultipartData:function(fn){this._to([],fn,function(file,data,queue,boundary){queue.inc(),_convertFile(file,function(file,blob){data.push("--_"+boundary+('\r\nContent-Disposition: form-data; name="'+file.name+'"'+(file.file?'; filename="'+encodeURIComponent(file.file)+'"':"")+(file.file?"\r\nContent-Type: "+(file.type||"application/octet-stream"):"")+"\r\n\r\n"+(file.file?blob:encodeURIComponent(blob))+"\r\n")),queue.next()},!0)},api.expando)}},api.Form=Form}(FileAPI,window),function(window,api){"use strict";var noop=function(){},document=window.document,XHR=function(options){this.uid=api.uid(),this.xhr={abort:noop,getResponseHeader:noop,getAllResponseHeaders:noop},this.options=options},_xhrResponsePostfix={"":1,XML:1,Text:1,Body:1};XHR.prototype={status:0,statusText:"",constructor:XHR,getResponseHeader:function(name){return this.xhr.getResponseHeader(name)},getAllResponseHeaders:function(){return this.xhr.getAllResponseHeaders()||{}},end:function(status,statusText){var _this=this,options=_this.options;_this.end=_this.abort=noop,_this.status=status,statusText&&(_this.statusText=statusText),api.log("xhr.end:",status,statusText),options.complete(200==status||201==status?!1:_this.statusText||"unknown",_this),_this.xhr&&_this.xhr.node&&setTimeout(function(){var node=_this.xhr.node;try{node.parentNode.removeChild(node)}catch(e){}try{delete window[_this.uid]}catch(e){}window[_this.uid]=_this.xhr.node=null},9)},abort:function(){this.end(0,"abort"),this.xhr&&(this.xhr.aborted=!0,this.xhr.abort())},send:function(FormData){var _this=this,options=this.options;FormData.toData(function(data){options.upload(options,_this),_this._send.call(_this,options,data)},options)},_send:function(options,data){var xhr,_this=this,uid=_this.uid,url=options.url;if(api.log("XHR._send:",data),options.cache||(url+=(~url.indexOf("?")?"&":"?")+api.uid()),data.nodeName){var jsonp=options.jsonp;url=url.replace(/([a-z]+)=(\?)/i,"$1="+uid),options.upload(options,_this),xhr=document.createElement("div"),xhr.innerHTML='<form target="'+uid+'" action="'+url+'" method="POST" enctype="multipart/form-data" style="position: absolute; top: -1000px; overflow: hidden; width: 1px; height: 1px;"><iframe name="'+uid+'" src="javascript:false;"></iframe>'+(jsonp&&-1==options.url.indexOf("=?")?'<input value="'+uid+'" name="'+jsonp+'" type="hidden"/>':"")+"</form>";var form=xhr.getElementsByTagName("form")[0],transport=xhr.getElementsByTagName("iframe")[0];form.appendChild(data),api.log(form.parentNode.innerHTML),document.body.appendChild(xhr),_this.xhr.node=xhr;var onPostMessage=function(evt){if(-1!=url.indexOf(evt.origin))try{var result=api.parseJSON(evt.data);result.id==uid&&complete(result.status,result.statusText,result.response)}catch(err){complete(0,err.message)}},complete=window[uid]=function(status,statusText,response){_this.readyState=4,_this.responseText=response,_this.end(status,statusText),api.event.off(window,"message",onPostMessage),window[uid]=xhr=transport=transport.onload=null};_this.xhr.abort=function(){try{transport.stop?transport.stop():transport.contentWindow.stop?transport.contentWindow.stop():transport.contentWindow.document.execCommand("Stop")}catch(er){}complete(0,"abort")},api.event.on(window,"message",onPostMessage),transport.onload=function(){try{var win=transport.contentWindow,doc=win.document,result=win.result||api.parseJSON(doc.body.innerHTML);complete(result.status,result.statusText,result.response)}catch(e){}},_this.readyState=2,form.submit(),form=null}else{if(url=url.replace(/([a-z]+)=(\?)&?/i,""),this.xhr&&this.xhr.aborted)return void api.log("Error: already aborted");if(xhr=_this.xhr=api.getXHR(),data.params&&(url+=(url.indexOf("?")<0?"?":"&")+data.params.join("&")),xhr.open("POST",url,!0),api.withCredentials&&(xhr.withCredentials="true"),options.headers&&options.headers["X-Requested-With"]||xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),api.each(options.headers,function(val,key){xhr.setRequestHeader(key,val)}),options._chunked){xhr.upload&&xhr.upload.addEventListener("progress",api.throttle(function(evt){data.retry||options.progress({type:evt.type,total:data.size,loaded:data.start+evt.loaded,totalSize:data.size},_this,options)},100),!1),xhr.onreadystatechange=function(){var lkb=parseInt(xhr.getResponseHeader("X-Last-Known-Byte"),10);if(_this.status=xhr.status,_this.statusText=xhr.statusText,_this.readyState=xhr.readyState,4==xhr.readyState){for(var k in _xhrResponsePostfix)_this["response"+k]=xhr["response"+k];if(xhr.onreadystatechange=null,!xhr.status||xhr.status-201>0)if(api.log("Error: "+xhr.status),(!xhr.status&&!xhr.aborted||500==xhr.status||416==xhr.status)&&++data.retry<=options.chunkUploadRetry){var delay=xhr.status?0:api.chunkNetworkDownRetryTimeout;options.pause(data.file,options),api.log("X-Last-Known-Byte: "+lkb),lkb?data.end=lkb:(data.end=data.start-1,416==xhr.status&&(data.end=data.end-options.chunkSize)),setTimeout(function(){_this._send(options,data)},delay)}else _this.end(xhr.status);else data.retry=0,data.end==data.size-1?_this.end(xhr.status):(api.log("X-Last-Known-Byte: "+lkb),lkb&&(data.end=lkb),data.file.FileAPIReadPosition=data.end,setTimeout(function(){_this._send(options,data)},0));xhr=null}},data.start=data.end+1,data.end=Math.max(Math.min(data.start+options.chunkSize,data.size)-1,data.start);var file=data.file,slice=(file.slice||file.mozSlice||file.webkitSlice)(data.start,data.end+1);data.size&&!slice.size?setTimeout(function(){_this.end(-1)}):(xhr.setRequestHeader("Content-Range","bytes "+data.start+"-"+data.end+"/"+data.size),xhr.setRequestHeader("Content-Disposition","attachment; filename="+encodeURIComponent(data.name)),xhr.setRequestHeader("Content-Type",data.type||"application/octet-stream"),xhr.send(slice)),xhr.send(slice),file=slice=null}else if(xhr.upload&&xhr.upload.addEventListener("progress",api.throttle(function(evt){options.progress(evt,_this,options)},100),!1),xhr.onreadystatechange=function(){if(_this.status=xhr.status,_this.statusText=xhr.statusText,_this.readyState=xhr.readyState,4==xhr.readyState){for(var k in _xhrResponsePostfix)_this["response"+k]=xhr["response"+k];xhr.onreadystatechange=null,_this.end(xhr.status),xhr=null}},api.isArray(data))if(xhr.setRequestHeader("Content-Type","multipart/form-data; boundary=_"+api.expando),data=data.join("")+"--_"+api.expando+"--",xhr.sendAsBinary)xhr.sendAsBinary(data);else{var bytes=Array.prototype.map.call(data,function(c){return 255&c.charCodeAt(0)});xhr.send(new Uint8Array(bytes).buffer)}else xhr.send(data)}}},api.XHR=XHR}(window,FileAPI),function(window,api){"use strict";function _px(val){return val>=0?val+"px":val}function _detectVideoSignal(video){var ctx,canvas=document.createElement("canvas"),res=!1;try{ctx=canvas.getContext("2d"),ctx.drawImage(video,0,0,1,1),res=255!=ctx.getImageData(0,0,1,1).data[4]}catch(e){}return res}var URL=window.URL||window.webkitURL,document=window.document,navigator=window.navigator,getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,html5=!!getMedia;api.support.media=html5;var Camera=function(video){this.video=video};Camera.prototype={isActive:function(){return!!this._active},start:function(callback){var _successId,_failId,_this=this,video=_this.video,_complete=function(err){_this._active=!err,clearTimeout(_failId),clearTimeout(_successId),callback&&callback(err,_this)};getMedia.call(navigator,{video:!0},function(stream){_this.stream=stream,video.src=URL.createObjectURL(stream),_successId=setInterval(function(){_detectVideoSignal(video)&&_complete(null)},1e3),_failId=setTimeout(function(){_complete("timeout")},5e3),video.play()},_complete)},stop:function(){try{this._active=!1,this.video.pause(),this.stream.stop()}catch(err){}},shot:function(){return new Shot(this.video)}},Camera.get=function(el){return new Camera(el.firstChild)},Camera.publish=function(el,options,callback){"function"==typeof options&&(callback=options,options={}),options=api.extend({},{width:"100%",height:"100%",start:!0},options),el.jquery&&(el=el[0]);var doneFn=function(err){if(err)callback(err);else{var cam=Camera.get(el);options.start?cam.start(callback):callback(null,cam)}};if(el.style.width=_px(options.width),el.style.height=_px(options.height),api.html5&&html5){var video=document.createElement("video");video.style.width=_px(options.width),video.style.height=_px(options.height),window.jQuery?jQuery(el).empty():el.innerHTML="",el.appendChild(video),doneFn()}else Camera.fallback(el,options,doneFn)},Camera.fallback=function(el,options,callback){callback("not_support_camera")};var Shot=function(video){var canvas=video.nodeName?api.Image.toCanvas(video):video,shot=api.Image(canvas);return shot.type="image/png",shot.width=canvas.width,shot.height=canvas.height,shot.size=canvas.width*canvas.height*4,shot};Camera.Shot=Shot,api.Camera=Camera}(window,FileAPI),function(window,jQuery,api){"use strict";var document=window.document,location=window.location,navigator=window.navigator,_each=api.each,_cameraQueue=[];api.support.flash=function(){var mime=navigator.mimeTypes,has=!1;if(navigator.plugins&&"object"==typeof navigator.plugins["Shockwave Flash"])has=navigator.plugins["Shockwave Flash"].description&&!(mime&&mime["application/x-shockwave-flash"]&&!mime["application/x-shockwave-flash"].enabledPlugin);else try{has=!(!window.ActiveXObject||!new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(er){api.log("Flash -- does not supported.")}return has&&/^file:/i.test(location)&&api.log("[warn] Flash does not work on `file:` protocol."),has}(),api.support.flash&&(!api.html5||!api.support.html5||api.cors&&!api.support.cors||api.media&&!api.support.media)&&function(){function _makeFlashHTML(opts){return('<object id="#id#" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="'+(opts.width||"100%")+'" height="'+(opts.height||"100%")+'"><param name="movie" value="#src#" /><param name="flashvars" value="#flashvars#" /><param name="swliveconnect" value="true" /><param name="allowscriptaccess" value="always" /><param name="allownetworking" value="all" /><param name="menu" value="false" /><param name="wmode" value="#wmode#" /><embed flashvars="#flashvars#" swliveconnect="true" allownetworking="all" allowscriptaccess="always" name="#id#" src="#src#" width="'+(opts.width||"100%")+'" height="'+(opts.height||"100%")+'" menu="false" wmode="transparent" type="application/x-shockwave-flash"></embed></object>').replace(/#(\w+)#/gi,function(a,name){return opts[name]})}function _css(el,css){if(el&&el.style){var key,val;for(key in css){val=css[key],"number"==typeof val&&(val+="px");try{el.style[key]=val}catch(e){}}}}function _inherit(obj,methods){_each(methods,function(fn,name){var prev=obj[name];obj[name]=function(){return this.parent=prev,fn.apply(this,arguments)}})}function _isHtmlFile(file){return file&&!file.flashId}function _wrap(fn){var id=fn.wid=api.uid();return flash._fn[id]=fn,"FileAPI.Flash._fn."+id}function _unwrap(fn){try{flash._fn[fn.wid]=null,delete flash._fn[fn.wid]}catch(e){}}function _getUrl(url,params){if(!_rhttp.test(url)){if(/^\.\//.test(url)||"/"!=url.charAt(0)){var path=location.pathname;path=path.substr(0,path.lastIndexOf("/")),url=(path+"/"+url).replace("/./","/")}"//"!=url.substr(0,2)&&(url="//"+location.host+url),_rhttp.test(url)||(url=location.protocol+url)}return params&&(url+=(/\?/.test(url)?"&":"?")+params),url}function _makeFlashImage(opts,base64,fn){function _setImage(){try{var img=flash.get(flashId);img.setImage(base64)}catch(e){api.log('[err] FlashAPI.Preview.setImage -- can not set "base64":',e)}}var key,flashId=api.uid(),el=document.createElement("div"),attempts=10;for(key in opts)el.setAttribute(key,opts[key]),el[key]=opts[key];_css(el,opts),opts.width="100%",opts.height="100%",el.innerHTML=_makeFlashHTML(api.extend({id:flashId,src:_getUrl(api.flashImageUrl,"r="+api.uid()),wmode:"opaque",flashvars:"scale="+opts.scale+"&callback="+_wrap(function _(){return _unwrap(_),--attempts>0&&_setImage(),!0})},opts)),fn(!1,el),el=null}function _getFileDescr(file){return{id:file.id,name:file.name,matrix:file.matrix,flashId:file.flashId}}function _getDimensions(el){var box=el.getBoundingClientRect(),body=document.body,docEl=(el&&el.ownerDocument).documentElement;return{top:box.top+(window.pageYOffset||docEl.scrollTop)-(docEl.clientTop||body.clientTop||0),left:box.left+(window.pageXOffset||docEl.scrollLeft)-(docEl.clientLeft||body.clientLeft||0),width:box.right-box.left,height:box.bottom-box.top}}var _attr=api.uid(),_retry=0,_files={},_rhttp=/^https?:/i,flash={_fn:{},init:function(){var child=document.body&&document.body.firstChild;if(child)do if(1==child.nodeType){api.log("FlashAPI.state: awaiting");var dummy=document.createElement("div");return dummy.id="_"+_attr,_css(dummy,{top:1,right:1,width:5,height:5,position:"absolute",zIndex:1e6+""}),child.parentNode.insertBefore(dummy,child),void flash.publish(dummy,_attr)}while(child=child.nextSibling);10>_retry&&setTimeout(flash.init,50*++_retry)},publish:function(el,id,opts){opts=opts||{},el.innerHTML=_makeFlashHTML({id:id,src:_getUrl(api.flashUrl,"r="+api.version),wmode:opts.camera?"":"transparent",flashvars:"callback="+(opts.onEvent||"FileAPI.Flash.onEvent")+"&flashId="+id+"&storeKey="+navigator.userAgent.match(/\d/gi).join("")+"_"+api.version+(flash.isReady||(api.pingUrl?"&ping="+api.pingUrl:""))+"&timeout="+api.flashAbortTimeout+(opts.camera?"&useCamera="+_getUrl(api.flashWebcamUrl):"")},opts)},ready:function(){api.log("FlashAPI.state: ready"),flash.ready=api.F,flash.isReady=!0,flash.patch(),api.event.on(document,"mouseover",flash.mouseover),api.event.on(document,"click",function(evt){flash.mouseover(evt)&&(evt.preventDefault?evt.preventDefault():evt.returnValue=!0)})},getEl:function(){return document.getElementById("_"+_attr)},getWrapper:function(node){do if(/js-fileapi-wrapper/.test(node.className))return node;while((node=node.parentNode)&&node!==document.body)},mouseover:function(evt){var target=api.event.fix(evt).target;if(/input/i.test(target.nodeName)&&"file"==target.type){var state=target.getAttribute(_attr),wrapper=flash.getWrapper(target);if(api.multiFlash){if("i"==state||"r"==state)return!1;if("p"!=state){target.setAttribute(_attr,"i");var dummy=document.createElement("div");if(!wrapper)return void api.log("[err] FlashAPI.mouseover: js-fileapi-wrapper not found");_css(dummy,{top:0,left:0,width:target.offsetWidth+100,height:target.offsetHeight+100,zIndex:1e6+"",position:"absolute"}),wrapper.appendChild(dummy),flash.publish(dummy,api.uid()),target.setAttribute(_attr,"p")}return!0}if(wrapper){var box=_getDimensions(wrapper);_css(flash.getEl(),box),flash.curInp=target}}else/object|embed/i.test(target.nodeName)||_css(flash.getEl(),{top:1,left:1,width:5,height:5})},onEvent:function(evt){var type=evt.type;if("ready"==type){try{flash.getInput(evt.flashId).setAttribute(_attr,"r")}catch(e){}return flash.ready(),setTimeout(function(){flash.mouseenter(evt)},50),!0}"ping"===type?api.log("(flash -> js).ping:",[evt.status,evt.savedStatus],evt.error):"log"===type?api.log("(flash -> js).log:",evt.target):type in flash&&setTimeout(function(){api.log("FlashAPI.event."+evt.type+":",evt),flash[type](evt)},1)},mouseenter:function(evt){var node=flash.getInput(evt.flashId);if(node){flash.cmd(evt,"multiple",null!=node.getAttribute("multiple"));var accept=[],exts={};_each((node.getAttribute("accept")||"").split(/,\s*/),function(mime){api.accept[mime]&&_each(api.accept[mime].split(" "),function(ext){exts[ext]=1})}),_each(exts,function(i,ext){accept.push(ext)}),flash.cmd(evt,"accept",accept.length?accept.join(",")+","+accept.join(",").toUpperCase():"*")}},get:function(id){return document[id]||window[id]||document.embeds[id]},getInput:function(id){if(!api.multiFlash)return flash.curInp;try{var node=flash.getWrapper(flash.get(id));if(node)return node.getElementsByTagName("input")[0]}catch(e){api.log('[err] Can not find "input" by flashId:',id,e)}},select:function(evt){var event,inp=flash.getInput(evt.flashId),uid=api.uid(inp),files=evt.target.files;_each(files,function(file){api.checkFileObj(file)}),_files[uid]=files,document.createEvent?(event=document.createEvent("Event"),event.files=files,event.initEvent("change",!0,!0),inp.dispatchEvent(event)):jQuery?jQuery(inp).trigger({type:"change",files:files}):(event=document.createEventObject(),event.files=files,inp.fireEvent("onchange",event))},cmd:function(id,name,data,last){try{return api.log("(js -> flash)."+name+":",data),flash.get(id.flashId||id).cmd(name,data)}catch(e){api.log("(js -> flash).onError:",e),last||setTimeout(function(){flash.cmd(id,name,data,!0)},50)}},patch:function(){api.flashEngine=api.support.transform=!0,_inherit(api,{getFiles:function(input,filter,callback){if(callback)return api.filterFiles(api.getFiles(input),filter,callback),null;var files=api.isArray(input)?input:_files[api.uid(input.target||input.srcElement||input)];return files?(filter&&(filter=api.getFilesFilter(filter),files=api.filter(files,function(file){return filter.test(file.name)})),files):this.parent.apply(this,arguments)},getInfo:function(file,fn){if(_isHtmlFile(file))this.parent.apply(this,arguments);else if(file.isShot)fn(null,file.info={width:file.width,height:file.height});else{if(!file.__info){var defer=file.__info=api.defer();flash.cmd(file,"getFileInfo",{id:file.id,callback:_wrap(function _(err,info){_unwrap(_),defer.resolve(err,file.info=info)})})}file.__info.then(fn)}}}),api.support.transform=!0,api.Image&&_inherit(api.Image.prototype,{get:function(fn,scaleMode){return this.set({scaleMode:scaleMode||"noScale"}),this.parent(fn)},_load:function(file,fn){if(api.log("FlashAPI.Image._load:",file),_isHtmlFile(file))this.parent.apply(this,arguments);else{var _this=this;api.getInfo(file,function(err){fn.call(_this,err,file)})}},_apply:function(file,fn){if(api.log("FlashAPI.Image._apply:",file),_isHtmlFile(file))this.parent.apply(this,arguments);else{var m=this.getMatrix(file.info),doneFn=fn;flash.cmd(file,"imageTransform",{id:file.id,matrix:m,callback:_wrap(function _(err,base64){api.log("FlashAPI.Image._apply.callback:",err),_unwrap(_),err?doneFn(err):api.support.html5||api.support.dataURI&&!(base64.length>3e4)?(m.filter&&(doneFn=function(err,img){err?fn(err):api.Image.applyFilter(img,m.filter,function(){fn(err,this.canvas)})}),api.newImage("data:"+file.type+";base64,"+base64,doneFn)):_makeFlashImage({width:m.deg%180?m.dh:m.dw,height:m.deg%180?m.dw:m.dh,scale:m.scaleMode},base64,doneFn)})})}},toData:function(fn){var file=this.file,info=file.info,matrix=this.getMatrix(info);_isHtmlFile(file)?this.parent.apply(this,arguments):("auto"==matrix.deg&&(matrix.deg=api.Image.exifOrientation[info&&info.exif&&info.exif.Orientation]||0),fn.call(this,!file.info,{id:file.id,flashId:file.flashId,name:file.name,type:file.type,matrix:matrix}))}}),api.Image&&_inherit(api.Image,{fromDataURL:function(dataURL,size,callback){!api.support.dataURI||dataURL.length>3e4?_makeFlashImage(api.extend({scale:"exactFit"},size),dataURL.replace(/^data:[^,]+,/,""),function(err,el){callback(el)}):this.parent(dataURL,size,callback)}}),api.Camera.fallback=function(el,options,callback){var camId=api.uid();api.log("FlashAPI.Camera.publish: "+camId),flash.publish(el,camId,api.extend(options,{camera:!0,onEvent:_wrap(function _(evt){"camera"==evt.type&&(_unwrap(_),evt.error?(api.log("FlashAPI.Camera.publish.error: "+evt.error),callback(evt.error)):(api.log("FlashAPI.Camera.publish.success: "+camId),callback(null)))})}))},_each(_cameraQueue,function(args){api.Camera.fallback.apply(api.Camera,args)}),_cameraQueue=[],_inherit(api.Camera.prototype,{_id:function(){return this.video.id},start:function(callback){var _this=this;flash.cmd(this._id(),"camera.on",{callback:_wrap(function _(evt){_unwrap(_),evt.error?(api.log("FlashAPI.camera.on.error: "+evt.error),callback(evt.error,_this)):(api.log("FlashAPI.camera.on.success: "+_this._id()),_this._active=!0,callback(null,_this))})})},stop:function(){this._active=!1,flash.cmd(this._id(),"camera.off")},shot:function(){api.log("FlashAPI.Camera.shot:",this._id());var shot=flash.cmd(this._id(),"shot",{});return shot.type="image/png",shot.flashId=this._id(),shot.isShot=!0,new api.Camera.Shot(shot)}}),_inherit(api.Form.prototype,{toData:function(fn){for(var items=this.items,i=items.length;i--;)if(items[i].file&&_isHtmlFile(items[i].blob))return this.parent.apply(this,arguments);api.log("FlashAPI.Form.toData"),fn(items)}}),_inherit(api.XHR.prototype,{_send:function(options,formData){if(formData.nodeName||formData.append&&api.support.html5||api.isArray(formData)&&"string"==typeof formData[0])return this.parent.apply(this,arguments);var flashId,fileId,data={},files={},_this=this;if(_each(formData,function(item){item.file?(files[item.name]=item=_getFileDescr(item.blob),fileId=item.id,flashId=item.flashId):data[item.name]=item.blob}),fileId||(flashId=_attr),!flashId)return api.log("[err] FlashAPI._send: flashId -- undefined"),this.parent.apply(this,arguments);api.log("FlashAPI.XHR._send: "+flashId+" -> "+fileId,files),_this.xhr={headers:{},abort:function(){flash.cmd(flashId,"abort",{id:fileId})},getResponseHeader:function(name){return this.headers[name]},getAllResponseHeaders:function(){return this.headers}};var queue=api.queue(function(){flash.cmd(flashId,"upload",{url:_getUrl(options.url),data:data,files:fileId?files:null,headers:options.headers||{},callback:_wrap(function upload(evt){var type=evt.type,result=evt.result;api.log("FlashAPI.upload."+type+":",evt),"progress"==type?(evt.loaded=Math.min(evt.loaded,evt.total),evt.lengthComputable=!0,options.progress(evt)):"complete"==type?(_unwrap(upload),"string"==typeof result&&(_this.responseText=result.replace(/%22/g,'"').replace(/%5c/g,"\\").replace(/%26/g,"&").replace(/%25/g,"%")),_this.end(evt.status||200)):("abort"==type||"error"==type)&&(_this.end(evt.status||0,evt.message),_unwrap(upload))})})});_each(files,function(file){queue.inc(),api.getInfo(file,queue.next)}),queue.check()}})}};api.Camera.fallback=function(){_cameraQueue.push(arguments)},api.Flash=flash,api.newImage("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",function(err,img){api.support.dataURI=!(1!=img.width||1!=img.height),flash.init()})}()}(window,window.jQuery,FileAPI),"function"==typeof define&&define.amd&&define("FileAPI",[],function(){return FileAPI}),function(){var maxFileSize=parseInt(MODx.config.upload_maxsize,10),permittedFileTypes=MODx.config.upload_files.toLowerCase().split(",");FileAPI.debug=!1,FileAPI.staticPath=MODx.config.manager_url+"assets/fileapi/";var api={humanFileSize:function(bytes,si){var thresh=si?1e3:1024;if(thresh>bytes)return bytes+" B";var units=si?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],u=-1;do bytes/=thresh,++u;while(bytes>=thresh);return bytes.toFixed(1)+" "+units[u]},getFileExtension:function(filename){var result="",parts=filename.split(".");return parts.length>1&&(result=parts.pop()),result},isFileSizePermitted:function(size){return maxFileSize>=size},formatBytes:function(size,unit){return unit=unit||FileAPI.MB,Math.round(100*(size/unit+1e-5))/100}};Ext.namespace("MODx.util.MultiUploadDialog"),MODx.util.MultiUploadDialog.BrowseButton=Ext.extend(Ext.Button,{input_name:"file",input_file:null,original_handler:null,original_scope:null,initComponent:function(){MODx.util.MultiUploadDialog.BrowseButton.superclass.initComponent.call(this),this.original_handler=this.handler||null,this.original_scope=this.scope||window,this.handler=null,this.scope=null},onRender:function(ct,position){MODx.util.MultiUploadDialog.BrowseButton.superclass.onRender.call(this,ct,position),this.createInputFile()},createInputFile:function(){var button_container=this.el.child("button").wrap();this.input_file=button_container.createChild({tag:"input",type:"file",size:1,name:this.input_name||Ext.id(this.el),style:"cursor: pointer; display: inline-block; opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%;",multiple:!0}),this.handleMouseEvents&&(this.input_file.on("mouseover",this.onMouseOver,this),this.input_file.on("mousedown",this.onMouseDown,this)),this.tooltip&&("object"==typeof this.tooltip?Ext.QuickTips.register(Ext.apply({target:this.input_file},this.tooltip)):this.input_file.dom[this.tooltipType]=this.tooltip),this.input_file.on("change",this.onInputFileChange,this),this.input_file.on("click",function(e){e.stopPropagation()})},detachInputFile:function(no_create){var result=this.input_file;return"object"==typeof this.tooltip?Ext.QuickTips.unregister(this.input_file):this.input_file.dom[this.tooltipType]=null,this.input_file.removeAllListeners(),this.input_file=null,result},getInputFile:function(){return this.input_file},disable:function(){MODx.util.MultiUploadDialog.BrowseButton.superclass.disable.call(this),this.input_file.dom.disabled=!0},enable:function(){MODx.util.MultiUploadDialog.BrowseButton.superclass.enable.call(this),this.input_file.dom.disabled=!1},destroy:function(){var input_file=this.detachInputFile(!0);input_file.remove(),input_file=null,MODx.util.MultiUploadDialog.BrowseButton.superclass.destroy.call(this)},reset:function(){var form=new Ext.Element(document.createElement("form")),buttonParent=this.input_file.parent();form.appendChild(this.input_file),form.dom.reset(),buttonParent.appendChild(this.input_file)},onInputFileChange:function(ev){this.original_handler&&this.original_handler.call(this.original_scope,this,ev),this.fireEvent("click",this,ev)}}),Ext.reg("multiupload-browse-btn",MODx.util.MultiUploadDialog.BrowseButton),MODx.util.MultiUploadDialog.FilesGrid=function(config){config=config||{},Ext.applyIf(config,{height:300,autoScroll:!0,border:!1,fields:["name","size","file","permitted","message","uploaded"],paging:!1,remoteSort:!1,viewConfig:{forceFit:!0,getRowClass:function(record,index,rowParams){return record.get("permitted")?record.get("uploaded")?"upload-success":void 0:"upload-error"}},sortInfo:{field:"name",direction:"ASC"},deferRowRender:!0,anchor:"100%",autoExpandColumn:"state",columns:[{header:_("upload.columns.file"),dataIndex:"name",sortable:!0,width:200,renderer:function(value,meta,record){
var id=Ext.id();return FileAPI.Image(record.get("file")).resize(100,50,"max").get(function(err,img){err||(img=new Ext.Element(img).addClass("upload-thumb"),Ext.get(id).insertFirst(img))}),'<div id="'+id+'"><p>'+value+"</p></div>"}},{header:_("upload.columns.state"),id:"state",width:100,renderer:function(value,meta,record){if(!record.get("permitted")||record.get("uploaded"))return'<p class="upload-status-text">'+record.get("message")+"</p>";var id=Ext.id();return function(){record.progressbar=new Ext.ProgressBar({renderTo:id,value:0,text:"0 / "+record.get("size")})}.defer(25),'<div id="'+id+'"></div>'}}],getMenu:function(){return[{text:_("upload.contextmenu.remove_entry"),handler:this.removeFile}]}}),MODx.util.MultiUploadDialog.FilesGrid.superclass.constructor.call(this,config)},Ext.extend(MODx.util.MultiUploadDialog.FilesGrid,MODx.grid.LocalGrid,{removeFile:function(){var selected=this.getSelectionModel().getSelections();this.getStore().remove(selected)}}),Ext.reg("multiupload-grid-files",MODx.util.MultiUploadDialog.FilesGrid),MODx.util.MultiUploadDialog.Dialog=function(config){this.filesGridId=Ext.id(),config=config||{},Ext.applyIf(config,{permitted_extensions:permittedFileTypes,autoHeight:!0,width:600,closeAction:"hide",layout:"anchor",listeners:{show:{fn:this.onShow},hide:{fn:this.onHide}},items:[{xtype:"multiupload-grid-files",id:this.filesGridId,anchor:"100%"}],buttons:[{xtype:"multiupload-browse-btn",text:_("upload.buttons.choose"),cls:"primary-button",listeners:{click:{scope:this,fn:function(btn,ev){var files=FileAPI.getFiles(ev);this.addFiles(files),btn.reset()}}}},{xtype:"splitbutton",text:_("upload.buttons.clear"),listeners:{click:{scope:this,fn:this.clearStore}},menu:new Ext.menu.Menu({items:[{text:_("upload.clear_list.all"),listeners:{click:{scope:this,fn:this.clearStore}}},{text:_("upload.clear_list.notpermitted"),listeners:{click:{scope:this,fn:this.clearNotPermittedItems}}}]})},{xtype:"button",text:_("upload.buttons.upload"),cls:"primary-button",listeners:{click:{scope:this,fn:this.startUpload}}},{xtype:"button",text:_("upload.buttons.close"),listeners:{click:{scope:this,fn:this.hideDialog}}}]}),MODx.util.MultiUploadDialog.Dialog.superclass.constructor.call(this,config)};var originalWindowOnShow=Ext.Window.prototype.onShow,originalWindowOnHide=Ext.Window.prototype.onHide;Ext.extend(MODx.util.MultiUploadDialog.Dialog,Ext.Window,{addFiles:function(files){var store=Ext.getCmp(this.filesGridId).getStore(),dialog=this;FileAPI.each(files,function(file){var permitted=!0,message="";api.isFileSizePermitted(file.size)||(message=_("upload.notpermitted.filesize",{size:api.humanFileSize(file.size),max:api.humanFileSize(maxFileSize)}),permitted=!1),dialog.isFileTypePermitted(file.name)||(message=_("upload.notpermitted.extension",{ext:api.getFileExtension(file.name)}),permitted=!1);var data={name:file.name,size:api.humanFileSize(file.size),file:file,permitted:permitted,message:message,uploaded:!1},p=new store.recordType(data);store.insert(0,p)})},startUpload:function(){var dialog=this,files=[],params=Ext.apply(this.base_params,{HTTP_MODAUTH:MODx.siteId}),store=Ext.getCmp(this.filesGridId).getStore();store.each(function(){var file=this.get("file");this.get("permitted")&&!this.get("uploaded")&&(file.record=this,files.push(file))});FileAPI.upload({url:this.url,data:params,files:{file:files},fileprogress:function(evt,file){file.record.progressbar.updateProgress(evt.loaded/evt.total,_("upload.upload_progress",{loaded:api.humanFileSize(evt.loaded),total:file.record.get("size")}),!0)},filecomplete:function(err,xhr,file,options){if(err)401!==xhr.status&&MODx.msg.alert(_("upload.msg.title.error"),err);else{var resp=Ext.util.JSON.decode(xhr.response);resp.success?(file.record.set("uploaded",!0),file.record.set("message",_("upload.upload.success"))):(file.record.set("permitted",!1),file.record.set("message",resp.message))}},complete:function(err,xhr){dialog.fireEvent("uploadsuccess")}})},removeEntry:function(record){Ext.getCmp(this.filesGridId).getStore().remove(record)},clearStore:function(){Ext.getCmp(this.filesGridId).getStore().removeAll()},clearNotPermittedItems:function(){var store=Ext.getCmp(this.filesGridId).getStore(),notPermitted=store.query("permitted",!1);store.remove(notPermitted.getRange())},hideDialog:function(){this.hide()},onDDrag:function(ev){ev&&ev.preventDefault()},onDDrop:function(ev){ev&&ev.preventDefault();var dialog=this;FileAPI.getDropFiles(ev.browserEvent,function(files){files.length&&dialog.addFiles(files)})},onShow:function(){var ret=originalWindowOnShow.apply(this,arguments),store=Ext.getCmp(this.filesGridId).getStore();return store.removeAll(),this.isDDSet||(this.el.on("dragenter",this.onDDrag,this),this.el.on("dragover",this.onDDrag,this),this.el.on("dragleave",this.onDDrag,this),this.el.on("drop",this.onDDrop,this),this.isDDSet=!0),ret},onHide:function(){var ret=originalWindowOnHide.apply(this,arguments);return this.el.un("dragenter",this.onDDrag,this),this.el.un("dragover",this.onDDrag,this),this.el.un("dragleave",this.onDDrag,this),this.el.un("drop",this.onDDrop,this),this.isDDSet=!1,ret},setBaseParams:function(params){this.base_params=params,this.setTitle(_("upload.title.destination_path",{path:this.base_params.path}))},isFileTypePermitted:function(filename){var ext=api.getFileExtension(filename);return this.permitted_extensions.indexOf(ext.toLowerCase())>-1}}),Ext.reg("multiupload-window-dialog",MODx.util.MultiUploadDialog.Dialog)}(),Ext.namespace("MODx.tree"),MODx.tree.Tree=function(config){config=config||{},Ext.applyIf(config,{baseParams:{},action:"getNodes",loaderConfig:{}}),config.action&&(config.baseParams.action=config.action),config.loaderConfig.dataUrl=config.url,config.loaderConfig.baseParams=config.baseParams,Ext.applyIf(config.loaderConfig,{preloadChildren:!0,clearOnLoad:!0}),this.config=config;var tl,root;if(this.config.url?(tl=new MODx.tree.TreeLoader(config.loaderConfig),tl.on("beforeload",function(l,node){tl.dataUrl=this.config.url+"?action="+this.config.action+"&id="+node.attributes.id,node.attributes.type&&(tl.dataUrl+="&type="+node.attributes.type)},this),tl.on("load",this.onLoad,this),root={nodeType:"async",text:config.root_name||config.rootName||"",qtip:config.root_qtip||config.rootQtip||"",draggable:!1,id:config.root_id||config.rootId||"root",pseudoroot:!0,attributes:{pseudoroot:!0},cls:"tree-pseudoroot-node",iconCls:config.root_iconCls||config.rootIconCls||""}):(tl=new Ext.tree.TreeLoader({preloadChildren:!0,baseAttrs:{uiProvider:MODx.tree.CheckboxNodeUI}}),root=new Ext.tree.TreeNode({text:this.config.rootName||"",draggable:!1,id:this.config.rootId||"root",children:this.config.data||[],pseudoroot:!0})),Ext.applyIf(config,{useArrows:!0,autoScroll:!0,animate:!0,enableDD:!0,enableDrop:!0,ddAppendOnly:!1,containerScroll:!0,collapsible:!0,border:!1,autoHeight:!0,rootVisible:!0,loader:tl,header:!1,hideBorders:!0,bodyBorder:!1,cls:"modx-tree",root:root,preventRender:!1,stateful:!0,menuConfig:{defaultAlign:"tl-b?",enableScrolling:!1,listeners:{show:function(){var node=this.activeNode;node&&node.ui.addClass("x-tree-selected")},hide:function(){var node=this.activeNode;node&&(node.isSelected()||node.ui.removeClass("x-tree-selected"))}}}}),config.remoteToolbar!==!0||void 0!==config.tbar&&null!==config.tbar){var tb=this.getToolbar();if(config.tbar&&config.useDefaultToolbar)for(var i=0;i<config.tbar.length;i++)tb.push(config.tbar[i]);else config.tbar&&(tb=config.tbar);Ext.apply(config,{tbar:tb})}else Ext.Ajax.request({url:config.remoteToolbarUrl||config.url,params:{action:config.remoteToolbarAction||"getToolbar"},success:function(r){r=Ext.decode(r.responseText);var itms=this._formatToolbar(r.object),tb=this.getTopToolbar();if(tb){for(var i=0;i<itms.length;i++)tb.add(itms[i]);tb.doLayout()}},scope:this}),config.tbar={bodyStyle:"padding: 0"};this.setup(config),this.config=config,this.on("append",this._onAppend,this)},Ext.extend(MODx.tree.Tree,Ext.tree.TreePanel,{menu:null,options:{},disableHref:!1,onLoad:function(ldr,node,resp){Ext.each(node.childNodes,function(node){node.attributes.selected&&node.ui.addClass("x-tree-selected")});var r=Ext.decode(resp.responseText);if(r.message){var el=this.getTreeEl();el.addClass("modx-tree-load-msg"),el.update(r.message);var w=270;this.config.width>150&&(w=this.config.width),el.setWidth(w),this.doLayout()}},setup:function(config){config.listeners=config.listeners||{},config.listeners.render={fn:function(){config.autoExpandRoot===!1&&config.hasOwnProperty("autoExpandRoot")||this.root.expand();var tl=this.getLoader();Ext.apply(tl,{fullMask:new Ext.LoadMask(this.getEl())}),tl.fullMask.removeMask=!1,tl.on({load:function(){this.fullMask.hide()},loadexception:function(){this.fullMask.hide()},beforeload:function(){this.fullMask.show()},scope:tl})},scope:this},MODx.tree.Tree.superclass.constructor.call(this,config),this.addEvents("afterSort","beforeSort"),this.cm=new Ext.menu.Menu(config.menuConfig),this.on("contextmenu",this._showContextMenu,this),this.on("beforenodedrop",this._handleDrop,this),this.on("nodedragover",this._handleDrop,this),this.on("nodedrop",this._handleDrag,this),this.on("click",this._saveState,this),this.on("contextmenu",this._saveState,this),this.on("click",this._handleClick,this),this.treestate_id=this.config.id||Ext.id(),this.on("load",this._initExpand,this,{single:!0}),this.on("expandnode",this._saveState,this),this.on("collapsenode",this._saveState,this),this.on("expandnode",function(){var cnt=Ext.getCmp("modx-content");cnt&&cnt.doLayout()},this)},_initExpand:function(){var treeState=Ext.state.Manager.get(this.treestate_id);if(Ext.isEmpty(treeState)&&this.root)this.root.expand(),this.root.firstChild&&this.config.expandFirst&&this.root.firstChild.expand();else for(var i=0;i<treeState.length;i++)this.expandPath(treeState[i])},addContextMenuItem:function(items){for(var a=items,l=a.length,i=0;l>i;i++)a[i].scope=a[i].scope||this,a[i].handler&&"string"==typeof a[i].handler&&(a[i].handler=eval(a[i].handler)),this.cm.add(a[i])},_showContextMenu:function(node,e){this.cm.activeNode=node,this.cm.removeAll();var m,handled=!1;if(!Ext.isEmpty(node.attributes.treeHandler)||node.isRoot&&!Ext.isEmpty(node.childNodes[0].attributes.treeHandler)){var h=Ext.getCmp(node.isRoot?node.childNodes[0].attributes.treeHandler:node.attributes.treeHandler);h&&(node.isRoot&&(node.attributes.type="root"),m=h.getMenu(this,node,e),handled=!0)}handled||(this.getMenu?m=this.getMenu(node,e):node.attributes.menu&&node.attributes.menu.items&&(m=node.attributes.menu.items)),m&&m.length>0&&(this.addContextMenuItem(m),this.cm.showAt(e.xy)),e.preventDefault(),e.stopEvent()},hasNode:function(t,n){return t.findChild("id",n.id)||t.leaf===!0&&t.parentNode.findChild("id",n.id)},refresh:function(func,scope,args){var treeState=Ext.state.Manager.get(this.treestate_id);return this.root.reload(),void 0===treeState?this.root.expand():Ext.isArray(treeState)&&Ext.each(treeState,function(path,idx){this.expandPath(path)},this),func&&(scope=scope||this,args=args||[],this.root.on("load",function(){Ext.callback(func,scope,args)},scope)),!0},removeChildren:function(node){for(;node.firstChild;){var c=node.firstChild;node.removeChild(c),c.destroy()}},loadRemoteData:function(data){this.removeChildren(this.getRootNode());for(var c in data)"object"==typeof data[c]&&this.getRootNode().appendChild(data[c])},reloadNode:function(n){this.getLoader().load(n),n.expand()},remove:function(text,substr,split){if(this.destroying)return MODx.tree.Tree.superclass.remove.apply(this,arguments);var node=this.cm.activeNode,id=this._extractId(node.id,substr,split),p={action:this.config.removeAction||"remove"},pk=this.config.primaryKey||"id";p[pk]=id,MODx.msg.confirm({title:this.config.removeTitle||_("warning"),text:_(text),url:this.config.url,params:p,listeners:{success:{fn:this.refresh,scope:this}}})},_extractId:function(id,substr,split){return substr=substr||!1,split=split||!1,substr!==!1&&(id=node.id.substr(substr)),split!==!1&&(id=node.id.split("_"),id=id[split]),id},expandNodes:function(){this.root&&(this.root.expand(),this.root.expandChildNodes(!0))},collapseNodes:function(){this.root&&(this.root.collapseChildNodes(!0),this.root.collapse())},_saveState:function(n){if(!this.stateful)return!0;var i,s=Ext.state.Manager.get(this.treestate_id),p=n.getPath();if(s=Ext.isObject(s)||Ext.isArray(s)?s.slice():[s],!Ext.isEmpty(p)&&void 0!=p){if(n.expanded){if(Ext.isString(p)&&-1===s.indexOf(p)){var sr,f=!1;for(i=0;i<s.length;i++)void 0!=s[i]&&"undefined"!=s[i]?(sr=s[i].search(p),-1!==sr&&s[sr]&&s[sr].length>s[i].length&&(f=!0)):s.splice(i,1);f||s.push(p)}}else for(s=s.remove(p),i=0;i<s.length;i++)void 0!=s[i]&&"undefined"!=s[i]?-1!==s[i].search(p)&&delete s[i]:s.splice(i,1);for(i=0;i<s.length;i++)void 0!=s[i]&&"undefined"!=s[i]||s.splice(i,1);Ext.state.Manager.set(this.treestate_id,s)}},_handleClick:function(n,e){if(e.stopEvent(),e.preventDefault(),this.disableHref)return!0;if(n.attributes.page&&""!==n.attributes.page){if(1==e.button)return window.open(n.attributes.page,"_blank");if(1==e.ctrlKey||1==e.metaKey||1==e.shiftKey)return window.open(n.attributes.page);MODx.loadPage(n.attributes.page)}else n.isExpandable()&&n.toggle();return!0},encode:function(node){node||(node=this.getRootNode());var _encode=function(node){for(var resultNode={},kids=node.childNodes,i=0;i<kids.length;i+=1){var n=kids[i];resultNode[n.id]={id:n.id,checked:n.ui.isChecked(),type:n.attributes.type||"",data:n.attributes.data||{},children:_encode(n)}}return resultNode},nodes=_encode(node);return Ext.encode(nodes)},_handleDrag:function(dropEvent){function simplifyNodes(node){for(var resultNode={},kids=node.childNodes,len=kids.length,i=0;len>i;i++)resultNode[kids[i].id]=simplifyNodes(kids[i]);return resultNode}var encNodes=Ext.encode(simplifyNodes(dropEvent.tree.root)),source=dropEvent.dropNode;this.fireEvent("beforeSort",encNodes),MODx.Ajax.request({url:this.config.url,params:{data:encodeURIComponent(encNodes),action:this.config.sortAction||"sort",source_pk:source.attributes.pk,source_type:source.attributes.type},listeners:{success:{fn:function(r){var el=dropEvent.dropNode.getUI().getTextEl();el&&Ext.get(el).frame(),this.fireEvent("afterSort",{event:dropEvent,result:r})},scope:this},failure:{fn:function(r){return MODx.form.Handler.errorJSON(r),this.refresh(),!1},scope:this}}})},_handleDrop:function(dropEvent){var node=dropEvent.dropNode;if(node.isRoot)return!1;if(!Ext.isEmpty(node.attributes.treeHandler)){var h=Ext.getCmp(node.attributes.treeHandler);if(h)return h.handleDrop(this,dropEvent)}},_guid:function(prefix){return prefix+(new Date).getTime()},redirect:function(loc){MODx.loadPage(loc)},loadAction:function(p){var id="";if(this.cm.activeNode&&this.cm.activeNode.id){var pid=this.cm.activeNode.id.split("_");id="id="+pid[1]}MODx.loadPage("?"+id+"&"+p)},_loadToolbar:function(){},refreshNode:function(id,self){var node=this.getNodeById(id);if(node){var n=self?node:node.parentNode;this.getLoader().load(n,function(){n.expand()},this)}},refreshActiveNode:function(){this.cm.activeNode?this.getLoader().load(this.cm.activeNode,this.cm.activeNode.expand):this.refresh()},refreshParentNode:function(){this.getLoader().load(this.cm.activeNode.parentNode,this.cm.activeNode.expand)},removeNode:function(id){var node=this.getNodeById(id);node&&node.remove()},removeActiveNode:function(){this.cm.activeNode.remove()},getToolbar:function(){var iu=MODx.config.manager_url+"templates/default/images/restyle/icons/";return[{icon:iu+"arrow_down.png",cls:"x-btn-icon arrow_down",tooltip:{text:_("tree_expand")},handler:this.expandNodes,scope:this},{icon:iu+"arrow_up.png",cls:"x-btn-icon arrow_up",tooltip:{text:_("tree_collapse")},handler:this.collapseNodes,scope:this},{icon:iu+"refresh.png",cls:"x-btn-icon refresh",tooltip:{text:_("tree_refresh")},handler:this.refresh,scope:this}]},_formatToolbar:function(a){for(var l=a.length,i=0;l>i;i++)a[i].handler&&(a[i].handler=eval(a[i].handler)),Ext.applyIf(a[i],{scope:this,cls:this.config.toolbarItemCls||"x-btn-icon"});return a},_onAppend:function(tree,parent,node){if(node.attributes.pseudoroot){return setTimeout(function(tree){return function(){var elId=node.ui.elNode.id+"_tools",el=document.createElement("div");el.id=elId,el.className="modx-tree-node-tool-ct",node.ui.elNode.appendChild(el);var inlineButtonsLang=tree.getInlineButtonsLang(node),btn=MODx.load({xtype:"modx-button",text:"",scope:this,tooltip:new Ext.ToolTip({title:inlineButtonsLang.add,target:this}),node:node,handler:function(btn,evt){evt.stopPropagation(evt),node.getOwnerTree().handleCreateClick(node)},iconCls:"icon-plus-circle",renderTo:elId,listeners:{mouseover:function(button,e){button.tooltip.onTargetOver(e)},mouseout:function(button,e){button.tooltip.onTargetOut(e)}}}),btn=MODx.load({xtype:"modx-button",text:"",scope:this,tooltip:new Ext.ToolTip({title:inlineButtonsLang.refresh,target:this}),node:node,handler:function(btn,evt){evt.stopPropagation(evt),node.reload()},iconCls:"icon-refresh",renderTo:elId,listeners:{mouseover:function(button,e){button.tooltip.onTargetOver(e)},mouseout:function(button,e){button.tooltip.onTargetOut(e)}}});window.BTNS.push(btn)}}(this),200),!1}},handleCreateClick:function(node){},getInlineButtonsLang:function(node){var langs={};if(void 0!=node.id){var type=node.id.substr(2).split("_");"type"==type[0]?langs.add=_("new_"+type[1]):"category"==type[0]?langs.add=_("new_"+type[0]):langs.add=_("new_document")}return langs.refresh=_("ext_refresh"),langs}}),Ext.reg("modx-tree",MODx.tree.Tree),window.BTNS=[],MODx.tree.TreeLoader=function(config){config=config||{},config.id=config.id||Ext.id(),Ext.applyIf(config,{}),MODx.tree.TreeLoader.superclass.constructor.call(this,config)},Ext.extend(MODx.tree.TreeLoader,Ext.tree.TreeLoader,{}),Ext.reg("modx-tree-treeloader",MODx.tree.TreeLoader),MODx.TreeDrop=function(config){config=config||{},Ext.applyIf(config,{id:"modx-treedrop",ddGroup:"modx-treedrop-dd"}),MODx.TreeDrop.superclass.constructor.call(this,config),this.config=config,this.setup()},Ext.extend(MODx.TreeDrop,Ext.Component,{setup:function(){var ddTarget=this.config.target,ddTargetEl=this.config.targetEl,cfg=this.config;this.targetEl=new Ext.dd.DropTarget(this.config.targetEl,{ddGroup:this.config.ddGroup,notifyEnter:function(ddSource,e,data){if(ddTarget.getEl){var el=ddTarget.getEl();el&&(el.frame(),el.focus())}},notifyDrop:function(ddSource,e,data){if(!data.node||!data.node.attributes||!data.node.attributes.type)return!1;if("modResource"!=data.node.attributes.type&&1!=data.node.attributes.leaf)return!1;var v="",win=!1;switch(data.node.attributes.type){case"modResource":v="[[~"+data.node.attributes.pk+"]]";break;case"snippet":win=!0;break;case"chunk":win=!0;break;case"tv":win=!0;break;case"file":v=data.node.attributes.url;break;default:var dh=Ext.getCmp(data.node.attributes.type+"-drop-handler");return dh?dh.handle(data,{ddTargetEl:ddTargetEl,cfg:cfg,iframe:cfg.iframe,iframeEl:cfg.iframeEl,onInsert:cfg.onInsert,panel:cfg.panel}):!1}if(win)MODx.loadInsertElement({pk:data.node.attributes.pk,classKey:data.node.attributes.classKey,name:data.node.attributes.name,output:v,ddTargetEl:ddTargetEl,cfg:cfg,iframe:cfg.iframe,iframeEl:cfg.iframeEl,onInsert:cfg.onInsert,panel:cfg.panel});else if(cfg.iframe)MODx.insertForRTE(v,cfg);else{var el=Ext.get(ddTargetEl);if("modx-static-content"==el.dom.id&&(v=v.substring(1),Ext.getCmp(el.dom.id).setValue("")),"modx-symlink-content"==el.dom.id||"modx-weblink-content"==el.dom.id)Ext.getCmp(el.dom.id).setValue(""),MODx.insertAtCursor(ddTargetEl,data.node.attributes.pk,cfg.onInsert);else if("modx-resource-parent"==el.dom.id){v=data.node.attributes.pk;var pf=Ext.getCmp("modx-resource-parent");if(v==pf.currentid)return MODx.msg.alert("",_("resource_err_own_parent")),!1;pf.setValue(v),Ext.getCmp(pf.parentcmp).setValue(v);var p=Ext.getCmp(pf.formpanel);p&&p.markDirty()}else MODx.insertAtCursor(ddTargetEl,v,cfg.onInsert);if(cfg.panel){var p=Ext.getCmp(cfg.panel);p&&p.markDirty()}}return!0}}),this.targetEl.addToGroup("modx-treedrop-elements-dd"),this.targetEl.addToGroup("modx-treedrop-sources-dd")}}),Ext.reg("modx-treedrop",MODx.TreeDrop),MODx.loadInsertElement=function(r){MODx.InsertElementWindow&&(MODx.InsertElementWindow.hide(),MODx.InsertElementWindow.destroy()),MODx.InsertElementWindow=MODx.load({xtype:"modx-window-insert-element",record:r,listeners:{success:{fn:function(){},scope:this},hide:{fn:function(){this.destroy()}}}}),MODx.InsertElementWindow.setValues(r),MODx.InsertElementWindow.show()},MODx.insertAtCursor=function(myField,myValue,h){if(!Ext.isEmpty(h)){var z=h(myValue);void 0!=z&&(myValue=z)}if(myField.blur(),document.selection)sel=document.selection.createRange(),sel.text=myValue;else if(myField.selectionStart||"0"==myField.selectionStart){var startPos=myField.selectionStart,endPos=myField.selectionEnd;myField.value=myField.value.substring(0,startPos)+myValue+myField.value.substring(endPos,myField.value.length),myField.selectionStart=startPos+myValue.length,myField.selectionEnd=myField.selectionStart}else myField.value+=myValue;myField.focus()},MODx.insertForRTE=function(v,cfg){var fn=cfg.onInsert||!1;if(fn)fn(v,cfg);else{if("object"==typeof cfg.iframeEl)var doc=cfg.iframeEl;else var doc=window.frames[0].document.getElementById(cfg.iframeEl);doc.value?doc.value=doc.value+v:doc.innerHTML=doc.innerHTML+v}},MODx.insertIntoContent=function(v,opt){opt.iframe?MODx.insertForRTE(v,opt.cfg):MODx.insertAtCursor(opt.ddTargetEl,v)},MODx.window.InsertElement=function(config){config=config||{},Ext.applyIf(config,{title:_("select_el_opts"),id:"modx-window-insert-element",width:522,labelAlign:"left",labelWidth:160,url:MODx.config.connector_url,action:"element/template/create",fields:[{xtype:"hidden",name:"pk",id:"modx-dise-pk"},{xtype:"hidden",name:"classKey",id:"modx-dise-classkey"},{xtype:"xcheckbox",fieldLabel:_("cached"),name:"cached",id:"modx-dise-cached",inputValue:1,checked:!0},{xtype:"modx-combo-property-set",fieldLabel:_("property_set"),name:"propertyset",id:"modx-dise-propset",width:300,baseParams:{action:"element/propertyset/getList",showAssociated:!0,elementId:config.record.pk,elementType:config.record.classKey},listeners:{render:{fn:function(){Ext.getCmp("modx-dise-propset").getStore().load(),Ext.getCmp("modx-dise-propset").value="0"},scope:this},select:{fn:this.changePropertySet,scope:this}}},{id:"modx-dise-proplist",autoLoad:{url:MODx.config.connector_url,params:{action:"element/getinsertproperties",classKey:config.record.classKey,pk:config.record.pk,resourceId:Ext.get("modx-resource-id").getValue(),propertySet:0},scripts:!0,callback:this.onPropFormLoad,scope:this},style:"display: none;"},{xtype:"fieldset",title:_("properties"),height:.6*Ext.getBody().getViewSize().height,collapsible:!0,autoScroll:!0,items:[{html:'<div id="modx-iprops-form"></div>',id:"modx-iprops-container"}]}]}),MODx.window.InsertElement.superclass.constructor.call(this,config),this.on("show",function(){this.center(),this.mask=new Ext.LoadMask(Ext.get("modx-iprops-container"),{msg:_("loading")}),this.mask.show()},this)},Ext.extend(MODx.window.InsertElement,MODx.Window,{changePropertySet:function(cb){var fp=Ext.getCmp("modx-iprops-fp");fp&&fp.destroy();var u=Ext.getCmp("modx-dise-proplist").getUpdater();u.update({url:MODx.config.connector_url,params:{action:"element/getinsertproperties",classKey:this.config.record.classKey,pk:this.config.record.pk,resourceId:Ext.get("modx-resource-id").getValue(),propertySet:cb.getValue()},scripts:!0,callback:this.onPropFormLoad,scope:this}),this.modps=[],this.mask.show()},createStore:function(data){return new Ext.data.SimpleStore({fields:["v","d"],data:data})},onPropFormLoad:function(el,s,r){this.mask.hide();var vs=Ext.decode(r.responseText);if(!vs||vs.length<=0)return!1;for(var i=0;i<vs.length;i++)vs[i].store&&(vs[i].store=this.createStore(vs[i].store));MODx.load({xtype:"panel",id:"modx-iprops-fp",layout:"form",autoHeight:!0,autoScroll:!0,labelWidth:150,border:!1,items:vs,renderTo:"modx-iprops-form"})},submit:function(){var v="[[",n=this.config.record.name,f=this.fp.getForm();switch(1!=f.findField("cached").getValue()&&(v+="!"),this.config.record.classKey){case"modSnippet":v+=n;break;case"modChunk":v=v+"$"+n;break;case"modTemplateVar":v=v+"*"+n}var ps=f.findField("propertyset").getValue();0!=ps&&""!==ps&&(v=v+"@"+f.findField("propertyset").getRawValue()),v+="?";for(var i=0;i<this.modps.length;i++){var fld=this.modps[i],val="function"==typeof Ext.getCmp("modx-iprop-"+fld).getValue?Ext.getCmp("modx-iprop-"+fld).getValue():Ext.getCmp("modx-iprop-"+fld).value;1==val&&(val=1),0==val&&(val=0),v=v+"\n	&"+fld+"=`"+val+"`"}return v+="\n]]",this.config.record.iframe?MODx.insertForRTE(v,this.config.record.cfg):MODx.insertAtCursor(this.config.record.ddTargetEl,v),this.hide(),!0},modps:[],changeProp:function(k){-1==this.modps.indexOf(k)&&this.modps.push(k)}}),Ext.reg("modx-window-insert-element",MODx.window.InsertElement);